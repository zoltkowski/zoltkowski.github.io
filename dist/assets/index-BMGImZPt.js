(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(o){if(o.ep)return;o.ep=!0;const l=n(o);fetch(o.href,l)}})();const Jl=Math.sin(5*Math.PI/180),Pc=.25,_r=.9,un=_r,_c=1,Tc=28,Cc=1,Rc=6,Ql=.5,qs=4,Ac=.65,Dc=200,zc=4,ys=12,Te=()=>X.fontSize||ys,hs=4,Tr=100,gs=1,Cr=12,Rr=8,Ar=4;function Gs(e){return e>=_r?1:e<=0?0:Math.min(1,e*e*Pc)}const Dr=()=>({points:[],lines:[],circles:[],angles:[],polygons:[],inkStrokes:[],labels:[],idCounters:{point:0,line:0,circle:0,angle:0,polygon:0},indexById:{point:{},line:{},circle:{},angle:{},polygon:{}}}),zr={point:"pt",line:"ln",circle:"c",angle:"ang",polygon:"poly"},Nc={point:"P",line:"L",circle:"O",angle:"âˆ ",polygon:"W"},Go=(e,t)=>{const n=s.points[e],i=s.points[t],o=n?.id??`p${e}`,l=i?.id??`p${t}`;return o<l?`${o}-${l}`:`${l}-${o}`};function Je(e,t=s){return t.idCounters[e]+=1,`${zr[e]}${t.idCounters[e]}`}function Ee(e,t,n,i){e.indexById[t][n]=i}function jt(e=s){e.indexById={point:{},line:{},circle:{},angle:{},polygon:{}},e.points.forEach((t,n)=>Ee(e,"point",t.id,n)),e.lines.forEach((t,n)=>Ee(e,"line",t.id,n)),e.circles.forEach((t,n)=>Ee(e,"circle",t.id,n)),e.angles.forEach((t,n)=>Ee(e,"angle",t.id,n)),e.polygons.forEach((t,n)=>Ee(e,"polygon",t.id,n))}const Nr=e=>{const t=[];return e?.forEach(n=>{n&&(n.kind!=="line"&&n.kind!=="circle"||typeof n.id!="string"||!n.id.length||t.some(i=>i.kind===n.kind&&i.id===n.id)||t.push({kind:n.kind,id:n.id}))}),t},Ci=(e,t)=>t||(e.length>=2?"intersection":e.length===1?"on_object":"free"),Vo=e=>!!e&&e.construction_kind==="midpoint"&&!!e.midpoint,so=e=>!!e&&e.construction_kind==="symmetric"&&!!e.symmetric,gn=e=>{if(!e||e.construction_kind==="intersection"||e.construction_kind==="midpoint"||e.construction_kind==="symmetric")return!1;const t=s.points.indexOf(e);return!(t>=0&&s.circles.some(i=>Lt(i)&&i.center===t))},Gt=(e,t)=>{const n=s.lines[t];return!!n&&n.defining_points.includes(e)},Ei=e=>!!e&&e.construction_kind==="parallel"&&!!e.parallel,lo=e=>!!e&&e.construction_kind==="perpendicular"&&!!e.perpendicular,Vs=e=>!e||e.construction_kind!=="parallel"&&e.construction_kind!=="perpendicular",ae=(e,t)=>{const{style:n,construction_kind:i,defining_parents:o,id:l,...r}=t,a=n??{color:"#ffffff",size:4},c=Nr(o),u=l??Je("point",e),f={object_type:"point",id:u,...r,style:a,defining_parents:c.map(p=>p.id),parent_refs:c,incident_objects:new Set,children:[],construction_kind:Ci(c,i),recompute:()=>{},on_parent_deleted:()=>{}};return e.points.push(f),Ee(e,"point",u,e.points.length-1),e.points.length-1},Ze=(e,t,n,i)=>{const o=Je("line",e),l={object_type:"line",id:o,points:[t,n],defining_points:[t,n],segmentStyles:[i],segmentKeys:[Go(t,n)],style:i,leftRay:{...i,hidden:!0},rightRay:{...i,hidden:!0},construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}};return e.lines.push(l),Ee(e,"line",o,e.lines.length-1),e.lines.length-1},Lt=e=>e.circle_kind==="three-point",Oc=e=>Lt(e)?e.defining_points:[],tl=e=>{const t=[],n=new Set,i=o=>{o!==e.center&&(n.has(o)||(n.add(o),t.push(o)))};return i(e.radius_point),e.points.forEach(i),Oc(e).forEach(i),t},lt=e=>{const t=s.points[e.center],n=s.points[e.radius_point];return!t||!n?0:Math.hypot(n.x-t.x,n.y-t.y)},Uo=(e,t)=>Lt(e)&&e.defining_points.includes(t),Qe=window.devicePixelRatio||1,Fc=16,Or=16,er=["#15a3ff","#ff4d4f","#22c55e","#f59e0b","#a855f7","#0ea5e9"],Us=["#000000","#404040","#808080","#bfbfbf"],yo={dark:{palette:er,defaultStroke:er[0],highlight:"#fbbf24",preview:"#22c55e",pointSize:2,lineWidth:2,angleStrokeWidth:2,angleDefaultRadius:28,midpointColor:"#9ca3af",bg:"#111827",fontSize:12,highlightWidth:1.5,panel:"#111827ef",panelBorder:"#1f2937"},light:{palette:Us,defaultStroke:Us[0],highlight:"#555555",preview:Us[0],pointSize:2,lineWidth:2,angleStrokeWidth:2,angleDefaultRadius:28,midpointColor:"#737373",bg:"#ffffff",fontSize:12,highlightWidth:1.5,panel:"transparent",panelBorder:"transparent"}},X={...yo.dark};let Ft="dark";const Fr="geometry.theme",Hc=e=>e==="dark"||e==="light"?e:e==="default"?"dark":e==="eink"?"light":null;if(typeof window<"u")try{const e=Hc(window.localStorage?.getItem(Fr));e&&(Ft=e)}catch{}const Me={color:X.highlight,width:1.5,dash:[4,4]},$c=18,Qt={x:12,y:12},ho=56,Ct={dark:{},light:{}},Hr="geometry.themeOverrides";function jc(){try{const e=localStorage.getItem(Hr);if(e){const t=JSON.parse(e);t.dark&&(Ct.dark=t.dark),t.light&&(Ct.light=t.light)}}catch{}}function nl(){try{localStorage.setItem(Hr,JSON.stringify(Ct))}catch{}}typeof window<"u"&&jc();function ms(e){const t=yo[e],n=Ct[e];if(Object.assign(X,t,n),typeof document<"u")try{const i=document.documentElement,o=document.body,l=X.panel??t.panel,r=X.panelBorder??t.panelBorder;i.style.setProperty("--panel",l),i.style.setProperty("--panel-border",r),o&&(o.style.setProperty("--panel",l),o.style.setProperty("--panel-border",r))}catch{}}let ce=null,g=null,s=Dr();const Ge=(e,t,n)=>Math.min(Math.max(e,t),n),$r=e=>Ge(e,hs,Tr),Rt=e=>{if(!Number.isFinite(e??NaN))return ys;const t=Math.round(e),n=hs+Math.round((t-hs)/gs)*gs;return $r(n)},Wc=(e=[],t=[])=>Nr([...e??[],...t]);function Yo(e,t){const n=s.points[e];if(!n)return;const i=Wc(n.parent_refs,t),o=Vo(n)?"midpoint":so(n)?"symmetric":Ci(i);s.points[e]={...n,parent_refs:i,defining_parents:i.map(l=>l.id),construction_kind:o}}let M=null,_=null,H=null,G=null,j=null,re=null,z=null;const q=new Set,Z=new Set,bt=new Set,vt=new Set,ct=new Set,kt=new Set,Tt=new Set,At=new Set;let De=null,ze=null,V="move",Cn=null,ii=!1,oi=null,Jn=null,ot=null,go=null,Nt=[],pt=null,It=[],Ye=null,Bt=null,Rn=null,Et=null,at=null,Ri=9,Qn=[],jr=null,mo=null,kn=null,en=null,Lo=null,En=null,Io=null,Bo=null,Mo=null,Po=null,_o=null,To=null,Co=null,Ro=null,Ao=null,Wi=null,qi=null,An=null,Dn=null,Do=null,yn=null,tr=null,nr=null,Pn=null,ir=[],si=null,zo=null,Qi=!1,xs={x:0,y:0},Oe={x:0,y:0},bs={x:0,y:0},No=null,ne=1;const As=.2,Ds=4,In=new Map,qc=3;let Wr=qc;const Gc=.6,Vc=.6;let sn=null,dt=null,Vt=null,uo=null,ht=!1,Fn=null,Ai=null,ei=null,je=[],il=0,Oo=null,de=null,cn=0,wn=0,ol=!1,_e={x:0,y:0},di=null,$e=null,et=null,ui=null,Re=!1,We=!0,vs=null,Hn=null,Gi=null,sl=null,ll=null,rl=null,or=null,Se=null,Mn=null,sr=null,cl=null,li=!1,ft=null,yt=null,qr=null,Vi=!1,Ui=!1,ks=null,Es=null,_n=null,Ce=!1,Ae=null,Ut=null,ws=null,Di=!1,oe=!1,wt=!1,xo=null,bo=null,Yi=!1,Mi=null,vo=null,ti=null,lr=null,rr=null,cr=null,ar=null,dr=null,fn=null,ko=null,al=null,dl=null,ul=null,ln=null,pn=null,fi=!1,Dt=null,nn=!1,Gr=null,Vr=null,fl=null,pl=null,Ur=null,Yr=null,yl=null,hl=null,gl=null,fe=null,le=null,zi=null,Ni=null,ml=null,he=null,gt=null,ri=[],xn=null,on=null,Yt=null,Xt=null,xl=[],Ss=null,bl=[],os=[],Oi=null,Ls=null,Eo=null,ss=!1,vl=null,kl=null,Ot=null,El=null,Xi=!1,wo=!1;const wl=["Î±","Î²","Î³","Î´","Îµ","Î¶","Î·","Î¸","Î»","Î¼","Î¾","Ï€","Ïƒ","Ï„","Ï†","Ï‡","Ïˆ","Î“","Î˜","Î ","Î£","Î¦","Î¨","Î©"],Uc=["âŸ‚","âˆ¥","âˆ¦","âˆˆ","âˆ©","âˆª","â–³","âˆ¼","âˆ¢","â‡","â‡’","â‡”","Â°"],Yc=["ð’œ","â„¬","ð’ž","ð’Ÿ","â„°","â„±","ð’¢","â„‹","â„","ð’¥","ð’¦","â„’","â„³","ð’©","ð’ª","ð’«","ð’¬","â„›","ð’®","ð’¯","ð’°","ð’±","ð’²","ð’³","ð’´","ð’µ"],Sl=["ð’¶","ð’·","ð’¸","ð’¹","ð’º","ð’»","ð’¼","ð’½","ð’¾","ð’¿","ð“€","ð“","ð“‚","ð“ƒ","ð‘œ","ð“…","ð“†","ð“‡","ð“ˆ","ð“‰","ð“Š","ð“‹","ð“Œ","ð“","ð“Ž","ð“"];let Fi=null,mt=null,ur=null,Hi=null,fo=null;const Xc="GeometryAppDB",Kc=1,eo="settings";async function Xr(){return new Promise((e,t)=>{const n=indexedDB.open(Xc,Kc);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result),n.onupgradeneeded=i=>{const o=i.target.result;o.objectStoreNames.contains(eo)||o.createObjectStore(eo)}})}async function ls(e){try{const n=(await Xr()).transaction(eo,"readwrite"),i=n.objectStore(eo);return e?(i.put(e,"defaultFolderHandle"),localStorage.setItem("defaultFolderName",e.name)):(i.delete("defaultFolderHandle"),localStorage.removeItem("defaultFolderName")),new Promise((o,l)=>{n.oncomplete=()=>o(),n.onerror=()=>l(n.error)})}catch(t){console.error("Failed to save folder handle to IndexedDB:",t)}}async function Zc(){try{const i=(await Xr()).transaction(eo,"readonly").objectStore(eo).get("defaultFolderHandle");return new Promise((o,l)=>{i.onsuccess=()=>{const r=i.result;o(r||null)},i.onerror=()=>l(i.error)})}catch(e){return console.error("Failed to load folder handle from IndexedDB:",e),null}}async function Kr(e){try{return await e.queryPermission({mode:"readwrite"})==="granted"?!0:await e.requestPermission({mode:"readwrite"})==="granted"}catch(t){return console.error("Failed to check/request folder permission:",t),!1}}let $i=null,Ll=null,tn=[X.defaultStroke],Bn=0,xi=0,bi=0,qn=[],Gn=[],Vn=[];typeof document<"u"&&mc(Ft);let Kt=null,Tn=null,ci=null,Yn=null,Xn=null,Kn=null,Pi=null,Pe,bn=null,mn=[],Ht=null;const $n={moveSelect:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3 9.5 5.5 12 8l2.5-2.5L12 3Zm0 13-2.5 2.5L12 21l2.5-2.5L12 16Zm-9-4 2.5 2.5L8 12 5.5 9.5 3 12Zm13 0 2.5 2.5L21 12l-2.5-2.5L16 12ZM8 12l8 0" /></svg>',viewVertices:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="8" cy="12" r="3.8" fill="none" stroke="currentColor"/><circle cx="8" cy="12" r="1.6" class="icon-fill"/><circle cx="16" cy="12" r="3.8" fill="none" stroke="currentColor"/><circle cx="16" cy="12" r="1.6" class="icon-fill"/></svg>',viewEdges:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="6" cy="12" r="3.2" fill="none" stroke="currentColor"/><circle cx="6" cy="12" r="1.5" class="icon-fill"/><circle cx="18" cy="12" r="3.2" fill="none" stroke="currentColor"/><circle cx="18" cy="12" r="1.5" class="icon-fill"/><line x1="6" y1="12" x2="18" y2="12" stroke-linecap="round" stroke-width="2"/></svg>',tick1:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12" stroke-linecap="round" stroke-width="1.8"/><line x1="12" y1="8" x2="12" y2="16" stroke-linecap="round" stroke-width="1.8"/></svg>',tick2:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12" stroke-linecap="round" stroke-width="1.8"/><line x1="10" y1="8" x2="10" y2="16" stroke-linecap="round" stroke-width="1.8"/><line x1="14" y1="8" x2="14" y2="16" stroke-linecap="round" stroke-width="1.8"/></svg>',tick3:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12" stroke-linecap="round" stroke-width="1.8"/><line x1="9" y1="7.5" x2="9" y2="16.5" stroke-linecap="round" stroke-width="1.8"/><line x1="12" y1="7.5" x2="12" y2="16.5" stroke-linecap="round" stroke-width="1.8"/><line x1="15" y1="7.5" x2="15" y2="16.5" stroke-linecap="round" stroke-width="1.8"/></svg>',eye:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12s4-6 9-6 9 6 9 6-4 6-9 6-9-6-9-6Z"/><circle cx="12" cy="12" r="3"/></svg>',eyeOff:'<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12s4-6 9-6 9 6 9 6-4 6-9 6-9-6-9-6Z"/><circle cx="12" cy="12" r="3"/><path d="M4 4 20 20"/></svg>'},Zr=1;function Jr(e){const t=Ic(e);if(!t.length)return null;const n=t.reduce((i,o)=>{const l=s.points[o];return l?{x:i.x+l.x,y:i.y+l.y}:i},{x:0,y:0});return{x:n.x/t.length,y:n.y/t.length}}let zn=[],Wt=-1,Ke=!1,Ki=!1;const Ys=new Set,Xs=new Set;function ue(){return{color:X.defaultStroke,size:X.pointSize}}function Ks(){return{color:X.midpointColor,size:X.pointSize}}function Jc(){return{color:X.defaultStroke,size:X.pointSize}}function ut(){return{color:X.defaultStroke,width:X.lineWidth,type:"solid",tick:0}}function Zs(){return{...{color:X.defaultStroke,width:X.angleStrokeWidth,type:"solid"},fill:void 0,arcCount:1,right:!1,arcRadiusOffset:0}}const Zi="ABCDEFGHIJKLMNOPQRSTUVWXYZ",fr="abcdefghijklmnopqrstuvwxyz",Zo=wl;function Fo(e,t){const n=t.length;let i=e,o="";do o=t[i%n]+o,i=Math.floor(i/n)-1;while(i>=0);return o}function pi(){if(qn.length){const n=qn.shift();return{text:Fo(n,Zi),seq:{kind:"upper",idx:n}}}const e=Bn,t=Fo(e,Zi);return Bn+=1,{text:t,seq:{kind:"upper",idx:e}}}function Is(){if(Gn.length){const n=Gn.shift();return{text:Fo(n,fr),seq:{kind:"lower",idx:n}}}const e=xi,t=Fo(e,fr);return xi+=1,{text:t,seq:{kind:"lower",idx:e}}}function Fl(){if(Vn.length){const n=Vn.shift();return{text:Zo[n%Zo.length],seq:{kind:"greek",idx:n}}}const e=bi,t=Zo[e%Zo.length];return bi+=1,{text:t,seq:{kind:"greek",idx:e}}}function rs(){_=null,M=null,H=null,G=null,j=null,re=null,z=null,q.clear(),Z.clear(),Pe=null,di=null,$e=null,Et=null,at=null,ot=null,go=null}function Il(){if(M!==null){const e=s.points[M];return e?{sourceType:"point",color:e.style.color,size:e.style.size}:null}if(_!==null){const e=s.lines[_];if(!e)return null;if(q.size>0){const t=Array.from(q)[0],n=ro(t);if(n&&n.line===_){let i;if(n.part==="segment"&&n.seg!==void 0?i=e.segmentStyles?.[n.seg]??e.style:n.part==="rayLeft"?i=e.leftRay??e.style:n.part==="rayRight"&&(i=e.rightRay??e.style),i)return{sourceType:"line",color:i.color,width:i.width,type:i.type,tick:i.tick}}}return{sourceType:"line",color:e.style.color,width:e.style.width,type:e.style.type,tick:e.style.tick}}if(H!==null){const e=s.circles[H];if(!e)return null;if(Z.size>0){const t=Array.from(Z)[0],n=Os(t);if(n&&n.circle===H){const i=e.arcStyles?.[n.arcIdx]??e.style;return{sourceType:"circle",color:i.color,width:i.width,type:i.type,tick:i.tick}}}return{sourceType:"circle",color:e.style.color,width:e.style.width,type:e.style.type,tick:e.style.tick}}if(G!==null){const e=s.angles[G];return e?{sourceType:"angle",color:e.style.color,width:e.style.width,type:e.style.type,arcCount:e.style.arcCount,right:e.style.right,fill:e.style.fill,arcRadiusOffset:e.style.arcRadiusOffset}:null}if(re!==null){const e=s.inkStrokes[re];return e?{sourceType:"ink",color:e.color,baseWidth:e.baseWidth}:null}return null}function co(e){let t=!1;if(M!==null&&e.color!==void 0&&e.size!==void 0){const n=s.points[M];n&&(n.style.color=e.color,n.style.size=e.size,t=!0)}if(_!==null&&e.color!==void 0&&e.width!==void 0&&e.type!==void 0){const n=s.lines[_];n&&(q.size>0?(zt(_),q.forEach(i=>{const o=ro(i);if(!(!o||o.line!==_)){if(o.part==="segment"&&o.seg!==void 0){n.segmentStyles||(n.segmentStyles=[]);const l=n.segmentStyles[o.seg]??n.style;n.segmentStyles[o.seg]={...l,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.segmentStyles[o.seg].tick=e.tick)}else if(o.part==="rayLeft"){const l=n.leftRay??n.style;n.leftRay={...l,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.leftRay.tick=e.tick)}else if(o.part==="rayRight"){const l=n.rightRay??n.style;n.rightRay={...l,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.rightRay.tick=e.tick)}}}),t=!0):(n.style.color=e.color,n.style.width=e.width,n.style.type=e.type,e.tick!==void 0&&(n.style.tick=e.tick),n.segmentStyles&&n.segmentStyles.length>0&&(n.segmentStyles=n.segmentStyles.map(i=>({...i,color:e.color,width:e.width,type:e.type,tick:e.tick!==void 0?e.tick:i.tick}))),n.leftRay&&(n.leftRay={...n.leftRay,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.leftRay.tick=e.tick)),n.rightRay&&(n.rightRay={...n.rightRay,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.rightRay.tick=e.tick)),t=!0))}if(H!==null&&e.color!==void 0&&e.width!==void 0&&e.type!==void 0){const n=s.circles[H];if(n)if(Z.size>0){const i=Sn(H);no(H,i.length),Z.forEach(o=>{const l=Os(o);if(!l||l.circle!==H)return;n.arcStyles||(n.arcStyles=[]);const r=n.arcStyles[l.arcIdx]??n.style;n.arcStyles[l.arcIdx]={...r,color:e.color,width:e.width,type:e.type},e.tick!==void 0&&(n.arcStyles[l.arcIdx].tick=e.tick)}),t=!0}else n.style.color=e.color,n.style.width=e.width,n.style.type=e.type,e.tick!==void 0&&(n.style.tick=e.tick),n.arcStyles&&n.arcStyles.length>0&&(n.arcStyles=n.arcStyles.map(i=>({...i,color:e.color,width:e.width,type:e.type,tick:e.tick!==void 0?e.tick:i.tick}))),t=!0}if(G!==null&&e.color!==void 0&&e.width!==void 0&&e.type!==void 0){const n=s.angles[G];n&&(n.style.color=e.color,n.style.width=e.width,n.style.type=e.type,e.arcCount!==void 0&&(n.style.arcCount=e.arcCount),e.right!==void 0&&(n.style.right=e.right),e.fill!==void 0&&(n.style.fill=e.fill),e.arcRadiusOffset!==void 0&&(n.style.arcRadiusOffset=e.arcRadiusOffset),t=!0)}if(re!==null&&e.color!==void 0&&e.baseWidth!==void 0){const n=s.inkStrokes[re];n&&(n.color=e.color,n.baseWidth=e.baseWidth,t=!0)}t&&(P(),J())}function be(e){if(!e?.seq)return;const{kind:t,idx:n}=e.seq,i=t==="upper"?qn:t==="lower"?Gn:Vn;i.includes(n)||(i.push(n),i.sort((o,l)=>o-l))}function Qr(){Bn=0,xi=0,bi=0,qn=[],Gn=[],Vn=[]}function ec(){bt.clear(),vt.clear(),ct.clear(),kt.clear(),Tt.clear(),At.clear(),De=null,ze=null}function Si(e,t){return e.x>=t.x1&&e.x<=t.x2&&e.y>=t.y1&&e.y<=t.y2}function Qc(e){s.points.forEach((t,n)=>{Si(t,e)&&bt.add(n)}),s.lines.forEach((t,n)=>{t.points.every(o=>{const l=s.points[o];return l&&Si(l,e)})&&vt.add(n)}),s.circles.forEach((t,n)=>{const i=s.points[t.center];i&&Si(i,e)&&ct.add(n)}),s.angles.forEach((t,n)=>{const i=s.points[t.vertex];i&&Si(i,e)&&kt.add(n)}),s.polygons.forEach((t,n)=>{ki(n).every(l=>{const r=s.points[l];return r&&Si(r,e)})&&Tt.add(n)}),s.inkStrokes.forEach((t,n)=>{t.points.every(o=>Si(o,e))&&At.add(n)})}function pr(e){if(!ce)return;Oo=e.id,de||(de=document.createElement("input"),de.type="text",de.style.position="absolute",de.style.zIndex="10000",de.style.padding="4px 8px",de.style.border="2px solid "+X.highlight,de.style.borderRadius="4px",de.style.background=X.bg,de.style.color=X.defaultStroke,de.style.fontSize=(e.fontSize??Te())+"px",de.style.fontFamily="sans-serif",de.style.textAlign="center",de.style.minWidth="60px",document.body.appendChild(de));const t=ce.getBoundingClientRect(),n=(e.pos.x*ne+Oe.x)*Qe/Qe+t.left,i=(e.pos.y*ne+Oe.y)*Qe/Qe+t.top;if(de.style.left=n+"px",de.style.top=i+"px",de.style.transform="translate(-50%, -50%)",e.kind==="segment"){const o=e.targetId.match(/^(.+)-seg(\d+)$/);if(o){const l=o[1],r=parseInt(o[2],10),a=s.lines.findIndex(c=>c.id===l);if(a!==-1){const c=zs(a,r);de.value=Fn?(c/Fn).toFixed(cn):""}}}de.focus(),de.select(),de.onkeydown=o=>{o.key==="Enter"?(o.preventDefault(),ea()):o.key==="Escape"&&(o.preventDefault(),to())},de.onblur=()=>{setTimeout(()=>{document.activeElement!==de&&to()},150)},de.onclick=o=>{o.stopPropagation()},de.onpointerdown=o=>{o.stopPropagation()}}function ea(){if(!de||!Oo)return;const e=je.find(n=>n.id===Oo);if(!e){to();return}const t=de.value.trim();if(e.kind==="segment"&&t!==""){const n=e.targetId.match(/^(.+)-seg(\d+)$/);if(n){const i=n[1],o=parseInt(n[2],10),l=s.lines.findIndex(r=>r.id===i);if(l!==-1){const r=parseFloat(t);!isNaN(r)&&r>0&&(Fn=zs(l,o)/r,Ai={lineIdx:l,segIdx:o},ei=r,Hl(),J())}}}to(),P()}function to(){de&&de.parentElement&&de.parentElement.removeChild(de),de=null,Oo=null}function Hl(){const e=new Map(je.map(t=>[t.targetId,t]));je=[],s.lines.forEach((t,n)=>{const i=t.points.map(o=>s.points[o]).filter(Boolean);for(let o=0;o<i.length-1;o++){const l=i[o],r=i[o+1];if(!l||!r||(t.segmentStyles?.[o]??t.style).hidden&&!oe)continue;const c=(l.x+r.x)/2,u=(l.y+r.y)/2,f=`${t.id}-seg${o}`,p=e.get(f);p?je.push({...p,pos:{x:c,y:u}}):je.push({id:`ml${++il}`,kind:"segment",targetId:f,pos:{x:c,y:u},pinned:!1,color:X.defaultStroke})}}),s.angles.forEach((t,n)=>{if(t.hidden&&!oe)return;const i=s.points[t.vertex];if(!i)return;const o=Un(t);if(!o)return;const{start:l,end:r,clockwise:a,radius:c}=o,u=a?l-(l-r+(l<r?Math.PI*2:0))/2:l+(r-l+(r<l?Math.PI*2:0))/2,f=c+Ne(15),p=i.x+Math.cos(u)*f,m=i.y+Math.sin(u)*f,x=e.get(t.id);x?je.push({...x,pos:{x:p,y:m}}):je.push({id:`ml${++il}`,kind:"angle",targetId:t.id,pos:{x:p,y:m},pinned:!1,color:X.defaultStroke})}),ta()}function ta(){const t=Ne(40),n=.3;for(let i=0;i<50;i++){const o=je.map(()=>({x:0,y:0}));for(let l=0;l<je.length;l++)for(let r=l+1;r<je.length;r++){const a=je[l],c=je[r],u=c.pos.x-a.pos.x,f=c.pos.y-a.pos.y,p=Math.hypot(u,f);if(p<t&&p>.1){const m=(t-p)/t*n,x=u/p*m,d=f/p*m;o[l].x-=x,o[l].y-=d,o[r].x+=x,o[r].y+=d}}je.forEach((l,r)=>{l.pinned||(l.pos.x+=o[r].x,l.pos.y+=o[r].y)})}}function zs(e,t){const n=s.lines[e];if(!n)return 0;const i=n.points.map(r=>s.points[r]),o=i[t],l=i[t+1];return!o||!l?0:Math.hypot(l.x-o.x,l.y-o.y)}function na(e){const t=s.angles[e];if(!t)return 0;const n=Un(t);if(!n)return 0;let{start:i,end:o,clockwise:l}=n,r=l?(i-o+Math.PI*2)%(Math.PI*2):(o-i+Math.PI*2)%(Math.PI*2);return t.style.exterior&&(r=Math.PI*2-r),r*(180/Math.PI)}function yr(e,t){return t==="angle"?`${e.toFixed(wn)}Â°`:Fn===null?"":(e/Fn).toFixed(cn)}function $l(e){if(e.kind==="segment"){const t=e.targetId.match(/^(.+)-seg(\d+)$/);if(!t)return"";const n=t[1],i=parseInt(t[2],10),o=s.lines.findIndex(a=>a.id===n);if(o===-1)return"";const l=zs(o,i);return yr(l,"segment")||"â€”"}else{const t=s.angles.findIndex(i=>i.id===e.targetId);if(t===-1)return"";const n=na(t);return yr(n,"angle")}}function yi(){return bt.size>0||vt.size>0||ct.size>0||kt.size>0||Tt.size>0||At.size>0}function P(){if(!(!ce||!g)){if(wt&&je.length>0&&Hl(),g.setTransform(1,0,0,1,0,0),g.fillStyle=X.bg,g.fillRect(0,0,ce.width,ce.height),g.setTransform(Qe*ne,0,0,Qe*ne,Oe.x*Qe,Oe.y*Qe),s.lines.forEach((e,t)=>{if(e.hidden&&!oe)return;const n=e.points.map(d=>s.points[d]).filter(Boolean);if(n.length<2)return;const i=j!==null&&s.polygons[j]?.lines.includes(t),o=_===t||i,l=Ei(e)||lo(e)?"#9ca3af":Me.color;for(let d=0;d<n.length-1;d++){const y=n[d],b=n[d+1],h=e.segmentStyles?.[d]??e.style;if(h.hidden&&!oe)continue;const v=Ln(t,"segment",d),k=q.size>0&&q.has(v),B=o&&We&&(q.size===0||k),E=!!h.hidden||e.hidden;g.save(),g.globalAlpha=E&&oe?.4:1,g.strokeStyle=h.color,g.lineWidth=Xe(h.width),Ii(h.type),g.beginPath(),g.moveTo(y.x,y.y),g.lineTo(b.x,b.y),g.stroke(),h.tick&&Da({x:y.x,y:y.y},{x:b.x,y:b.y},h.tick,g),B&&(g.strokeStyle=l,g.lineWidth=Xe(h.width+Me.width),g.setLineDash(Me.dash),g.beginPath(),g.moveTo(y.x,y.y),g.lineTo(b.x,b.y),g.stroke(),g.setLineDash([])),g.restore()}const r=n[0],a=n[n.length-1],c=a.x-r.x,u=a.y-r.y,f=Math.hypot(c,u)||1,p={x:c/f,y:u/f},m=(ce.width+ce.height)/Qe;if(e.leftRay&&!(e.leftRay.hidden&&!oe)){g.strokeStyle=e.leftRay.color,g.lineWidth=Xe(e.leftRay.width);const d=!!e.leftRay.hidden||e.hidden;g.save(),g.globalAlpha=d&&oe?.4:1,Ii(e.leftRay.type),g.beginPath(),g.moveTo(r.x,r.y),g.lineTo(r.x-p.x*m,r.y-p.y*m),g.stroke(),o&&We&&(q.size===0||q.has(Ln(t,"rayLeft")))&&(g.strokeStyle=l,g.lineWidth=Xe(e.leftRay.width+Me.width),g.setLineDash(Me.dash),g.beginPath(),g.moveTo(r.x,r.y),g.lineTo(r.x-p.x*m,r.y-p.y*m),g.stroke(),g.setLineDash([])),g.restore()}if(e.rightRay&&!(e.rightRay.hidden&&!oe)){g.strokeStyle=e.rightRay.color,g.lineWidth=Xe(e.rightRay.width);const d=!!e.rightRay.hidden||e.hidden;g.save(),g.globalAlpha=d&&oe?.4:1,Ii(e.rightRay.type),g.beginPath(),g.moveTo(a.x,a.y),g.lineTo(a.x+p.x*m,a.y+p.y*m),g.stroke(),o&&We&&(q.size===0||q.has(Ln(t,"rayRight")))&&(g.strokeStyle=l,g.lineWidth=Xe(e.rightRay.width+Me.width),g.setLineDash(Me.dash),g.beginPath(),g.moveTo(a.x,a.y),g.lineTo(a.x+p.x*m,a.y+p.y*m),g.stroke(),g.setLineDash([])),g.restore()}const x=_===t?Lc(t):null;if(x){g.save(),g.fillStyle=X.preview;const d=Or;g.translate(x.x,x.y),g.scale(1/ne,1/ne),g.fillRect(-d/2,-d/2,d,d),g.restore()}if(e.label&&!e.label.hidden){const d=oo(t);if(d){e.label.offset||(e.label.offset=vi(t));const y=e.label.offset??{x:0,y:-10},b=z?.kind==="line"&&z.id===t;ns(e.label,d.center,b,y)}}if(Ht&&Ht.lineIdx===t){const d=oo(t);if(d){const y=Math.max(0,Math.min(1,Ht.strength)),b=11,v=Ne(b*2+4),k=Ht.axis==="horizontal"?{x:0,y:-v}:{x:-v,y:0},B={x:d.center.x+k.x,y:d.center.y+k.y};g.save(),g.translate(B.x,B.y),g.scale(1/ne,1/ne),g.textAlign="center",g.textBaseline="middle",g.globalAlpha=.25+y*.35,g.fillStyle=X.preview,g.beginPath(),g.arc(0,0,b,0,Math.PI*2),g.fill(),g.globalAlpha=Math.min(.6+y*.4,.95),g.strokeStyle=X.preview,g.lineWidth=Xe(1.4),g.beginPath(),g.arc(0,0,b,0,Math.PI*2),g.stroke(),g.globalAlpha=1,g.font="11px sans-serif",g.fillStyle="#0f172a";const E=Ht.axis==="horizontal"?"H":"V";g.fillText(E,0,0),g.restore()}}}),s.circles.forEach((e,t)=>{if(e.hidden&&!oe)return;const n=s.points[e.center];if(!n)return;const i=lt(e);if(i<=.001)return;const o=e.style,l=H===t&&We;g.save(),g.globalAlpha=e.hidden&&oe?.4:1,g.strokeStyle=o.color,g.lineWidth=Xe(o.width),Ii(o.type),g.beginPath(),g.arc(n.x,n.y,i,0,Math.PI*2),g.stroke(),o.tick&&za(n,i,o.tick,g),l&&(g.strokeStyle=Me.color,g.lineWidth=Xe(o.width+Me.width),g.setLineDash(Me.dash),g.beginPath(),g.arc(n.x,n.y,i,0,Math.PI*2),g.stroke(),g.setLineDash([])),g.restore()}),s.circles.forEach((e,t)=>{if(e.hidden&&!oe)return;Sn(t).forEach((i,o)=>{if(i.hidden&&!oe)return;const l=i.center,r=i.style;g.save(),g.strokeStyle=r.color,g.lineWidth=Xe(r.width),Ii(r.type),g.beginPath(),g.arc(l.x,l.y,i.radius,i.start,i.end,i.clockwise),g.stroke();const a=e.style.tick??0,c=r.tick??a;c&&fc(l,i.radius,i.start,i.end,i.clockwise,c,g);const u=$o(t,o);H===t&&(Z.size===0||Z.has(u))&&(g.strokeStyle=Me.color,g.lineWidth=Xe(r.width+Me.width),g.setLineDash(Me.dash),g.beginPath(),g.arc(l.x,l.y,i.radius,i.start,i.end,i.clockwise),g.stroke(),g.setLineDash([])),g.restore()})}),s.angles.forEach((e,t)=>{if(e.hidden&&!oe)return;const n=e.leg1,i=e.leg2,o=s.lines[n.line],l=s.lines[i.line];if(!o||!l)return;const r=s.points[e.vertex],a=s.points[o.points[n.seg]],c=s.points[o.points[n.seg+1]],u=s.points[l.points[i.seg]],f=s.points[l.points[i.seg+1]];if(!r||!a||!c||!u||!f)return;e.vertex,o.points[n.seg],e.vertex,l.points[i.seg];const p=Un(e);if(!p)return;const{start:m,end:x,clockwise:d,radius:y,style:b}=p;g.save(),g.strokeStyle=b.color,g.lineWidth=Xe(b.width),Ii(b.type),b.fill&&(g.beginPath(),g.moveTo(r.x,r.y),g.arc(r.x,r.y,y,m,x,d),g.closePath(),g.fillStyle=b.fill,g.fill());const h=!!b.right,v=Math.max(1,b.arcCount??1),k=v===4,B=()=>{if(k)g.beginPath(),g.moveTo(r.x,r.y),g.arc(r.x,r.y,y,m,x,d),g.closePath(),g.fillStyle=b.color,g.fill();else for(let S=0;S<v;S++){const I=Math.max(2,y-S*6);g.beginPath(),g.arc(r.x,r.y,I,m,x,d),g.stroke()}},E=()=>{const S=e.vertex===o.points[n.seg]?c:a,I=e.vertex===l.points[i.seg]?f:u,L=Math.hypot(S.x-r.x,S.y-r.y),A=Math.hypot(I.x-r.x,I.y-r.y),R=Math.max(0,Math.min(L,A)-zc);if(R<=0)return;const T=qe({x:S.x-r.x,y:S.y-r.y}),C=qe({x:I.x-r.x,y:I.y-r.y});let D;if(R<qs)D=R;else{const Y=Math.max(0,y-qs)*Ac;D=qs+Y,D=Math.min(D,Dc,R)}const N={x:r.x+T.x*D,y:r.y+T.y*D},O={x:r.x+C.x*D,y:r.y+C.y*D},F={x:N.x+C.x*D,y:N.y+C.y*D};g.beginPath(),g.moveTo(r.x,r.y),g.lineTo(N.x,N.y),g.lineTo(F.x,F.y),g.lineTo(O.x,O.y),g.stroke()};if(h?E():B(),G===t&&(g.strokeStyle=Me.color,g.lineWidth=Xe(b.width+Me.width),g.setLineDash(Me.dash),h?E():k?(g.beginPath(),g.moveTo(r.x,r.y),g.arc(r.x,r.y,y,m,x,d),g.closePath(),g.stroke()):B(),g.setLineDash([])),e.label&&!e.label.hidden){e.label.offset||(e.label.offset=io(t));const S=e.label.offset??{x:0,y:0},I=z?.kind==="angle"&&z.id===t;ns(e.label,r,I,S)}g.restore()}),s.points.forEach((e,t)=>{if(e.style.hidden&&!oe)return;const n=!!e.style.hidden;g.save(),g.globalAlpha=n&&oe?.4:1,g.fillStyle=e.style.color;const i=pc(e.style.size);if(g.save(),g.translate(e.x,e.y),g.scale(1/ne,1/ne),g.beginPath(),g.arc(0,0,i,0,Math.PI*2),g.fill(),g.restore(),e.label&&!e.label.hidden){e.label.offset||(e.label.offset=St(t));const a=e.label.offset??{x:8,y:-8},c=z?.kind==="point"&&z.id===t;ns(e.label,{x:e.x,y:e.y},c,a)}const o=t===M||V==="circleThree"&&mn.includes(t),l=jr===t,r=e.construction_kind==="intersection"||e.construction_kind==="midpoint"||e.construction_kind==="symmetric"?"#9ca3af":e.construction_kind==="on_object"?"#ef4444":Me.color;(o||l||_!==null&&Re&&Ia(t,s.lines[_])||j!==null&&Re&&hd(t,s.polygons[j])||H!==null&&Re&&(Uo(s.circles[H],t)||s.circles[H].circle_kind==="center-radius"&&(s.circles[H].center===t||s.circles[H].radius_point===t)))&&(!e.style.hidden||oe)&&(g.save(),g.translate(e.x,e.y),g.scale(1/ne,1/ne),g.strokeStyle=r,g.lineWidth=X.highlightWidth??2,g.beginPath(),g.arc(0,0,i+4,0,Math.PI*2),g.stroke(),g.restore()),g.restore()}),s.labels.forEach((e,t)=>{if(e.hidden&&!oe)return;const n=z?.kind==="free"&&z.id===t;ns({text:e.text,color:e.color,fontSize:e.fontSize},e.pos,n)}),wt&&je.forEach(e=>{const t=$l(e);g.save(),g.translate(e.pos.x,e.pos.y),g.scale(1/ne,1/ne);const n=e.fontSize??Te();g.font=`${n}px sans-serif`,g.textAlign="center",g.textBaseline="middle";const i=t||"â€”",o=g.measureText(i),l=6,a=Math.max(o.width+l*2,30),c=n+l*2,u=t==="â€”"||t==="";e.pinned?g.fillStyle="#fbbf24":(u&&e.kind,g.fillStyle=X.bg),g.fillRect(-a/2,-c/2,a,c),g.strokeStyle=e.color??X.defaultStroke,g.lineWidth=1,u&&e.kind==="segment"&&g.setLineDash([3,3]),g.strokeRect(-a/2,-c/2,a,c),g.setLineDash([]),g.fillStyle=e.pinned?"#000000":e.color??X.defaultStroke,u&&e.kind==="segment"&&(g.globalAlpha=.4),g.fillText(i,0,0),g.restore()}),s.inkStrokes.forEach((e,t)=>{if(!(e.hidden&&!oe)){if(g.save(),e.hidden&&oe&&(g.globalAlpha=.4),Aa(e,g),t===re){const n=Pl(e);if(n){g.strokeStyle=Me.color,g.lineWidth=Xe(X.highlightWidth??2),g.setLineDash(Me.dash);const i=Ne(8);g.strokeRect(n.minX-i,n.minY-i,n.maxX-n.minX+i*2,n.maxY-n.minY+i*2),g.setLineDash([])}}g.restore()}}),V==="multiselect"&&De&&ze){g.save(),g.strokeStyle=X.highlight,g.lineWidth=Xe(X.highlightWidth??2),g.setLineDash([4,4]),g.fillStyle=X.highlight+"20";const e=Math.min(De.x,ze.x),t=Math.min(De.y,ze.y),n=Math.abs(ze.x-De.x),i=Math.abs(ze.y-De.y);g.fillRect(e,t,n,i),g.strokeRect(e,t,n,i),g.setLineDash([]),g.restore()}V==="multiselect"&&(g.save(),g.strokeStyle=X.highlight,g.lineWidth=Xe(X.highlightWidth??3),g.setLineDash([6,3]),bt.forEach(e=>{const t=s.points[e];t&&(g.beginPath(),g.arc(t.x,t.y,Ne(12),0,Math.PI*2),g.stroke())}),vt.forEach(e=>{const t=s.lines[e];t&&t.points.forEach((n,i)=>{if(i===0)return;const o=s.points[t.points[i-1]],l=s.points[n];!o||!l||(g.beginPath(),g.moveTo(o.x,o.y),g.lineTo(l.x,l.y),g.stroke())})}),ct.forEach(e=>{const t=s.circles[e];if(!t)return;const n=s.points[t.center];if(!n)return;const i=lt(t);g.beginPath(),g.arc(n.x,n.y,i,0,Math.PI*2),g.stroke()}),kt.forEach(e=>{const t=s.angles[e];if(!t)return;const n=Un(t);if(!n)return;const i=s.points[t.vertex];i&&(g.beginPath(),g.arc(i.x,i.y,n.radius,n.start,n.end,n.clockwise),g.stroke())}),At.forEach(e=>{const t=s.inkStrokes[e];if(!t)return;const n=Pl(t);if(!n)return;const i=Ne(8);g.beginPath(),g.rect(n.minX-i,n.minY-i,n.maxX-n.minX+i*2,n.maxY-n.minY+i*2),g.stroke()}),g.setLineDash([]),g.restore()),xd(),Ol()}}function hr(){if(!ce)return;const e=ce.getBoundingClientRect();ce.width=e.width*Qe,ce.height=e.height*Qe,P()}const ia=()=>typeof performance<"u"&&performance.now?performance.now():Date.now(),oa=()=>fe?.value??X.defaultStroke,sa=e=>{const t=Number(e.pressure);return!Number.isFinite(t)||t<=0?Gc:Ge(t,.05,1)};function tc(e){const t=Ps(e);return{x:t.x,y:t.y,pressure:sa(e),time:ia()}}function la(e){if(!ce)return;const t=tc(e),i={id:typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`ink-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,points:[t],color:oa(),baseWidth:Wr};s.inkStrokes.push(i),sn={pointerId:e.pointerId,stroke:i},rs(),$(),Ke=!0;try{ce.setPointerCapture(e.pointerId)}catch{}e.preventDefault(),P()}function ra(e){if(!sn||sn.pointerId!==e.pointerId)return;const{stroke:t}=sn,n=tc(e),i=t.points;if(i.length){const o=i[i.length-1],l=(n.x-o.x)*ne,r=(n.y-o.y)*ne;if(Math.hypot(l,r)<Vc){i[i.length-1]=n,e.preventDefault(),P();return}}i.push(n),Ke=!0,e.preventDefault(),P()}function ca(e){if(!sn||sn.pointerId!==e)return;const{stroke:t}=sn;if(t.points.length===1){const n=t.points[0];t.points[0]={...n,pressure:Math.max(n.pressure,.5),time:n.time}}try{ce?.releasePointerCapture(e)}catch{}sn=null}function Ie(e){if(V=e,Ce&&e!=="move"&&(Ce=!1),Object.entries(we.multiButtons).forEach(([t,n])=>{const i=Pt[t]||0;if(i!==0){const o=n[i],l=ge.find(a=>a.id===o);let r=!1;if(o==="copyStyleBtn"?r=e!=="move":l&&(r=e!==l.mode),r){Pt[t]=0;const a=document.getElementById(t);if(a){const c=n[0],u=ge.find(f=>f.id===c);if(u){const f=a.querySelector("svg");f&&(f.setAttribute("viewBox",u.viewBox),f.innerHTML=u.icon),a.setAttribute("title",u.label),a.setAttribute("aria-label",u.label)}}}}}),Ho&&Bs.length>0){const t=ge.find(n=>n.mode===V);t&&!Bs.includes(t.id)&&ic()}if(pa(),V!=="multiselect"&&ec(),V!=="move"&&V!=="label"&&(M=null,_=null,H=null,j=null,G=null,re=null,z=null,q.clear(),Z.clear()),Cn=null,ii=!1,V==="circle"&&(oi=null,ci=null,$()),V!=="parallel"&&V!=="perpendicular"&&V!=="circle"&&(Tn=null,Kt=null,oi=null,ci=null,mn=[],Jn=null,ot=null,Nt=[],Qn=[],pt=null,It=[],Ye=null,Bt=null,Rn=null),V!=="parallelLine"&&(Et=null,at=null),V!=="tangent"&&(Yn=null,Xn=null),V!=="perpBisector"&&(Kn=null,Pi=null),sn&&V!=="handwriting"&&(sn=null),nn&&V!=="handwriting"&&(nn=!1,Dt&&(Dt.classList.remove("active"),Dt.setAttribute("aria-pressed","false"))),V==="label"){const t=fe?.value||"#000";let n=!1;const i=o=>{if(o===null)return!1;const l=ki(o);return l.length>0&&l.every(r=>!!s.points[r]?.label)};if(G!==null){if(!s.angles[G].label){const{text:o,seq:l}=Fl();s.angles[G].label={text:o,color:t,offset:io(G),fontSize:Te(),seq:l},n=!0}}else if(j!==null||_!==null){const o=We||q.size>0,l=Re;if(j!==null){if(o&&q.size>0&&q.forEach(r=>{const a=ro(r);if(!a||a.part!=="segment")return;const c=a.line;if(s.lines[c]&&!s.lines[c].label){const{text:u,seq:f}=Is();s.lines[c].label={text:u,color:t,offset:vi(c),fontSize:Te(),seq:f},n=!0}}),(q.size===0||l)&&!i(j)){const r=ki(j);let a=null,c=1,u=-1,f=!1;for(let p=0;p<r.length;p++){const m=r[p],x=s.points[m]?.label?.text;if(x){const d=x.match(/^(.+?)_(\d+)$/);if(d){a=d[1],c=parseInt(d[2],10),u=p,f=!1;break}else if(x.length===1){const y=Zi.indexOf(x);if(y>=0){c=y,u=p,f=!0;break}}}}f&&u>=0?(r.forEach((p,m)=>{if(!s.points[p].label){const x=(m-u+r.length)%r.length,d=(c+x)%Zi.length,y=Zi[d];s.points[p].label={text:y,color:t,offset:St(p),fontSize:Te(),seq:void 0}}}),n=!0):a&&u>=0?(r.forEach((p,m)=>{if(!s.points[p].label){const x=(u-m+r.length)%r.length,d=(c-1+x)%r.length+1,y=`${a}_${d}`;s.points[p].label={text:y,color:t,offset:St(p),fontSize:Te(),seq:void 0}}}),n=!0):(r.forEach(p=>{const{text:m,seq:x}=pi();s.points[p].label={text:m,color:t,offset:St(p),fontSize:Te(),seq:x}}),n=r.length>0)}}else if(_!==null){if(o&&!s.lines[_].label){const{text:r,seq:a}=Is();s.lines[_].label={text:r,color:t,offset:vi(_),fontSize:Te(),seq:a},n=!0}if(l){const r=s.lines[_];r&&r.defining_points&&r.defining_points.forEach(a=>{if(!s.points[a].label){const{text:c,seq:u}=pi();s.points[a].label={text:c,color:t,offset:St(a),fontSize:Te(),seq:u},n=!0}})}}}else if(M!==null&&!s.points[M].label){const{text:o,seq:l}=pi();s.points[M].label={text:o,color:t,offset:St(M),fontSize:Te(),seq:l},n=!0}if(n){J(),V="move",st(),P();return}}st(),P()}function gr(){if(ot===null||go===null)return;const e=ot,t=go,n=s.points[e],i=s.points[t];if(!n||!i)return;const o={x:i.x-n.x,y:i.y-n.y},l=Math.hypot(o.x,o.y)||1;let r={x:-o.y/l,y:o.x/l};r.y>0&&(r={x:-r.x,y:-r.y});const a=l,c=a/(2*Math.sin(Math.PI/Ri)),u=a/(2*Math.tan(Math.PI/Ri)),f={x:(n.x+i.x)/2,y:(n.y+i.y)/2},p={x:f.x+r.x*u,y:f.y+r.y*u},m=Math.atan2(n.y-p.y,n.x-p.x),x=Math.atan2(i.y-p.y,i.x-p.x),d=2*Math.PI/Ri,y=(x-m+Math.PI*2)%(Math.PI*2),b=(m-x+Math.PI*2)%(Math.PI*2),v=Math.abs(y-d)<=Math.abs(b-d)?d:-d,k=m,B=[];for(let L=0;L<Ri;L++){const A=k+L*v;B.push({x:p.x+Math.cos(A)*c,y:p.y+Math.sin(A)*c})}const E=[];for(let L=0;L<B.length;L++){if(L===0){E.push(e);continue}if(L===1){E.push(t);continue}const A=B[L],R=ae(s,{...A,style:ue()});E.push(R)}const w=ut(),S=[];for(let L=0;L<E.length;L++){const A=E[L],R=E[(L+1)%E.length],T=Ze(s,A,R,w);S.push(T)}const I=Je("polygon",s);s.polygons.push({object_type:"polygon",id:I,lines:S,construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"polygon",I,s.polygons.length-1),ot=null,go=null,j=s.polygons.length-1,_=S[0],M=null,P(),J(),ye(),$()}function mr(e,t){for(let i=0;i<s.lines.length;i++){const o=s.lines[i];for(let l=0;l<o.points.length-1;l++){const r=o.points[l],a=o.points[l+1];if(r===e&&a===t||r===t&&a===e)return{line:i,seg:l}}}return{line:Ze(s,e,t,ut()),seg:0}}function aa(e){if(!ce)return;if(e.pointerType==="touch"){uc(e);try{ce.setPointerCapture(e.pointerId)}catch{}if(In.size>=2){dt||_l(),e.preventDefault();return}}if(V==="handwriting"){if(nn){const{x:i,y:o}=Ps(e),l=es({x:i,y:o});l!==null&&(s.inkStrokes.splice(l,1),J(),P());return}la(e);return}const{x:t,y:n}=Ps(e);if(bn=null,Vt=null,wt){const i=je.find(o=>{const l=o.pos.x-t,r=o.pos.y-n;return Math.hypot(l,r)<=Ne($c)});if(i&&i.kind==="segment"){const o=$l(i),l=o==="â€”"||o==="";if(l||i.pinned&&e.detail===2){e.preventDefault(),e.stopPropagation(),pr(i);return}if(!l){i.pinned=!i.pinned,i.pinned?i.color="#fbbf24":i.color=X.defaultStroke,P();return}}if(i&&i.kind==="angle"){if(e.detail===2){e.preventDefault(),e.stopPropagation(),pr(i);return}i.pinned=!i.pinned,i.pinned?i.color="#fbbf24":i.color=X.defaultStroke,P();return}}if(V==="move"){const i=_a({x:t,y:n});if(i){as(i);let o={x:0,y:0};switch(i.kind){case"point":{const l=s.points[i.id];l?.label&&(l.label.offset||(l.label.offset=St(i.id)),o=l.label.offset??{x:0,y:0});break}case"line":{const l=s.lines[i.id];l?.label&&(l.label.offset||(l.label.offset=vi(i.id)),o=l.label.offset??{x:0,y:0});break}case"angle":{const l=s.angles[i.id];l?.label&&(l.label.offset||(l.label.offset=io(i.id)),o=l.label.offset??{x:0,y:0});break}case"free":{const l=s.labels[i.id];l&&(o={x:l.pos.x,y:l.pos.y});break}}Pe={kind:i.kind,id:i.id,start:{x:t,y:n},initialOffset:{...o}},Ke=!1;return}else z&&as(null)}if(V==="move"){const i=bd({x:t,y:n});if(i!==null){if(!Vs(s.lines[i]))return;const o=oo(i);if(o){const l=j!==null&&q.size===0&&s.polygons[j]?.lines.includes(i)?s.polygons[j].lines:[i],r=new Set;l.forEach(p=>{s.lines[p]?.points.forEach(m=>r.add(m))});const a=Array.from(r).map(p=>({idx:p,p:s.points[p]})).filter(p=>p.p),c=a.length>0?{x:a.reduce((p,m)=>p+m.p.x,0)/a.length,y:a.reduce((p,m)=>p+m.p.y,0)/a.length}:o.center,u=[];let f=o.half;a.forEach(({idx:p,p:m})=>{const x=m.x-c.x,d=m.y-c.y;u.push({idx:p,vx:x,vy:d});const y=x*o.dir.x+d*o.dir.y;f=Math.max(f,Math.abs(y))}),di={lineIdx:i,center:c,dir:o.dir,vectors:u.length?u:o.order.map(p=>({idx:p.idx,vx:s.points[p.idx].x-o.center.x,vy:s.points[p.idx].y-o.center.y})),baseHalf:Math.max(1,f),lines:l},$(),P();return}}}if(V==="add"){H=null;const i=Ml({x:t,y:n}),o=Rl({x:t,y:n},He(),!1);let l={x:t,y:n};const r=i.map(p=>({hit:p,anchors:cd(p),line:s.lines[p.line]})).filter(p=>!!p.anchors&&!!p.line),a=o.map(p=>{const m=s.circles[p.circle],x=s.points[m?.center??-1];if(!m||!x)return null;const d=lt(m);return d<=.001?null:{center:{x:x.x,y:x.y},radius:d,idx:p.circle,id:m.id}}).filter(p=>!!p),c=[];for(let p=0;p<r.length;p++)for(let m=p+1;m<r.length;m++){const x=Yl(r[p].anchors.a,r[p].anchors.b,r[m].anchors.a,r[m].anchors.b),d=r[p].line,y=r[m].line;x&&d&&y&&c.push({pos:x,parents:[{kind:"line",id:d.id},{kind:"line",id:y.id}]})}for(const p of r)for(const m of a){const x=Sc(p.anchors.a,p.anchors.b,m.center,m.radius),d=p.line;x.forEach(y=>{d&&c.push({pos:y,parents:[{kind:"line",id:d.id},{kind:"circle",id:m.id}]})})}for(let p=0;p<a.length;p++)for(let m=p+1;m<a.length;m++)Ul(a[p].center,a[p].radius,a[m].center,a[m].radius).forEach(d=>c.push({pos:d,parents:[{kind:"circle",id:a[p].id},{kind:"circle",id:a[m].id}]}));let u=[];if(c.length)c.sort((p,m)=>Math.hypot(p.pos.x-t,p.pos.y-n)-Math.hypot(m.pos.x-t,m.pos.y-n)),l=c[0].pos,u=c[0].parents;else if(a.length===1){const p=a[0],m=qe({x:t-p.center.x,y:n-p.center.y});l={x:p.center.x+m.x*p.radius,y:p.center.y+m.y*p.radius},u=[{kind:"circle",id:p.id}]}else if(r.length===1){l=wi({x:t,y:n},r[0].anchors.a,r[0].anchors.b);const p=r[0].line;p&&(u=[{kind:"line",id:p.id}])}const f=ae(s,{...l,style:ue(),defining_parents:u});i.length&&(i.forEach(p=>dd(f,p,{x:t,y:n},l)),_=i[0].line),o.length&&o.forEach(p=>zl(p.circle,f,l)),M=f,i.length||(_=null),H=null,$(),P(),J(),et===null?Ie("move"):st()}else if(V==="segment"){const i=Ue({x:t,y:n}),o=Cn??M;if(H=null,G=null,o===null){const l=i??ae(s,{x:t,y:n,style:ue()});Cn=l,ii=i===null,M=l,_=null,P()}else{const l=s.points[o],r=i!==null,a=r?{x:t,y:n}:Li(l,{x:t,y:n}),c=i??ae(s,{...a,style:ue()}),u=s.points[c];if(l&&u&&l.x===u.x&&l.y===u.y){r?ii&&Wn([o]):(s.points.pop(),jt()),Cn=null,ii=!1,M=null,_=null,P(),$();return}const f=ut(),p=Ze(s,o,c,f);Cn=null,ii=!1,M=null,_=p,P(),ye(),$(),J()}}else if(V==="parallel"||V==="perpendicular"){let i=Ue({x:t,y:n});const o=Ml({x:t,y:n});let l=null;if(o.length&&(Kt!==null?l=o.find(r=>!s.lines[r.line]?.points.includes(Kt))??o[0]:l=o[0],!i&&l.part==="segment")){const r=s.lines[l.line],a=r.points[0],c=r.points[r.points.length-1],u=s.points[a],f=s.points[c],p=He();u&&Math.hypot(u.x-t,u.y-n)<=p?i=a:f&&Math.hypot(f.x-t,f.y-n)<=p&&(i=c)}if(i!==null?(Kt=i,M=i,H=null):Kt===null&&M!==null&&(Kt=M),l!==null?i!==null&&s.lines[l.line]?.points.includes(i)||(Tn=l.line,_=l.line,H=null):Tn===null&&_!==null&&(Tn=_),P(),Kt!==null&&Tn!==null){const r=Za(V,Kt,Tn);Tn=null,Kt=null,r!==null&&(_=r,M=null,P(),J(),ye(),$())}}else if(V==="symmetric"){const i=Rn,o=Ue({x:t,y:n}),l=qt({x:t,y:n});if(i===null){if(o===null)return;Rn=o,M=o,P();return}const r=s.points[i];if(!r){Rn=null,ye(),$();return}let a=null,c=null,u=[];if(o!==null){const p=s.points[o];if(!p)return;c={source:r.id,mirror:{kind:"point",id:p.id}},a={x:p.x*2-r.x,y:p.y*2-r.y}}else if(l&&l.part==="segment"){const p=s.lines[l.line];if(!p)return;c={source:r.id,mirror:{kind:"line",id:p.id}},u=[{kind:"line",id:p.id}],a=ql(r,p)}else return;if(!c||!a)return;const f=ae(s,{...a,style:Jc(),construction_kind:"symmetric",defining_parents:u,symmetric:c});Gl(f),M=f,Rn=null,P(),J(),ye(),$()}else if(V==="parallelLine"){const i=Ue({x:t,y:n}),o=qt({x:t,y:n}),l=a=>{Et=a,M=a,_=null,P()};if(Et===null){if(i!==null){l(i);return}if(o&&o.part==="segment"){at=o.line,_=o.line,P();return}const a=ae(s,{x:t,y:n,style:ue()});l(a);return}if(at===null){if(o&&o.part==="segment"){at=o.line,_=o.line;const a=_s(Et,at);Et=null,at=null,a!==null?(_=a,M=null,P(),J(),ye(),$()):P();return}i!==null&&l(i);return}const r=_s(Et,at);Et=null,at=null,r!==null?(_=r,M=null,P(),J(),ye(),$()):P()}else if(V==="tangent"){const i=Ue({x:t,y:n}),o=Rl({x:t,y:n},He(),!1),l=o.length>0?o[0]:null;i!==null?(Yn=i,M=i,Xn!==null?(Pr(Yn,Xn),Yn=null,Xn=null,P(),J(),ye(),$()):(H=null,P())):l!==null&&(Xn=l.circle,H=l.circle,Yn!==null?(Pr(Yn,Xn),Yn=null,Xn=null,P(),J(),ye(),$()):(M=null,P()))}else if(V==="perpBisector"){const i=Ue({x:t,y:n}),o=qt({x:t,y:n});i!==null?Kn===null?(Kn=i,M=i,_=null,P()):Pi===null&&i!==Kn&&(Pi=i,fd(Kn,Pi),Kn=null,Pi=null,P(),J(),ye(),$()):o&&o.part==="segment"&&(o.line,pd(o.line,o.seg),Kn=null,Pi=null,P(),J(),ye(),$())}else if(V==="circle"){const i=Ue({x:t,y:n}),o=oi??i??ae(s,{x:t,y:n,style:ue()});if(oi===null){oi=o,M=o,P();return}const l=ci??(i!==null&&i!==o?i:null)??ae(s,i===null?{...Li(s.points[o],{x:t,y:n}),style:ue()}:{x:t,y:n,style:ue()}),r=s.points[o],a=s.points[l],c=Math.hypot(r.x-a.x,r.y-a.y);if(c<=1e-6){i===null&&ci===null&&Wn([l]),ci=null,M=o,P(),$();return}H=xc(o,c,[l]),M=null,oi=null,ci=null,P(),J(),et===null?Ie("move"):ye(),$()}else if(V==="circleThree"){_=null,M=null,H=null,j=null,G=null,z=null,Z.clear(),q.clear(),$();const o=Ue({x:t,y:n})??ae(s,{x:t,y:n,style:ue()}),l=mn.length;if(mn.push(o),l===0?M=o:M=mn[0],_=null,H=null,mn.length===3){const r=Va(mn);r!==null&&(H=r,M=null,J(),ye()),mn=[]}P(),$()}else if(V==="triangleUp"){const i=Ue({x:t,y:n});if(Jn===null){const I=i??ae(s,{x:t,y:n,style:ue()});Jn=I,j=null,M=I,_=null,H=null,P();return}const o=s.points[Jn],l=i!==null?{x:t,y:n}:Li(o,{x:t,y:n}),r=i??ae(s,{...l,style:ue()}),a=Jn,c=r,u=s.points[a],f=s.points[c],p={x:f.x-u.x,y:f.y-u.y},m=Math.hypot(p.x,p.y)||1;let x={x:-p.y/m,y:p.x/m};x.y>0&&(x={x:-x.x,y:-x.y});const d=Math.sqrt(3)/2*m,y={x:(u.x+f.x)/2,y:(u.y+f.y)/2},b={x:y.x+x.x*d,y:y.y+x.y*d},h=ae(s,{...b,style:ue()}),v=ut(),k=Ze(s,a,c,v),B=Ze(s,c,h,v),E=Ze(s,h,a,v),w=[k,B,E],S=Je("polygon",s);s.polygons.push({object_type:"polygon",id:S,lines:w,construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"polygon",S,s.polygons.length-1),Jn=null,j=s.polygons.length-1,_=w[0],M=null,P(),J(),ye(),$()}else if(V==="square"){const i=Ue({x:t,y:n});if(ot===null){const L=i??ae(s,{x:t,y:n,style:ue()});ot=L,j=null,M=L,_=null,H=null,P();return}const o=s.points[ot],l=i!==null?{x:t,y:n}:Li(o,{x:t,y:n}),r=i??ae(s,{...l,style:ue()}),a=ot,c=r,u=s.points[a],f=s.points[c],p={x:f.x-u.x,y:f.y-u.y},m=Math.hypot(p.x,p.y)||1;let x={x:-p.y/m,y:p.x/m};x.y>0&&(x={x:-x.x,y:-x.y});const d={x:f.x+x.x*m,y:f.y+x.y*m},y={x:u.x+x.x*m,y:u.y+x.y*m},b=ae(s,{...d,style:ue()}),h=ae(s,{...y,style:ue()}),v=ut(),k=Ze(s,a,c,v),B=Ze(s,c,b,v),E=Ze(s,b,h,v),w=Ze(s,h,a,v),S=[k,B,E,w],I=Je("polygon",s);s.polygons.push({object_type:"polygon",id:I,lines:S,construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"polygon",I,s.polygons.length-1),ot=null,j=s.polygons.length-1,_=S[0],M=null,P(),J(),ye(),$()}else if(V==="polygon"){const i=Ue({x:t,y:n}),o=i===null,l=i??ae(s,Nt.length===1?{...Li(s.points[Nt[0]],{x:t,y:n}),style:ue()}:{x:t,y:n,style:ue()});if(!Nt.length){Qn=[],Nt.push(l),M=l,_=null,H=null,j=null,P();return}const r=Nt[0],a=Nt[Nt.length-1],c=s.points[a],u=s.points[l];if(c&&u&&Math.hypot(c.x-u.x,c.y-u.y)<=1e-6){o&&Wn([l]),M=a,P();return}const f=ut(),p=He();if(l===r||Math.hypot(s.points[r].x-s.points[l].x,s.points[r].y-s.points[l].y)<=p){const m=Ze(s,a,r,f);Qn.push(m);const x=Je("polygon",s),d={object_type:"polygon",id:x,lines:[...Qn],construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}};s.polygons.push(d),Ee(s,"polygon",x,s.polygons.length-1),j=s.polygons.length-1,_=d.lines[0],M=null,Nt=[],Qn=[],P(),J(),ye(),$()}else{const m=Ze(s,a,l,f);Qn.push(m),Nt.push(l),M=l,_=m,P(),$()}}else if(V==="angle"){const i=Ue({x:t,y:n});if(i!==null){if(pt&&(pt=null,q.clear()),(It.length===0||It[It.length-1]!==i)&&It.push(i),M=i,_=null,q.clear(),It.length===3){const[h,v,k]=It;if(h===k){It=[],M=null,P();return}const B=mr(h,v),E=mr(v,k),w=Je("angle",s);s.angles.push({object_type:"angle",id:w,leg1:B,leg2:E,vertex:v,style:Zs(),construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"angle",w,s.angles.length-1),G=s.angles.length-1,M=null,It=[],P(),J(),ye()}$(),P();return}const o=qt({x:t,y:n});if(!o||o.part!=="segment")return;It.length>0&&(It=[],M=null);const l=s.lines[o.line],r=l.points[o.seg],a=l.points[o.seg+1];if(r===void 0||a===void 0)return;if(!pt){pt={line:o.line,seg:o.seg,a:r,b:a},_=o.line,M=r,q.clear(),q.add(Ln(o.line,"segment",o.seg)),$(),P();return}const c=pt;if(c.line===o.line&&c.seg===o.seg){pt=null,q.clear(),_=null,P();return}const u=[r,a].find(h=>h===c.a||h===c.b);if(u===void 0){pt=null,q.clear(),_=null,P();return}const f=u,p=f===c.a?c.b:c.a,m=r===f?a:r,x=s.points[f],d=s.points[p],y=s.points[m];if(!x||!d||!y){pt=null;return}ut();const b=Je("angle",s);s.angles.push({object_type:"angle",id:b,leg1:{line:pt.line,seg:pt.seg},leg2:{line:o.line,seg:o.seg},vertex:f,style:Zs(),construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"angle",b,s.angles.length-1),G=s.angles.length-1,_=null,M=null,q.clear(),pt=null,P(),J(),ye(),$()}else if(V==="label"){const i=Ue({x:t,y:n}),o=qt({x:t,y:n}),l=Qo({x:t,y:n},He(1.5)),r=o?ps(o.line):j,a=fe?.value||"#000";let c=!1;const u=f=>{if(f===null)return!1;const p=ki(f);return p.length>0&&p.every(m=>!!s.points[m]?.label)};if(l!==null)if(s.angles[l].label)G=l;else{const{text:f,seq:p}=Fl();s.angles[l].label={text:f,color:a,offset:io(l),fontSize:Te(),seq:p},G=l,c=!0,ao(),Ie("move"),st()}else if(i!==null){if(M=i,!s.points[i].label){const{text:f,seq:p}=pi();s.points[i].label={text:f,color:a,offset:St(i),fontSize:Te(),seq:p},c=!0,ao(),Ie("move"),st()}}else if(r!==null){if(j=r,!u(r)){const f=ki(r);f.forEach((p,m)=>{const x=Bn+m,d=Fo(x,Zi);s.points[p].label={text:d,color:a,offset:St(p),fontSize:Te(),seq:{kind:"upper",idx:x}}}),Bn+=f.length,c=f.length>0,c&&(ao(),Ie("move"),st())}}else if(o&&o.part==="segment"){if(_=o.line,!s.lines[o.line].label){const{text:f,seq:p}=Is();s.lines[o.line].label={text:f,color:a,offset:vi(o.line),fontSize:Te(),seq:p},c=!0,ao(),Ie("move"),st()}}else{s.labels.push({text:"",pos:{x:t,y:n},color:a,fontSize:Te()});const p=s.labels.length-1;as({kind:"free",id:p}),setTimeout(()=>{kc(),gt&&gt.focus()},0),c=!0}c&&(P(),J(),ye(),$())}else if(V==="bisector"){const i=qt({x:t,y:n});if(!i||i.part!=="segment")return;const o=s.lines[i.line],l=o.points[i.seg],r=o.points[i.seg+1];if(l===void 0||r===void 0)return;if(!Ye){Ye={line:i.line,seg:i.seg,a:l,b:r,vertex:l},_=i.line,M=l,P();return}if(Ye.line===i.line&&Ye.seg===i.seg){Ye=null,_=null,P();return}const a=o.points[i.seg],c=o.points[i.seg+1];if(a===void 0||c===void 0){Ye=null;return}const u=[a,c].find(I=>I===Ye?.a||I===Ye?.b);if(u===void 0){Ye=null;return}const f=u,p=Ye.a===f?Ye.b:Ye.a,m=a===f?c:a,x=s.points[f],d=s.points[p],y=s.points[m];if(!x||!d||!y){Ye=null;return}const b=qe({x:d.x-x.x,y:d.y-x.y}),h=qe({x:y.x-x.x,y:y.y-x.y}),v=qe({x:b.x+h.x,y:b.y+h.y}),k=Math.min(Math.hypot(d.x-x.x,d.y-x.y),Math.hypot(y.x-x.x,y.y-x.y))||80,B={x:x.x+v.x*k,y:x.y+v.y*k},E=ae(s,{...B,style:ue()}),w=ut();Ze(s,f,E,w);const S=Je("angle",s);s.angles.push({object_type:"angle",id:S,leg1:{line:Ye.line,seg:Ye.seg},leg2:{line:i.line,seg:i.seg},vertex:f,style:Zs(),construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}}),Ee(s,"angle",S,s.angles.length-1),G=s.angles.length-1,M=null,Ye=null,P(),J(),ye(),$()}else if(V==="midpoint"){const i=Ue({x:t,y:n}),o=qt({x:t,y:n});if(i!==null){if(Bt===null){Bt=i,M=i,P();return}const p=i,m=s.points[Bt],x=s.points[p];if(!m||!x){Bt=null,ye(),$();return}const d={x:(m.x+x.x)/2,y:(m.y+x.y)/2},y=[m.id,x.id],b=ae(s,{...d,style:Ks(),defining_parents:[],construction_kind:"midpoint",midpoint:{parents:y,parentLineId:null}});us(b),M=b,P(),J(),Bt=null,ye(),$();return}if(o&&o.part==="segment"&&Bt===null){const p=s.lines[o.line],m=s.points[p.points[o.seg]],x=s.points[p.points[o.seg+1]];if(m&&x){const d={x:(m.x+x.x)/2,y:(m.y+x.y)/2},y=[m.id,x.id],b=p?.id??null,h=ae(s,{...d,style:Ks(),defining_parents:b?[{kind:"line",id:b}]:[],construction_kind:"midpoint",midpoint:{parents:y,parentLineId:b}});us(h),js(o.line,h,d),M=h,_=o.line,P(),J(),ye(),$();return}}if(Bt===null)return;const l=ae(s,{x:t,y:n,style:ue()}),r=s.points[Bt],a=s.points[l];if(!r||!a){Bt=null,ye(),$();return}const c={x:(r.x+a.x)/2,y:(r.y+a.y)/2},u=[r.id,a.id],f=ae(s,{...c,style:Ks(),construction_kind:"midpoint",midpoint:{parents:u,parentLineId:null}});us(f),M=f,Bt=null,P(),J(),ye(),$()}else if(V==="ngon"){const i=Ue({x:t,y:n});if(ot===null){const a=i??ae(s,{x:t,y:n,style:ue()});ot=a,j=null,M=a,_=null,H=null,P();return}const o=s.points[ot],l=i!==null?{x:t,y:n}:Li(o,{x:t,y:n}),r=i??ae(s,{...l,style:ue()});go=r,M=r,P(),yn&&(yn.style.display="flex",Pn&&Pn.focus())}else if(V==="multiselect"){const{x:i,y:o}=Xo(e.clientX,e.clientY);if(Di&&yi()){ol=!0,_e={x:i,y:o},P();return}if(De={x:i,y:o},ze={x:i,y:o},!Di){const l=Ue({x:i,y:o}),r=qt({x:i,y:o}),a=Js({x:i,y:o},He(),!1),c=Qo({x:i,y:o},He(1.5)),u=es({x:i,y:o}),f=r?ps(r.line):null;if(l!==null){bt.has(l)?bt.delete(l):bt.add(l),De=null,ze=null,P(),$();return}if(r!==null){const p=r.line;vt.has(p)?vt.delete(p):vt.add(p),De=null,ze=null,P(),$();return}if(a!==null){const p=a.circle;ct.has(p)?ct.delete(p):ct.add(p),De=null,ze=null,P(),$();return}if(c!==null){kt.has(c)?kt.delete(c):kt.add(c),De=null,ze=null,P(),$();return}if(f!==null){Tt.has(f)?Tt.delete(f):Tt.add(f),De=null,ze=null,P(),$();return}if(u!==null){At.has(u)?At.delete(u):At.add(u),De=null,ze=null,P(),$();return}}P()}else if(V==="move"){if(Ce&&Ae){const d=Ue({x:t,y:n}),y=qt({x:t,y:n}),b=Js({x:t,y:n},He(),!1),h=Qo({x:t,y:n},He(1.5)),v=es({x:t,y:n}),k=M,B=_,E=H,w=G,S=j,I=re,L=new Set(q),A=new Set(Z),R=We,T=Re;let C=!1;if(Ae.sourceType==="ink"&&v!==null?(re=v,M=null,_=null,H=null,G=null,j=null,q.clear(),Z.clear(),co(Ae),C=!0):Ae.sourceType==="angle"&&h!==null?(G=h,M=null,_=null,H=null,j=null,re=null,q.clear(),Z.clear(),co(Ae),C=!0):Ae.sourceType==="circle"&&b!==null?(H=b.circle,M=null,_=null,G=null,j=null,re=null,q.clear(),Z.clear(),co(Ae),C=!0):Ae.sourceType==="line"&&y!==null?(_=y.line,M=null,H=null,G=null,j=null,re=null,q.clear(),Z.clear(),We=!0,Re=!1,co(Ae),C=!0):Ae.sourceType==="point"&&d!==null&&(M=d,_=null,H=null,G=null,j=null,re=null,q.clear(),Z.clear(),co(Ae),C=!0),C){M=k,_=B,H=E,G=w,j=S,re=I,q.clear(),L.forEach(D=>q.add(D)),Z.clear(),A.forEach(D=>Z.add(D)),We=R,Re=T,$(),P();return}}const i=Ue({x:t,y:n}),o=qt({x:t,y:n});let l=Js({x:t,y:n},He(),!1),r=La({x:t,y:n},He(1.5));const a=Qo({x:t,y:n},He(1.5));let c=null,u=!1;if(i!==null){const d=s.points[i],y=gn(d),b=!y&&(d.construction_kind==="intersection"||Vo(d)||so(d));if(!y&&!b)if(l!==null)c=l.circle;else{const v=d.parent_refs.find(k=>k.kind==="circle");if(v){const k=s.indexById.circle[v.id];k!==void 0&&(c=k)}}u=c!==null;const h=!y&&!b&&o!==null&&Vs(s.lines[o.line]);if(!u&&!h){if(M=i,_=null,H=null,G=null,j=null,Z.clear(),q.clear(),y){const k=ni(i).filter(B=>s.circles[B]?.circle_kind==="center-radius");if(k.length){const B=new Map;k.forEach(E=>{const w=s.circles[E],S=d;if(!w||!S)return;const I=new Map;w.points.forEach(A=>{const R=s.points[A];R&&I.set(A,Math.atan2(R.y-S.y,R.x-S.x))});const L=s.points[w.radius_point];L&&I.set(w.radius_point,Math.atan2(L.y-S.y,L.x-S.x)),B.set(E,I)}),bn=B}}ht=y,_e={x:t,y:n};const v=$t(i);y&&v.length>0?$e=cc(i):$e=null,$(),P();return}u&&l===null&&c!==null&&(l={circle:c})}const f=l?.circle??null,m=r!==null&&f!==null&&r.circle===f&&(H===f||e.detail>=2);if(a!==null){G=a,_=null,M=null,H=null,j=null,Z.clear(),q.clear(),ht=!1,_e={x:t,y:n},$(),P();return}if(l!==null){const d=H,y=l.circle,b=s.circles[y];if(!b){$(),P();return}const h=b.center,v=s.points[h],k=gn(v);if(m&&r!==null){const S=$o(y,r.arcIdx);H=y,_=null,M=null,G=null,j=null,q.clear(),d===y?Z.has(S)?Z.delete(S):Z.add(S):(Z.clear(),Z.add(S)),ht=!1,$e=null,_e={x:t,y:n},$(),P();return}H=y,Z.clear(),_=null,M=null,G=null,j=null,q.clear();const B=new Map,E=S=>{if(S===void 0||S<0)return;const I=s.points[S];I&&B.set(S,{x:I.x,y:I.y})};E(h),E(b.radius_point),b.points.forEach(S=>E(S));const w=new Map;B.forEach((S,I)=>{$t(I).forEach(A=>{Gt(I,A)&&!w.has(A)&&w.set(A,vr(A))})}),Vt={circleIdx:y,originals:B,dependentLines:w},ht=k||B.size>0,_e={x:t,y:n},$e=null,bn=null,$(),P();return}if(m&&r!==null){const d=r.circle,y=$o(d,r.arcIdx);H===d?Z.has(y)?Z.delete(y):Z.add(y):(H=d,Z.clear(),Z.add(y)),_=null,M=null,G=null,j=null,q.clear(),ht=!1,$e=null,_e={x:t,y:n},$(),P();return}const x=es({x:t,y:n});if(x!==null){re=x,_=null,M=null,H=null,G=null,j=null,Z.clear(),q.clear(),ht=!0,_e={x:t,y:n},$(),P();return}if(o!==null){const d=s.lines[o.line],y=Vs(d),b=ps(o.line);if(b!==null){if(j===b){const k=el(o);q.size===0?q.add(k):q.has(k)?q.delete(k):q.add(k)}else j=b,q.clear();_=o.line,Z.clear(),G=null;const h=s.polygons[b],v=new Map;if(h){const k=new Set;h.lines.forEach(B=>{s.lines[B]?.points.forEach(w=>k.add(w))}),k.forEach(B=>{$t(B).forEach(w=>{!h.lines.includes(w)&&Gt(B,w)&&!v.has(w)&&v.set(w,vr(w))})})}uo={polygonIdx:b,dependentLines:v}}else{if(_===o.line)if(q.size===0)q.add(el(o));else{const h=el(o);q.has(h)?q.delete(h):q.add(h)}else _=o.line,q.clear();j=null,Z.clear(),G=null}M=null,H=null,Z.clear(),hi(_),ht=y,_e={x:t,y:n},$(),P();return}M=null,_=null,H=null,j=null,Z.clear(),G=null,re=null,q.clear(),$e=null,ao(),Ce&&(Ce=!1,Ae=null),No={x:t,y:n},Qi=!0,xs={x:e.clientX,y:e.clientY},bs={...Oe},$(),P()}}let we={multiButtons:{},secondRow:{}},Pt={},Ho=!1,Bl=null,Bs=[];const Jo=new Map,xr=300;let pe=null,Be=[];const ge=[{id:"modeMove",label:"Zaznaczanie",mode:"move",icon:'<path d="M12 3 9.5 5.5 12 8l2.5-2.5L12 3Zm0 13-2.5 2.5L12 21l2.5-2.5L12 16Zm-9-4 2.5 2.5L8 12 5.5 9.5 3 12Zm13 0 2.5 2.5L21 12l-2.5-2.5L16 12ZM8 12l8 0" />',viewBox:"0 0 24 24"},{id:"modeMultiselect",label:"Zaznacz wiele",mode:"multiselect",icon:'<rect x="3" y="3" width="8" height="8" rx="1" stroke-dasharray="2 2"/><rect x="13" y="3" width="8" height="8" rx="1" stroke-dasharray="2 2"/><rect x="3" y="13" width="8" height="8" rx="1" stroke-dasharray="2 2"/><rect x="13" y="13" width="8" height="8" rx="1" stroke-dasharray="2 2"/>',viewBox:"0 0 24 24"},{id:"modeLabel",label:"Etykieta",mode:"label",icon:'<path d="M5 7h9l5 5-5 5H5V7Z"/><path d="M8 11h4" /><path d="M8 14h3" />',viewBox:"0 0 24 24"},{id:"modeAdd",label:"Punkt",mode:"add",icon:'<circle cx="12" cy="12" r="4.5" class="icon-fill"/>',viewBox:"0 0 24 24"},{id:"modeSegment",label:"Odcinek",mode:"segment",icon:'<circle cx="6" cy="12" r="2.2" class="icon-fill"/><circle cx="18" cy="12" r="2.2" class="icon-fill"/><line x1="6" y1="12" x2="18" y2="12"/>',viewBox:"0 0 24 24"},{id:"modeParallel",label:"RÃ³wnolegÅ‚a",mode:"parallel",icon:'<line x1="5" y1="8" x2="19" y2="8"/><line x1="5" y1="16" x2="19" y2="16"/>',viewBox:"0 0 24 24"},{id:"modePerpendicular",label:"ProstopadÅ‚a",mode:"perpendicular",icon:'<line x1="5" y1="12" x2="19" y2="12"/><line x1="12" y1="5" x2="12" y2="19"/>',viewBox:"0 0 24 24"},{id:"modeCircle",label:"OkrÄ…g",mode:"circle",icon:'<circle cx="12" cy="12" r="8"/><line x1="12" y1="12" x2="18" y2="12"/><circle cx="18" cy="12" r="1.4" class="icon-fill"/>',viewBox:"0 0 24 24"},{id:"modeCircleThree",label:"OkrÄ…g przez 3 punkty",mode:"circleThree",icon:'<ellipse cx="12" cy="12" rx="8.5" ry="7.5" fill="none" stroke="currentColor" stroke-width="1.2"/><circle cx="8" cy="6.5" r="2.2" class="icon-fill" stroke="currentColor" stroke-width="0.8"/><circle cx="16.5" cy="6" r="2.2" class="icon-fill" stroke="currentColor" stroke-width="0.8"/><circle cx="17.5" cy="16" r="2.2" class="icon-fill" stroke="currentColor" stroke-width="0.8"/>',viewBox:"0 0 24 24"},{id:"modeTriangleUp",label:"TrÃ³jkÄ…t foremny",mode:"triangleUp",icon:'<path d="M4 18h16L12 5Z"/>',viewBox:"0 0 24 24"},{id:"modeSquare",label:"Kwadrat",mode:"square",icon:'<rect x="5" y="5" width="14" height="14"/>',viewBox:"0 0 24 24"},{id:"modeNgon",label:"N-kÄ…t",mode:"ngon",icon:'<polygon points="20,15.5 15.5,20 8.5,20 4,15.5 4,8.5 8.5,4 15.5,4 20,8.5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>',viewBox:"0 0 24 24"},{id:"modePolygon",label:"WielokÄ…t",mode:"polygon",icon:'<polygon points="5,4 19,7 16,19 5,15"/><circle cx="5" cy="4" r="1.2" class="icon-fill"/><circle cx="19" cy="7" r="1.2" class="icon-fill"/><circle cx="16" cy="19" r="1.2" class="icon-fill"/><circle cx="5" cy="15" r="1.2" class="icon-fill"/>',viewBox:"0 0 24 24"},{id:"modeAngle",label:"KÄ…t",mode:"angle",icon:'<line x1="14" y1="54" x2="50" y2="54" stroke="currentColor" stroke-width="4" stroke-linecap="round" /><line x1="14" y1="54" x2="42" y2="18" stroke="currentColor" stroke-width="4" stroke-linecap="round" /><path d="M20 46 A12 12 0 0 1 32 54" fill="none" stroke="currentColor" stroke-width="3" />',viewBox:"0 0 64 64"},{id:"modeBisector",label:"Dwusieczna",mode:"bisector",icon:'<line x1="6" y1="18" x2="20" y2="18" /><line x1="6" y1="18" x2="14" y2="6" /><line x1="6" y1="18" x2="20" y2="10" />',viewBox:"0 0 24 24"},{id:"modeMidpoint",label:"Punkt Å›rodkowy",mode:"midpoint",icon:'<circle cx="6" cy="12" r="1.5" class="icon-fill"/><circle cx="18" cy="12" r="1.5" class="icon-fill"/><circle cx="12" cy="12" r="2.5" class="icon-fill"/><circle cx="12" cy="12" r="1" fill="var(--bg)" stroke="none"/>',viewBox:"0 0 24 24"},{id:"modeSymmetric",label:"Symetria",mode:"symmetric",icon:'<line x1="12" y1="4" x2="12" y2="20" /><circle cx="7.5" cy="10" r="1.7" class="icon-fill"/><circle cx="16.5" cy="14" r="1.7" class="icon-fill"/><path d="M7.5 10 16.5 14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>',viewBox:"0 0 24 24"},{id:"modeTangent",label:"Styczna",mode:"tangent",icon:'<circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.2"/><line x1="2" y1="17" x2="22" y2="17" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" transform="rotate(-25 12 12)"/>',viewBox:"0 0 24 24"},{id:"modePerpBisector",label:"Symetralna",mode:"perpBisector",icon:'<circle cx="7" cy="12" r="2" class="icon-fill"/><circle cx="17" cy="12" r="2" class="icon-fill"/><circle cx="12" cy="12" r="2.5" class="icon-fill"/><circle cx="12" cy="12" r="1" fill="var(--bg)" stroke="none"/><line x1="12" y1="4" x2="12" y2="20" stroke="currentColor" stroke-width="1.5"/>',viewBox:"0 0 24 24"},{id:"modeHandwriting",label:"Pismo rÄ™czne",mode:"handwriting",icon:'<path d="M5.5 18.5 4 20l1.5-.1L9 19l10.5-10.5a1.6 1.6 0 0 0 0-2.2L17.7 4a1.6 1.6 0 0 0-2.2 0L5 14.5l.5 4Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.5 5.5 18.5 8.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>',viewBox:"0 0 24 24"}];function nc(){const e=document.getElementById("multiButtonConfig");if(!e)return;Be.length===0&&(Be=ge.map(a=>a.id));const t=document.createElement("div");t.className="button-palette";const n=document.createElement("div");n.id="paletteGrid",n.className="palette-grid",n.style.cssText="display:grid; grid-template-columns:repeat(auto-fill, minmax(42px, 1fr)); gap:5px; margin-bottom:16px;",Be.forEach(a=>{const c=ge.find(p=>p.id===a);if(!c)return;const u=document.createElement("button");u.className="config-tool-btn tool icon-btn",u.dataset.toolId=c.id,u.title=c.label,u.style.cssText="padding:6px; background:var(--btn); border:1px solid var(--btn-border); border-radius:8px; cursor:move; display:flex; align-items:center; justify-content:center; min-height:44px; width:100%; aspect-ratio:1;";const f=document.createElementNS("http://www.w3.org/2000/svg","svg");f.setAttribute("class","icon"),f.setAttribute("viewBox",c.viewBox),f.setAttribute("aria-hidden","true"),f.style.cssText="width:22px; height:22px; pointer-events:none;",f.innerHTML=c.icon,u.appendChild(f),n.appendChild(u)}),t.appendChild(n);const i=document.createElement("div");i.style.cssText="padding: 0 12px;",i.innerHTML='<h5 style="margin:12px 0 12px; font-size:14px; font-weight:600;">Multiprzyciski:</h5>';const o=document.createElement("div");o.id="multiGroups",o.style.cssText="display:flex; flex-direction:column; gap:8px; min-height:120px; padding:12px; background:rgba(0,0,0,0.1); border-radius:8px; border:2px dashed transparent; transition:all 0.2s;",i.appendChild(o);const l=document.createElement("div");l.style.cssText="padding: 0 12px 12px;",l.innerHTML='<h5 style="margin:12px 0 12px; font-size:14px; font-weight:600;">Dwa rzÄ™dy:</h5>';const r=document.createElement("div");r.id="secondGroups",r.style.cssText="display:flex; flex-direction:column; gap:8px; min-height:120px; padding:12px; background:rgba(0,0,0,0.1); border-radius:8px; border:2px dashed transparent; transition:all 0.2s;",l.appendChild(r),e.innerHTML="",e.appendChild(t),e.appendChild(i),e.appendChild(l),oc(),br(o,"multi"),br(r,"second"),da(o,r)}function da(e,t){Object.entries(we.multiButtons).forEach(([n,i])=>{if(i.length>0){const o=Ms(e,"multi");if(!o)return;const l=o.querySelector(".group-remove-btn");i.forEach(r=>{const a=ge.find(u=>u.id===r);if(!a)return;const c=an(a.id,a.icon,a.viewBox,a.label);l&&o.insertBefore(c,l)})}}),Object.entries(we.secondRow).forEach(([n,i])=>{if(i.length>0){const o=Ms(t,"second");if(!o)return;const l=o.querySelector(".group-remove-btn"),r=ge.find(a=>a.id===n);if(r){const a=an(r.id,r.icon,r.viewBox,r.label);l&&o.insertBefore(a,l)}i.forEach(a=>{const c=ge.find(f=>f.id===a);if(!c)return;const u=an(c.id,c.icon,c.viewBox,c.label);l&&o.insertBefore(u,l)})}})}function Ji(){const e=document.getElementById("toolbarMainRow");if(!e)return;const t=new Map;ge.forEach(o=>{const l=document.getElementById(o.id);l&&t.set(o.id,l)});const n=new Set;Object.entries(we.multiButtons).forEach(([o,l])=>{const r=t.get(o);if(!(!r||l.length===0)&&(l.forEach(a=>n.add(a)),o in Pt||(Pt[o]=0),l.length>1)){const a=r.querySelector(".multi-indicator");a&&a.remove();const c=document.createElement("span");c.className="multi-indicator",c.style.cssText="position:absolute; top:3px; right:3px; width:10px; height:10px; display:flex; flex-direction:column; align-items:center; gap:1px;";const u=document.createElement("span");u.style.cssText="width:2.5px; height:2.5px; background:rgba(128,128,128,0.6); border-radius:50%;";const f=document.createElement("span");f.style.cssText="display:flex; gap:2px;";const p=document.createElement("span");p.style.cssText="width:2.5px; height:2.5px; background:rgba(128,128,128,0.6); border-radius:50%;";const m=document.createElement("span");m.style.cssText="width:2.5px; height:2.5px; background:rgba(128,128,128,0.6); border-radius:50%;",f.appendChild(p),f.appendChild(m),c.appendChild(u),c.appendChild(f),r.style.position="relative",r.appendChild(c);const x=r.cloneNode(!0);r.parentNode?.replaceChild(x,r),t.set(o,x),x.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation();const b=Pt[o],h=l[b],v=ge.find(B=>B.id===h);if(!v)return;let k=!1;if(h==="copyStyleBtn"?k=Ce:k=V===v.mode,k){Pt[o]=(Pt[o]+1)%l.length;const B=Pt[o],E=l[B],w=ge.find(S=>S.id===E);if(w){const S=x.querySelector("svg");if(S&&(S.setAttribute("viewBox",w.viewBox),S.innerHTML=w.icon),x.setAttribute("title",w.label),x.setAttribute("aria-label",w.label),B===0)E==="copyStyleBtn"?(Ce=!1,Ae=null,$()):Ie("move");else if(E==="copyStyleBtn"){if(!Ce){const I=Il();I&&(Ae=I,Ce=!0,$())}}else Ie(w.mode)}}else if(h==="copyStyleBtn")if(Ce)Ce=!1,Ae=null,$();else{const B=Il();B&&(Ae=B,Ce=!0,$())}else Ie(v.mode)});const d=ge.find(y=>y.id===l[Pt[o]]);if(d){const y=x.querySelector("svg");y&&(y.setAttribute("viewBox",d.viewBox),y.innerHTML=d.icon),x.setAttribute("title",d.label),x.setAttribute("aria-label",d.label)}}}),Object.entries(we.secondRow).forEach(([o,l])=>{const r=t.get(o);!r||l.length===0||(n.add(o),l.forEach(a=>n.add(a)),r.classList.add("has-second-row"),r.dataset.secondRowConfig=JSON.stringify(l))}),t.forEach((o,l)=>{Object.keys(we.multiButtons).includes(l);const r=Object.values(we.multiButtons).some(c=>c.includes(l)&&c[0]!==l);Object.keys(we.secondRow).includes(l);const a=Object.values(we.secondRow).some(c=>c.includes(l));r||a?o.style.display="none":o.style.display="inline-flex"});const i=[];Be.forEach(o=>{const l=t.get(o);l&&l.style.display!=="none"&&i.push(l)}),i.forEach(o=>{e.appendChild(o)}),ua(t)}function ua(e){const t=document.getElementById("toolbarMainRow");if(!t)return;t.querySelectorAll(".has-second-row").forEach(i=>{const o=i,l=o.dataset.secondRowConfig;if(!l)return;const r=JSON.parse(l),a=o.id;let c=0,u=0,f=!1,p=!1;const m=h=>{c=h,u=Date.now(),f=!1,p=!1},x=(h,v)=>{const k=c-h,B=Date.now()-u;Math.abs(k)>5&&(p=!0),k>20&&B<500&&!f&&(f=!0,v&&v.preventDefault(),fa(a,r,e))},d=()=>{f=!1};o.addEventListener("touchstart",h=>{m(h.touches[0].clientY)},{passive:!0}),o.addEventListener("touchmove",h=>{x(h.touches[0].clientY,h)},{passive:!1}),o.addEventListener("touchend",d,{passive:!0});let y=!1;o.addEventListener("mousedown",h=>{y=!0,m(h.clientY)}),o.addEventListener("mousemove",h=>{y&&(x(h.clientY,h),p&&h.preventDefault())});const b=()=>{y=!1,d()};o.addEventListener("mouseup",b),o.addEventListener("mouseleave",b)})}function fa(e,t,n){const i=document.getElementById("toolbarSecondRow");if(i){if(Ho&&Bl===e){ic();return}i.innerHTML="",Bs=t,t.forEach(o=>{const l=n.get(o);if(l){const r=l.cloneNode(!0);r.style.display="inline-flex",r.classList.remove("active"),i.appendChild(r);const a=ge.find(c=>c.id===o);a&&(a.mode===V&&r.classList.add("active"),r.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),Ie(a.mode)}))}}),i.style.display="flex",i.classList.remove("hidden"),setTimeout(()=>{i.classList.remove("hidden")},10),Ho=!0,Bl=e}}function ic(){const e=document.getElementById("toolbarSecondRow");e&&(e.classList.add("hidden"),setTimeout(()=>{e.style.display="none"},250),Ho=!1,Bl=null,Bs=[])}function pa(){if(!Ho)return;const e=document.getElementById("toolbarSecondRow");if(!e)return;e.querySelectorAll("button.tool").forEach(n=>{const i=ge.find(o=>{const l=n.getAttribute("title");return l&&o.label===l});i&&i.mode===V?n.classList.add("active"):n.classList.remove("active")})}function oc(){const e=document.getElementById("paletteGrid");document.querySelectorAll(".config-tool-btn").forEach(n=>{const i=n;i.draggable=!0;const o=i.dataset.toolId,l=ge.find(r=>r.id===o);l&&(i.addEventListener("dragstart",r=>{r.dataTransfer&&(r.dataTransfer.effectAllowed="copyMove",r.dataTransfer.setData("toolId",l.id),r.dataTransfer.setData("toolIcon",l.icon),r.dataTransfer.setData("toolViewBox",l.viewBox),r.dataTransfer.setData("toolLabel",l.label),r.dataTransfer.setData("fromPalette","true"),i.classList.add("dragging-from-palette"),i.style.opacity="0.4")}),i.addEventListener("dragend",()=>{i.classList.remove("dragging-from-palette"),i.style.opacity="1"}),i.addEventListener("dragover",r=>{const a=document.querySelector(".dragging-from-palette");a&&e?.contains(a)&&(r.preventDefault(),r.stopPropagation(),r.dataTransfer&&(r.dataTransfer.dropEffect="move"),i.style.background="rgba(59, 130, 246, 0.2)")}),i.addEventListener("dragleave",()=>{i.style.background="var(--btn)"}),i.addEventListener("drop",r=>{if(r.dataTransfer?.getData("fromPalette")&&e&&r.dataTransfer){r.preventDefault(),r.stopPropagation(),i.style.background="var(--btn)";const c=r.dataTransfer.getData("toolId");if(c&&c!==o){const u=Be.indexOf(c),f=Be.indexOf(o);u!==-1&&f!==-1&&(Be.splice(u,1),Be.splice(f,0,c),Ns(),lc(),Ji())}}}),rc(i,l.id,l.icon,l.viewBox,l.label,!1))}),e&&e.addEventListener("dragover",n=>{if(n.dataTransfer?.types.includes("text/plain")){const o=n.target;(o===e||o.classList.contains("palette-grid"))&&(n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="move"))}})}function br(e,t){e.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="copy"),e.style.borderColor="#3b82f6",e.style.background="rgba(59, 130, 246, 0.1)"}),e.addEventListener("dragleave",()=>{e.style.borderColor="transparent",e.style.background="rgba(0,0,0,0.1)"}),e.addEventListener("drop",n=>{if(n.preventDefault(),e.style.borderColor="transparent",e.style.background="rgba(0,0,0,0.1)",!n.dataTransfer)return;const i=n.dataTransfer.getData("toolId"),o=n.dataTransfer.getData("toolIcon"),l=n.dataTransfer.getData("toolViewBox"),r=n.dataTransfer.getData("toolLabel"),a=n.target,c=a.classList.contains("button-group")||a.closest(".button-group");if(i&&o&&l)if(c&&a!==e){const u=a.classList.contains("button-group")?a:a.closest(".button-group");if(u){const f=u.querySelector(".group-remove-btn"),p=an(i,o,l,r);f?u.insertBefore(p,f):u.appendChild(p),rn()}}else{Ms(e,t);const u=e.lastElementChild;if(u){const f=u.querySelector(".group-remove-btn"),p=an(i,o,l,r);f?u.insertBefore(p,f):u.appendChild(p),rn()}}})}function an(e,t,n,i){const o=document.createElement("div");o.className="config-tool-item",o.dataset.toolId=e,o.title=i,o.draggable=!0,o.style.cssText="padding:6px; background:var(--btn); border:1px solid var(--btn-border); border-radius:6px; display:flex; gap:4px; align-items:center; justify-content:center; min-width:40px; min-height:40px; cursor:grab; position:relative;";const l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.setAttribute("class","icon"),l.setAttribute("viewBox",n),l.setAttribute("aria-hidden","true"),l.style.cssText="width:20px; height:20px; pointer-events:none; flex-shrink:0;",l.innerHTML=t,o.appendChild(l);const r=document.createElement("span");return r.textContent="âœ•",r.style.cssText="width:18px; height:18px; background:#ef4444; color:white; border-radius:50%; display:none; align-items:center; justify-content:center; font-size:12px; cursor:pointer; flex-shrink:0; position:absolute; top:-6px; right:-6px;",o.appendChild(r),o.addEventListener("mouseenter",()=>{r.style.display="flex"}),o.addEventListener("mouseleave",()=>{r.style.display="none"}),r.addEventListener("click",a=>{a.stopPropagation(),o.remove(),rn()}),o.addEventListener("dragstart",a=>{a.dataTransfer&&(a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("toolId",e),a.dataTransfer.setData("toolIcon",t),a.dataTransfer.setData("toolViewBox",n),a.dataTransfer.setData("toolLabel",i),a.dataTransfer.setData("fromGroup","true"),o.style.opacity="0.4")}),o.addEventListener("dragend",()=>{o.style.opacity="1"}),o.addEventListener("dragover",a=>{a.preventDefault(),a.stopPropagation(),a.dataTransfer?.types.includes("text/plain")&&(o.style.background="rgba(59, 130, 246, 0.2)")}),o.addEventListener("dragleave",()=>{o.style.background="var(--btn)"}),o.addEventListener("drop",a=>{if(a.preventDefault(),a.stopPropagation(),o.style.background="var(--btn)",!a.dataTransfer)return;const c=a.dataTransfer.getData("toolId"),u=a.dataTransfer.getData("toolIcon"),f=a.dataTransfer.getData("toolViewBox"),p=a.dataTransfer.getData("toolLabel"),m=a.dataTransfer.getData("fromGroup");if(c&&c!==e){const x=o.closest(".button-group");if(!x)return;if(m){const y=Array.from(x.querySelectorAll(".config-tool-item")).find(b=>b.dataset.toolId===c);y&&y.remove()}const d=an(c,u,f,p);o.parentElement?.insertBefore(d,o),rn()}}),rc(o,e,t,n,i,!0),o}function Ms(e,t){const n=document.createElement("div");n.className="button-group",n.style.cssText="display:flex; flex-wrap:wrap; gap:6px; align-items:center; padding:12px; background:var(--panel); border:2px solid var(--btn-border); border-radius:8px; min-height:60px; width:100%;",n.dataset.groupType=t;const i=document.createElement("button");return i.textContent="âœ•",i.className="tool icon-btn group-remove-btn",i.style.cssText="margin-left:auto; width:24px; height:24px; padding:0; background:transparent; border:none; font-size:18px; opacity:0.6; cursor:pointer;",i.addEventListener("click",()=>{n.remove(),rn()}),i.addEventListener("dragover",o=>{o.stopPropagation()}),i.addEventListener("drop",o=>{o.stopPropagation(),o.preventDefault()}),n.appendChild(i),ya(n),e.appendChild(n),n}function ya(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),e.style.background="rgba(59, 130, 246, 0.1)"}),e.addEventListener("dragleave",t=>{t.stopPropagation(),e.style.background="var(--panel)"}),e.addEventListener("drop",t=>{if(t.preventDefault(),t.stopPropagation(),e.style.background="var(--panel)",!t.dataTransfer)return;const n=t.dataTransfer.getData("toolId"),i=t.dataTransfer.getData("toolIcon"),o=t.dataTransfer.getData("toolViewBox"),l=t.dataTransfer.getData("toolLabel");if(n&&i&&o){const r=e.querySelector(".group-remove-btn"),a=an(n,i,o,l);r?e.insertBefore(a,r):e.appendChild(a),rn()}})}function sc(){try{localStorage.setItem("geometryButtonConfig",JSON.stringify(we))}catch(e){console.error("Failed to save button configuration:",e)}}function rn(){const e=document.getElementById("multiGroups"),t=document.getElementById("secondGroups");we={multiButtons:{},secondRow:{}},e&&e.querySelectorAll(".button-group").forEach((i,o)=>{const l=i.querySelectorAll(".config-tool-item"),r=[];if(l.forEach(a=>{const c=a.dataset.toolId;c&&r.push(c)}),r.length>0){const a=r[0];we.multiButtons[a]=r}}),t&&t.querySelectorAll(".button-group").forEach(i=>{const o=i.querySelectorAll(".config-tool-item"),l=[];if(o.forEach(r=>{const a=r.dataset.toolId;a&&l.push(a)}),l.length>0){const r=l[0],a=l.slice(1);a.length>0&&(we.secondRow[r]=a)}}),sc()}function Ns(){try{localStorage.setItem("geometryButtonOrder",JSON.stringify(Be))}catch(e){console.error("Failed to save button order:",e)}}function ha(){try{const e=localStorage.getItem("geometryButtonOrder");if(e){Be=JSON.parse(e);const n=ge.map(i=>i.id).filter(i=>!Be.includes(i));n.length>0&&(Be.push(...n),Ns())}else Be=ge.map(t=>t.id)}catch(e){console.error("Failed to load button order:",e),Be=ge.map(t=>t.id)}}function lc(){const e=document.getElementById("paletteGrid");e&&(e.innerHTML="",Be.forEach(t=>{const n=ge.find(l=>l.id===t);if(!n)return;const i=document.createElement("button");i.className="config-tool-btn tool icon-btn",i.dataset.toolId=n.id,i.title=n.label,i.style.cssText="padding:6px; background:var(--btn); border:1px solid var(--btn-border); border-radius:8px; cursor:move; display:flex; align-items:center; justify-content:center; min-height:44px; width:100%; aspect-ratio:1;";const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("class","icon"),o.setAttribute("viewBox",n.viewBox),o.setAttribute("aria-hidden","true"),o.style.cssText="width:22px; height:22px; pointer-events:none;",o.innerHTML=n.icon,i.appendChild(o),e.appendChild(i)}),oc())}function rc(e,t,n,i,o,l){let r=!1,a=null,c=null;e.addEventListener("touchstart",u=>{const f=u.touches[0];r=!1,pe={element:e,toolId:t,toolIcon:n,toolViewBox:i,toolLabel:o,startX:f.clientX,startY:f.clientY,fromGroup:l}},{passive:!0}),e.addEventListener("touchmove",u=>{if(!pe)return;const f=u.touches[0],p=Math.abs(f.clientX-pe.startX),m=Math.abs(f.clientY-pe.startY);if(!r&&(p>5||m>5)){r=!0,e.style.opacity="0.4",a=document.createElement("div"),a.style.cssText="position:fixed; pointer-events:none; opacity:0.8; z-index:10000; padding:6px; background:var(--btn); border:2px solid #3b82f6; border-radius:6px; display:flex; align-items:center; justify-content:center; width:40px; height:40px;";const x=e.querySelector("svg")?.cloneNode(!0);x&&a.appendChild(x),a.style.left=f.clientX-20+"px",a.style.top=f.clientY-20+"px",document.body.appendChild(a),u.preventDefault()}if(r&&a){a.style.left=f.clientX-20+"px",a.style.top=f.clientY-20+"px";const x=document.elementFromPoint(f.clientX,f.clientY);if(x){const d=x.closest(".button-group"),y=x.closest("#multiGroups, #secondGroups");c&&c!==d&&c!==y&&(c.style.background="",c.style.borderColor=""),d?(c!==d&&(d.style.background="rgba(59, 130, 246, 0.1)"),c=d):y?(c!==y&&(y.style.background="rgba(59, 130, 246, 0.05)",y.style.borderColor="#3b82f6"),c=y):c&&(c.style.background="",c.style.borderColor="",c=null)}u.preventDefault()}},{passive:!1}),e.addEventListener("touchend",u=>{if(c&&(c.style.background="",c.style.borderColor="",c=null),a&&(a.remove(),a=null),!pe||!r){e.style.opacity="1",pe=null,r=!1;return}e.style.opacity="1";const f=u.changedTouches[0],p=document.elementFromPoint(f.clientX,f.clientY);if(!p){pe=null,r=!1;return}const m=p.closest(".config-tool-btn"),x=document.getElementById("paletteGrid");if(m&&x&&m.parentElement===x&&!l){const b=m.dataset.toolId,h=pe.toolId;if(b&&h&&b!==h){const v=Be.indexOf(h),k=Be.indexOf(b);v!==-1&&k!==-1&&(Be.splice(v,1),Be.splice(k,0,h),Ns(),lc(),Ji())}pe=null,r=!1;return}const d=p.closest(".button-group");if(d){const b=p.closest(".config-tool-item");if(b&&b!==e)e.closest(".button-group")===d?d.insertBefore(e,b):(e.remove(),d.insertBefore(an(pe.toolId,pe.toolIcon,pe.toolViewBox,pe.toolLabel),b)),rn();else if((!b||b===e)&&b!==e){const h=e.closest(".button-group");if(l){const v=Array.from(d.querySelectorAll(".config-tool-item")).find(k=>k.dataset.toolId===pe.toolId);v&&v!==e&&v.remove()}if(!(h===d&&l)){const v=d.querySelector(".group-remove-btn"),k=an(pe.toolId,pe.toolIcon,pe.toolViewBox,pe.toolLabel);v?d.insertBefore(k,v):d.appendChild(k),l&&h!==d&&e.remove()}rn()}pe=null,r=!1;return}const y=p.closest("#multiGroups, #secondGroups");if(l&&!y){e.remove(),rn(),pe=null,r=!1;return}if(y&&!l){const h=y.id==="multiGroups"?"multi":"second",v=Ms(y,h);if(v){const k=v.querySelector(".group-remove-btn"),B=an(pe.toolId,pe.toolIcon,pe.toolViewBox,pe.toolLabel);k?v.insertBefore(B,k):v.appendChild(B),rn()}}pe=null,r=!1},{passive:!0}),e.addEventListener("touchcancel",()=>{c&&(c.style.background="",c.style.borderColor="",c=null),a&&(a.remove(),a=null),e.style.opacity="1",pe=null,r=!1},{passive:!0})}function ga(){try{const e=localStorage.getItem("geometryButtonConfig");e&&(we=JSON.parse(e))}catch(e){console.error("Failed to load button configuration:",e)}try{const e=localStorage.getItem("measurementPrecisionLength");if(e!==null){const t=parseInt(e,10);!isNaN(t)&&t>=0&&t<=5&&(cn=t)}}catch(e){console.error("Failed to load measurement precision length:",e)}try{const e=localStorage.getItem("measurementPrecisionAngle");if(e!==null){const t=parseInt(e,10);!isNaN(t)&&t>=0&&t<=5&&(wn=t)}}catch(e){console.error("Failed to load measurement precision angle:",e)}}function So(){const e=new Date,t=n=>n.toString().padStart(2,"0");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}_${t(e.getHours())}-${t(e.getMinutes())}-${t(e.getSeconds())}`}async function ma(){const e={version:1,buttonOrder:Be,multiButtons:we.multiButtons,secondRow:we.secondRow,themeOverrides:Ct,measurementPrecisionLength:cn,measurementPrecisionAngle:wn,defaultFolderName:localStorage.getItem("defaultFolderName")||void 0},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"});if("showSaveFilePicker"in window&&mt)try{const l=await Kr(mt),a={suggestedName:`geometry-config-${So()}.json`,types:[{description:"JSON File",accept:{"application/json":[".json"]}}]};l?a.startIn=mt:(mt=null,await ls(null),_i());const u=await(await window.showSaveFilePicker(a)).createWritable();await u.write(n),await u.close();return}catch(l){if(l.name==="AbortError")return;console.warn("Failed to save config via showSaveFilePicker, falling back:",l)}const i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`geometry-config-${So()}.json`,o.click(),URL.revokeObjectURL(i)}function xa(e){try{const t=JSON.parse(e);if(t.buttonOrder&&Array.isArray(t.buttonOrder)){const o=t.buttonOrder.filter(a=>ge.some(c=>c.id===a)),r=ge.map(a=>a.id).filter(a=>!o.includes(a));Be=[...o,...r]}else Be=ge.map(o=>o.id);if(t.multiButtons&&typeof t.multiButtons=="object"){const o={};Object.entries(t.multiButtons).forEach(([l,r])=>{if(Array.isArray(r)){const a=r.filter(c=>ge.some(u=>u.id===c));a.length>0&&(o[l]=a)}}),we.multiButtons=o}else we.multiButtons={};if(t.secondRow&&typeof t.secondRow=="object"){const o={};Object.entries(t.secondRow).forEach(([l,r])=>{if(Array.isArray(r)){const a=r.filter(c=>ge.some(u=>u.id===c));a.length>0&&(o[l]=a)}}),we.secondRow=o}else we.secondRow={};t.themeOverrides&&typeof t.themeOverrides=="object"&&(Ct.dark=t.themeOverrides.dark||{},Ct.light=t.themeOverrides.light||{},nl(),ms(Ft),typeof window.refreshAppearanceTab=="function"&&window.refreshAppearanceTab()),typeof t.measurementPrecisionLength=="number"&&(cn=t.measurementPrecisionLength,localStorage.setItem("measurementPrecisionLength",cn.toString())),typeof t.measurementPrecisionAngle=="number"&&(wn=t.measurementPrecisionAngle,localStorage.setItem("measurementPrecisionAngle",wn.toString())),typeof t.defaultFolderName=="string"&&localStorage.setItem("defaultFolderName",t.defaultFolderName),sc(),Ns(),Ji(),Ea(),nc();const n=document.getElementById("precisionLength"),i=document.getElementById("precisionAngle");return n&&(n.value=cn.toString()),i&&(i.value=wn.toString()),P(),!0}catch(t){return console.error("Failed to import configuration:",t),!1}}function ba(){const e=document.querySelectorAll(".appearance-theme-toggle .theme-btn"),t=document.getElementById("previewCanvas");let n=Ft;const i=document.getElementById("themeBgColor"),o=document.getElementById("themeStrokeColor"),l=document.getElementById("themePanelColor"),r=document.getElementById("themeHighlightColor"),a=document.getElementById("themeBgColorHex"),c=document.getElementById("themeStrokeColorHex"),u=document.getElementById("themeHighlightColorHex"),f=document.getElementById("themePanelColorHex"),p=document.getElementById("themeLineWidthValue"),m=document.getElementById("themePointSizeValue"),x=document.getElementById("themeArcRadiusValue"),d=document.getElementById("themeFontSizeValue"),y=document.getElementById("themeHighlightWidthValue"),b=document.getElementById("resetThemeDefaults");function h(){const w=n,S=yo[w],I=Ct[w],L={...S,...I};i&&(i.value=L.bg||S.bg),a&&(a.value=(L.bg||S.bg).toLowerCase()),o&&(o.value=L.defaultStroke||S.defaultStroke),c&&(c.value=(L.defaultStroke||S.defaultStroke).toLowerCase()),l&&(l.value=L.panel??S.panel),f&&(f.value=String(L.panel??S.panel).toLowerCase()),r&&(r.value=L.highlight||S.highlight),u&&(u.value=(L.highlight||S.highlight).toLowerCase()),p&&(p.textContent=`${L.lineWidth||S.lineWidth} px`),m&&(m.textContent=`${L.pointSize||S.pointSize} px`),x&&(x.textContent=`${L.angleDefaultRadius||S.angleDefaultRadius} px`),d&&(d.textContent=`${L.fontSize||S.fontSize} px`),y&&(y.textContent=`${L.highlightWidth||S.highlightWidth} px`),e.forEach(A=>{A.classList.toggle("active",A.dataset.theme===w)}),E()}window.refreshAppearanceTab=h,e.forEach(w=>{w.addEventListener("click",()=>{const S=w.dataset.theme;S&&(n=S,h())})});function v(w,S){Ct[n][w]=S,nl(),n===Ft&&(ms(Ft),P()),E()}i?.addEventListener("input",w=>{const S=w.target.value;a&&(a.value=S.toLowerCase()),v("bg",S)}),o?.addEventListener("input",w=>{const S=w.target.value;c&&(c.value=S.toLowerCase()),v("defaultStroke",S)}),l?.addEventListener("input",w=>{const S=w.target.value;try{const I=document.documentElement,L=document.body;I.style.setProperty("--panel",S),I.style.setProperty("--panel-border",S),L&&(L.style.setProperty("--panel",S),L.style.setProperty("--panel-border",S))}catch{}v("panel",S),v("panelBorder",S)});function k(w){if(!w)return null;let S=w.trim();if(S.startsWith("#")||(S="#"+S),/^#([0-9a-fA-F]{3})$/.test(S)){const I=S.charAt(1),L=S.charAt(2),A=S.charAt(3);return("#"+I+I+L+L+A+A).toLowerCase()}return/^#([0-9a-fA-F]{6})$/.test(S)?S.toLowerCase():null}a?.addEventListener("change",w=>{const S=w.target.value,I=k(S);I&&i?(i.value=I,v("bg",I)):S===""&&(a.value="")}),c?.addEventListener("change",w=>{const S=w.target.value,I=k(S);I&&o&&(o.value=I,v("defaultStroke",I))}),u?.addEventListener("change",w=>{const S=w.target.value,I=k(S);I&&r&&(r.value=I,v("highlight",I))}),f?.addEventListener("change",w=>{const S=w.target.value,I=k(S);if(I&&l){l.value=I;try{const L=document.documentElement,A=document.body;L.style.setProperty("--panel",I),L.style.setProperty("--panel-border",I),A&&(A.style.setProperty("--panel",I),A.style.setProperty("--panel-border",I))}catch{}v("panel",I),v("panelBorder",I)}}),r?.addEventListener("input",w=>{const S=w.target.value;u&&(u.value=S.toLowerCase()),v("highlight",S)}),document.querySelectorAll(".size-btn").forEach(w=>{w.addEventListener("click",()=>{const S=w.dataset.action,I=w.dataset.target;if(!S||!I)return;const L=yo[n],A=Ct[n],R={...L,...A},T=S==="increase"?1:-1;if(I==="lineWidth"){const D=(R.lineWidth||L.lineWidth)+T*.1,N=Math.max(.1,Math.min(50,Math.round(D*10)/10));v("lineWidth",N),v("angleStrokeWidth",N),p&&(p.textContent=`${N} px`)}else if(I==="pointSize"){const D=(R.pointSize||L.pointSize)+T*.1,N=Math.max(.1,Math.min(50,Math.round(D*10)/10));v("pointSize",N),m&&(m.textContent=`${N} px`)}else if(I==="arcRadius"){const D=(R.angleDefaultRadius||L.angleDefaultRadius)+T*1,N=Math.max(1,Math.min(200,D));v("angleDefaultRadius",N),x&&(x.textContent=`${N} px`)}else if(I==="fontSize"){const D=(R.fontSize||L.fontSize)+T*1,N=Math.max(4,Math.min(100,D));v("fontSize",N),d&&(d.textContent=`${N} px`)}else if(I==="highlightWidth"){const D=(R.highlightWidth||L.highlightWidth)+T*.1,N=Math.max(.1,Math.min(20,Math.round(D*10)/10));v("highlightWidth",N),y&&(y.textContent=`${N} px`)}})}),b?.addEventListener("click",()=>{Ct[n]={},nl(),n===Ft&&(ms(Ft),P()),h()});function E(){if(!t)return;const w=t.getContext("2d");if(!w)return;const S=yo[n],I=Ct[n],L={...S,...I},A=t.width,R=t.height;w.fillStyle=L.bg,w.fillRect(0,0,A,R);const T=[{x:A*.25,y:R*.7},{x:A*.75,y:R*.7},{x:A*.5,y:R*.3}];w.strokeStyle=L.defaultStroke,w.lineWidth=L.lineWidth,w.beginPath(),w.moveTo(T[0].x,T[0].y),T.forEach(W=>w.lineTo(W.x,W.y)),w.closePath(),w.stroke(),w.strokeStyle=L.highlight,w.lineWidth=(L.highlightWidth||1.5)+L.lineWidth,w.beginPath(),w.moveTo(T[1].x,T[1].y),w.lineTo(T[2].x,T[2].y),w.stroke(),T.forEach((W,te)=>{w.fillStyle=te===1?L.highlight:L.defaultStroke,w.beginPath(),w.arc(W.x,W.y,L.pointSize+2,0,Math.PI*2),w.fill()});const C=T[2],D=Math.atan2(T[0].y-C.y,T[0].x-C.x),N=Math.atan2(T[1].y-C.y,T[1].x-C.x);w.strokeStyle=L.defaultStroke,w.lineWidth=L.lineWidth,w.beginPath(),w.arc(C.x,C.y,L.angleDefaultRadius,N,D),w.stroke();const O={x:A*.75,y:R*.35},F=A*.12;w.strokeStyle=L.defaultStroke,w.lineWidth=L.lineWidth,w.beginPath(),w.arc(O.x,O.y,F,0,Math.PI*2),w.stroke();const Y={x:O.x+F*Math.cos(Math.PI*.25),y:O.y+F*Math.sin(Math.PI*.25)},Q={x:O.x+F*Math.cos(Math.PI*1.75),y:O.y+F*Math.sin(Math.PI*1.75)};[Y,Q].forEach(W=>{w.fillStyle=L.defaultStroke,w.beginPath(),w.arc(W.x,W.y,L.pointSize+2,0,Math.PI*2),w.fill()}),w.fillStyle=L.defaultStroke,w.font=`${L.fontSize||12}px Arial`,w.textAlign="center",w.textBaseline="middle",w.fillText("A",T[0].x,T[0].y+20),w.fillText("B",T[1].x,T[1].y+20),w.fillText("C",T[2].x,T[2].y-20)}h()}function va(){const e=document.getElementById("labelGreekRow");if(!e)return;const t=Math.max(wl.length,Sl.length);for(let n=0;n<t;n++){const i=wl[n],o=i?i.toUpperCase():"",l=document.createElement("button");l.type="button",l.className="tool icon-btn label-greek-btn",i?(l.title=i,l.dataset.letter=i,l.dataset.letterLower=i,l.dataset.letterUpper=o,l.textContent=i):(l.title="",l.dataset.letter="",l.dataset.letterLower="",l.dataset.letterUpper="",l.textContent="",l.style.display="none"),e.appendChild(l)}for(const n of Uc){const i=document.createElement("button");i.type="button",i.className="tool icon-btn label-greek-btn label-symbol-btn",i.title=n,i.dataset.letter=n,i.dataset.letterLower=n,i.dataset.letterUpper=n,i.textContent=n,e.appendChild(i)}}function _i(){if(fo&&Hi)if(mt)fo.textContent=mt.name,Hi.style.display="block";else{const e=localStorage.getItem("defaultFolderName");e?(fo.textContent=e,Hi.style.display="block"):(fo.textContent="Nie wybrano",Hi.style.display="none")}}function ka(e){const t=document.getElementById("importConfigBtn");if(!t)return;const n=t.querySelector(".import-feedback");n&&n.remove();const i=document.createElement("span");i.className="import-feedback",i.style.cssText="margin-left: 8px; font-size: 16px; display: inline-block; animation: fadeIn 0.3s ease;",i.textContent=e?"âœ“":"âœ—",i.style.color=e?"#4ade80":"#f87171",t.appendChild(i),setTimeout(()=>{i.style.transition="opacity 0.3s ease",i.style.opacity="0",setTimeout(()=>i.remove(),300)},2e3)}function Ea(){An=document.getElementById("modeTangent"),Dn=document.getElementById("modePerpBisector"),kn=document.getElementById("modeAdd"),En=document.getElementById("modeSegment"),Io=document.getElementById("modeParallel"),Bo=document.getElementById("modePerpendicular"),Mo=document.getElementById("modeCircleThree"),Po=document.getElementById("modeTriangleUp"),_o=document.getElementById("modeSquare"),To=document.getElementById("modePolygon"),zo=document.getElementById("modeHandwriting"),Co=document.getElementById("modeAngle"),Ro=document.getElementById("modeBisector"),Ao=document.getElementById("modeMidpoint"),Wi=document.getElementById("modeSymmetric"),qi=document.getElementById("modeParallelLine"),Do=document.getElementById("modeNgon"),si=document.getElementById("modeLabel"),en=document.getElementById("modeMove"),Lo=document.getElementById("modeMultiselect"),kn?.addEventListener("click",()=>ie("add")),kn?.addEventListener("dblclick",e=>{e.preventDefault(),_t("add")}),Nn(kn,"add"),En?.addEventListener("click",()=>ie("segment")),En?.addEventListener("dblclick",e=>{e.preventDefault(),_t("segment")}),Nn(En,"segment"),Io?.addEventListener("click",()=>ie("parallel")),Bo?.addEventListener("click",()=>ie("perpendicular")),Mo?.addEventListener("click",()=>ie("circleThree")),Po?.addEventListener("click",()=>ie("triangleUp")),_o?.addEventListener("click",()=>ie("square")),To?.addEventListener("click",()=>ie("polygon")),zo?.addEventListener("click",()=>ie("handwriting")),Co?.addEventListener("click",()=>ie("angle")),Ro?.addEventListener("click",()=>ie("bisector")),Ao?.addEventListener("click",()=>ie("midpoint")),Wi?.addEventListener("click",()=>ie("symmetric")),qi?.addEventListener("click",()=>ie("parallelLine")),An?.addEventListener("click",()=>ie("tangent")),An?.addEventListener("dblclick",e=>{e.preventDefault(),_t("tangent")}),Nn(An,"tangent"),Dn?.addEventListener("click",()=>ie("perpBisector")),Dn?.addEventListener("dblclick",e=>{e.preventDefault(),_t("perpBisector")}),Nn(Dn,"perpBisector"),Do?.addEventListener("click",()=>ie("ngon")),si?.addEventListener("click",()=>{Ie("label"),st()}),en?.addEventListener("click",()=>{V==="move"?Qi=!1:(Ie("move"),st(),$())}),Lo?.addEventListener("click",()=>ie("multiselect"))}function wa(){ce=document.getElementById("canvas"),g=ce?.getContext("2d")??null,kn=document.getElementById("modeAdd"),si=document.getElementById("modeLabel"),en=document.getElementById("modeMove"),Lo=document.getElementById("modeMultiselect"),En=document.getElementById("modeSegment"),Io=document.getElementById("modeParallel"),Bo=document.getElementById("modePerpendicular"),Mo=document.getElementById("modeCircleThree"),Po=document.getElementById("modeTriangleUp"),_o=document.getElementById("modeSquare"),To=document.getElementById("modePolygon"),zo=document.getElementById("modeHandwriting"),Co=document.getElementById("modeAngle"),Ro=document.getElementById("modeBisector"),Ao=document.getElementById("modeMidpoint"),Wi=document.getElementById("modeSymmetric"),qi=document.getElementById("modeParallelLine"),An=document.getElementById("modeTangent"),Dn=document.getElementById("modePerpBisector"),Do=document.getElementById("modeNgon"),or=document.getElementById("debugToggle");const e=document.getElementById("settingsBtn"),t=document.getElementById("settingsModal"),n=document.getElementById("settingsCloseBtn");Se=document.getElementById("debugPanel"),Mn=document.getElementById("debugPanelHandle"),sr=document.getElementById("debugCloseBtn"),cl=document.getElementById("debugContent"),ui=document.getElementById("viewModeToggle"),vs=document.getElementById("rayModeToggle"),sl=document.getElementById("raySegmentOption"),ll=document.getElementById("rayRightOption"),rl=document.getElementById("rayLeftOption"),qr=document.getElementById("styleEdgesRow"),Hn=document.getElementById("viewModeMenuContainer"),Gi=document.getElementById("rayModeMenuContainer"),ks=document.getElementById("hideButton"),Es=document.getElementById("deletePoint"),_n=document.getElementById("copyStyleBtn"),Ut=document.getElementById("multiMoveBtn"),ws=document.getElementById("multiCloneBtn"),xo=document.getElementById("zoomMenu"),bo=xo?.parentElement??null,Mi=bo?.querySelector(".dropdown-menu"),vo=document.getElementById("showHiddenBtn"),ti=document.getElementById("showMeasurementsBtn"),lr=document.getElementById("copyImageBtn"),rr=document.getElementById("saveImageBtn"),ar=document.getElementById("exportJsonBtn"),dr=document.getElementById("importJsonBtn"),fn=document.getElementById("importJsonInput"),ur=document.getElementById("selectDefaultFolderBtn"),Hi=document.getElementById("clearDefaultFolderBtn"),fo=document.getElementById("defaultFolderPath"),cr=document.getElementById("clearAll"),ko=document.getElementById("themeDark"),al=document.getElementById("undo"),dl=document.getElementById("redo"),ln=document.getElementById("styleMenuContainer"),ul=document.getElementById("styleMenu"),pn=ln?.querySelector(".dropdown-menu"),Dt=document.getElementById("eraserBtn"),Dt&&Dt.addEventListener("click",()=>{nn=!nn,Dt?.classList.toggle("active",nn),Dt?.setAttribute("aria-pressed",nn?"true":"false"),nn&&ln&&(ln.style.display="inline-flex")}),Gr=document.getElementById("styleColorRow"),Vr=document.getElementById("styleWidthRow"),fl=document.getElementById("styleTypeRow"),pl=document.getElementById("styleTypeInline"),vl=document.getElementById("styleRayGroup"),kl=document.getElementById("styleTickGroup"),Ot=document.getElementById("styleTickToggle"),El=document.getElementById("styleTypeGap"),Ur=document.getElementById("styleArcRow"),Yr=document.getElementById("styleHideRow"),yl=document.getElementById("labelTextRow"),hl=document.getElementById("labelFontRow"),gl=document.getElementById("labelGreekRow"),Oi=document.getElementById("labelGreekToggle"),Ls=document.getElementById("labelGreekShift"),Eo=document.getElementById("labelScriptToggle"),fe=document.getElementById("styleColor"),le=document.getElementById("styleWidth"),zi=document.getElementById("lineWidthDecrease"),Ni=document.getElementById("lineWidthIncrease"),ml=document.getElementById("lineWidthValue"),he=document.getElementById("styleType"),gt=document.getElementById("labelText"),Fi=document.getElementById("labelFontDecrease"),$i=document.getElementById("labelFontIncrease"),Ll=document.getElementById("labelFontSizeValue"),ri=Array.from(document.querySelectorAll(".arc-count-btn")),xn=document.getElementById("rightAngleBtn"),on=document.getElementById("exteriorAngleBtn"),Yt=document.getElementById("angleRadiusDecreaseBtn"),Xt=document.getElementById("angleRadiusIncreaseBtn"),xl=Array.from(document.querySelectorAll(".color-btn:not(.custom-color-btn)")),Ss=document.getElementById("customColorBtn"),bl=Array.from(document.querySelectorAll(".type-btn")),os=Array.from(document.querySelectorAll(".label-greek-btn")),yn=document.getElementById("ngonModal"),tr=document.getElementById("ngonCloseBtn"),nr=document.getElementById("ngonConfirmBtn"),Pn=document.getElementById("ngonInput"),ir=Array.from(document.querySelectorAll(".ngon-preset-btn")),tr?.addEventListener("click",()=>{yn&&(yn.style.display="none"),ot!==null&&(ot=null,M=null,P())});const i=()=>{if(Pn){const d=parseInt(Pn.value,10);Number.isFinite(d)&&d>=3&&(Ri=d,gr(),yn&&(yn.style.display="none"))}};nr?.addEventListener("click",i),Pn?.addEventListener("keydown",d=>{d.key==="Enter"&&i()}),ir.forEach(d=>{d.addEventListener("click",()=>{const y=parseInt(d.dataset.n||"5",10);Ri=y,Pn&&(Pn.value=String(y)),gr(),yn&&(yn.style.display="none")})}),va(),os=Array.from(document.querySelectorAll(".label-greek-btn")),mo=fe,mo&&(mo.value=X.defaultStroke),or?.addEventListener("click",()=>{li=!li,Ol(),P()}),sr?.addEventListener("click",()=>{li=!1,Ol()});const o=d=>{if(!Se||!Mn)return;const y=d.target;if(y&&y.closest("#debugCloseBtn"))return;Mn.setPointerCapture(d.pointerId);const b=Se.getBoundingClientRect();ft||(ft={x:b.left,y:b.top}),yt={pointerId:d.pointerId,start:{x:d.clientX,y:d.clientY},panelStart:{x:ft.x,y:ft.y}},Se.classList.add("debug-panel--dragging"),d.preventDefault()};Mn?.addEventListener("pointerdown",o),Mn?.addEventListener("pointermove",d=>{if(!yt||yt.pointerId!==d.pointerId||!Se)return;const y=d.clientX-yt.start.x,b=d.clientY-yt.start.y,h=Se.getBoundingClientRect(),v=h.width||Se.offsetWidth||320,k=h.height||Se.offsetHeight||240,B=Math.max(Qt.x,window.innerWidth-v-Qt.x),E=Math.max(ho,window.innerHeight-k-Qt.y);ft={x:Ge(yt.panelStart.x+y,Qt.x,B),y:Ge(yt.panelStart.y+b,ho,E)},Bc()});const l=d=>{!yt||yt.pointerId!==d.pointerId||Zl(d.pointerId)};if(Mn?.addEventListener("pointerup",l),Mn?.addEventListener("pointercancel",l),!ce||!g)return;window.addEventListener("resize",hr),window.addEventListener("resize",()=>{li&&Kl()}),hr(),Wt<0&&J(),ce.addEventListener("pointerdown",aa),ce.addEventListener("pointermove",d=>{if(d.pointerType==="touch"&&(uc(d),In.size>=2&&!dt&&_l(),dt)){Ca(),d.preventDefault();return}if(V==="handwriting"){ra(d);return}if(V==="multiselect"&&De&&d.buttons===1){const{x:h,y:v}=Xo(d.clientX,d.clientY);ze={x:h,y:v},P();return}const{x:y,y:b}=Ps(d);if(Ht=null,di){const{center:h,dir:v,vectors:k,baseHalf:B,lines:E}=di,w={x:y-h.x,y:b-h.y},S=w.x*v.x+w.y*v.y,L=Math.max(5,Math.abs(S))/Math.max(B,1e-4),A=new Set;k.forEach(({idx:R,vx:T,vy:C})=>{const D=s.points[R];if(!D)return;const N={x:h.x+T*L,y:h.y+C*L},O=xt(R,N);s.points[R]={...D,...O},A.add(R)}),E.forEach(R=>Xl(R)),A.forEach(R=>{ve(R),Mt(R)}),Ke=!0,P()}else if(Pe&&V==="move"){const h=y-Pe.start.x,v=b-Pe.start.y,k=h*ne,B=v*ne;switch(Pe.kind){case"point":{const E=s.points[Pe.id];E?.label&&(E.label={...E.label,offset:{x:Pe.initialOffset.x+k,y:Pe.initialOffset.y+B}});break}case"line":{const E=s.lines[Pe.id];E?.label&&(E.label={...E.label,offset:{x:Pe.initialOffset.x+k,y:Pe.initialOffset.y+B}});break}case"angle":{const E=s.angles[Pe.id];E?.label&&(E.label={...E.label,offset:{x:Pe.initialOffset.x+k,y:Pe.initialOffset.y+B}});break}case"free":{const E=s.labels[Pe.id];E&&(s.labels[Pe.id]={...E,pos:{x:Pe.initialOffset.x+h,y:Pe.initialOffset.y+v}});break}}Ke=!0,P()}else if(ol&&V==="multiselect"){const h=y-_e.x,v=b-_e.y,k=new Set;vt.forEach(B=>{const E=s.lines[B];E&&(E.points.forEach(w=>k.add(w)),s.points.forEach((w,S)=>{w&&w.parent_refs.some(I=>I.kind==="line"&&I.id===E.id)&&k.add(S)}))}),ct.forEach(B=>{const E=s.circles[B];E&&(E.center!==null&&k.add(E.center),E.radius_point!==null&&k.add(E.radius_point),E.points.forEach(w=>{k.add(w)}))}),bt.forEach(B=>{k.add(B)}),k.forEach(B=>{const E=s.points[B];E&&(s.points[B]={...E,x:E.x+h,y:E.y+v})}),At.forEach(B=>{const E=s.inkStrokes[B];E&&(s.inkStrokes[B]={...E,points:E.points.map(w=>({...w,x:w.x+h,y:w.y+v}))})}),_e={x:y,y:b},Ke=!0,P()}else if(ht&&V==="move"){const h=y-_e.x,v=b-_e.y,k=new Set;let B=!1;if(re!==null){const E=s.inkStrokes[re];E&&(s.inkStrokes[re]={...E,points:E.points.map(w=>({...w,x:w.x+h,y:w.y+v}))},_e={x:y,y:b},Ke=!0,P());return}if(Vt&&H!==null&&Vt.circleIdx===H&&M===null&&q.size===0){const E=s.circles[H];if(E&&Lt(E))return;Vt.originals.forEach((w,S)=>{const I=s.points[S];I&&(s.points[S]={...I,x:w.x+h,y:w.y+v},k.add(S))}),k.size>0&&(k.forEach(S=>{ve(S),Mt(S)}),Zn(Vt.circleIdx),new Set(k).forEach(S=>{Sr(S).forEach(I=>{I!==Vt.circleIdx&&Zn(I)})}),Vt.dependentLines&&Vt.dependentLines.forEach((S,I)=>{kr(I,S),tt(I)}),Ke=!0,P());return}if(M!==null){const E=s.points[M];if(!gn(E))return;E?.construction_kind;const w=Nl(E),S=w?it(w.id):null,I=s.circles.findIndex(T=>T.radius_point===M);if(I!==-1){const T=s.circles[I],C=s.points[T.center];if(!C)return;const D={x:E.x+h,y:E.y+v};let N=D.x-C.x,O=D.y-C.y,F=Math.hypot(N,O);if(F<=1e-6&&(N=E.x-C.x,O=E.y-C.y,F=Math.hypot(N,O)),F<=1e-6)return;const Y=F,Q={x:N/F,y:O/F},W={x:C.x+Q.x*Y,y:C.y+Q.y*Y};s.points[M]={...E,...W},k.add(M);const te=tl(T).filter(K=>K!==M);te.forEach(K=>{const ee=s.points[K];if(!ee)return;const me=Math.atan2(ee.y-C.y,ee.x-C.x);if(!Number.isFinite(me))return;const Ve={x:C.x+Math.cos(me)*Y,y:C.y+Math.sin(me)*Y};s.points[K]={...ee,...Ve},k.add(K)}),_e={x:y,y:b},Ke=!0,k.forEach(K=>{ve(K),Mt(K)}),Zn(I),new Set([M,...te]).forEach(K=>{Sr(K).forEach(ee=>{ee!==I&&Zn(ee)})}),$t(M).forEach(K=>{const ee=s.lines[K];if(!ee)return;(M===ee.points[0]||M===ee.points[ee.points.length-1])&&(Er(K),tt(K))}),P();return}const L=ni(M);if(L.length){const T=L.filter(C=>s.circles[C]?.circle_kind==="center-radius");if(T.length){const C={x:E.x,y:E.y},D={x:E.x+h,y:E.y+v};bn||(bn=new Map);const N=[];T.forEach(F=>{const Y=s.circles[F];if(!Y)return;const Q=s.points[Y.radius_point];let W=0;if(Q&&(W=Math.hypot(Q.x-C.x,Q.y-C.y)),!(W>0)){const se=Y.points.find(K=>{const ee=s.points[K];return!!ee&&(ee.x!==C.x||ee.y!==C.y)});if(se!==void 0){const K=s.points[se];W=Math.hypot(K.x-C.x,K.y-C.y)}}if(W>0||(W=lt(Y)),!(W>0))return;const te=bn.get(F),U=te??new Map;te||bn.set(F,U),Y.points.forEach(se=>{if(U.has(se))return;const K=s.points[se];K&&U.set(se,Math.atan2(K.y-C.y,K.x-C.x))}),Q&&U.set(Y.radius_point,Math.atan2(Q.y-C.y,Q.x-C.x)),N.push({circleIdx:F,angleMap:U,fallbackRadius:W})});let O=D;if(S!==null&&(O=po(S,D)),O=xt(M,O),s.points[M]={...E,...O},k.add(M),N.forEach(({circleIdx:F,angleMap:Y,fallbackRadius:Q})=>{const W=s.circles[F];if(!W)return;const te=s.points[W.radius_point];let U=lt(W);U>0||(U=Q),U>0&&(te&&Y.set(W.radius_point,Math.atan2(te.y-D.y,te.x-D.x)),Y.forEach((se,K)=>{if(K===M||K===W.radius_point)return;const ee=s.points[K];if(!ee)return;const me={x:D.x+Math.cos(se)*U,y:D.y+Math.sin(se)*U};s.points[K]={...ee,...me},k.add(K)}))}),M!==null){const F=M;$t(F).forEach(Q=>{const W=s.lines[Q];if(!W||!W.defining_points.includes(F))return;const te=W.defining_points.map(Fe=>s.points[Fe]).filter(Boolean);if(te.length<2)return;const[U,se]=te,K=se.x-U.x,ee=se.y-U.y,me=Math.hypot(K,ee);if(me<1e-9)return;const Ve={x:K/me,y:ee/me};W.points.forEach(Fe=>{if(W.defining_points.includes(Fe))return;const ke=s.points[Fe];if(!ke)return;const rt=(ke.x-U.x)*Ve.x+(ke.y-U.y)*Ve.y,Mc={x:U.x+Ve.x*rt,y:U.y+Ve.y*rt};s.points[Fe]={...ke,...Mc},k.add(Fe)}),tt(Q)})}_e={x:y,y:b},Ke=!0,k.forEach(F=>{ve(F),Mt(F)}),T.forEach(F=>Zn(F)),P();return}L.forEach(C=>{const D=s.circles[C];if(!D)return;const N=s.points[D.center];N&&(s.points[D.center]={...N,x:N.x+h,y:N.y+v},k.add(D.center),tl(D).forEach(O=>{const F=s.points[O];F&&(s.points[O]={...F,x:F.x+h,y:F.y+v},k.add(O))}))}),_e={x:y,y:b},Ke=!0,k.forEach(C=>{ve(C),Mt(C)}),L.forEach(C=>Zn(C)),P();return}const A=$t(M),R=_!==null&&A.includes(_)?_:A[0];if(R!==void 0){const T=s.lines[R],C=T.defining_points.includes(M),D=Gt(M,R);if(C||D){if((!$e||$e.lineIdx!==R)&&($e=cc(M),$e&&$e.lineIdx!==R)){const Q=s.lines[R];if(Q&&Q.points.length>=2){const W=s.points[Q.points[0]],te=s.points[Q.points[Q.points.length-1]];if(W&&te){const U=qe({x:te.x-W.x,y:te.y-W.y}),se=Math.hypot(te.x-W.x,te.y-W.y);if(se>0){const K=Q.points.map(ee=>{const me=s.points[ee];return me?((me.x-W.x)*U.x+(me.y-W.y)*U.y)/se:0});$e={lineIdx:R,fractions:K}}}}}const N=M===T.points[0]?T.points[T.points.length-1]:T.points[0],O=s.points[N],F={x:E.x+h,y:E.y+v};let Y=F;if(S!==null&&(Y=po(S,Y)),Y=xt(M,Y),s.points[M]={...E,...Y},k.add(M),D){const Q=T.defining_points.map(W=>s.points[W]).filter(Boolean);if(Q.length>=2){const[W,te]=Q,U=qe({x:te.x-W.x,y:te.y-W.y});Math.hypot(te.x-W.x,te.y-W.y)>0&&T.points.forEach(K=>{if(T.defining_points.includes(K))return;const ee=s.points[K];if(!ee)return;const me=(ee.x-W.x)*U.x+(ee.y-W.y)*U.y,Ve={x:W.x+U.x*me,y:W.y+U.y*me};s.points[K]={...ee,...Ve},k.add(K)})}}if(O){const Q=F.x-O.x,W=F.y-O.y,te=Math.hypot(Q,W);if(te>0){const U=Math.max(1e-4,te*Jl);let se=null;if(Math.abs(W)<=U?se="y":Math.abs(Q)<=U&&(se="x"),se){const K=se==="y"?1-Math.min(Math.abs(W)/U,1):1-Math.min(Math.abs(Q)/U,1);K>=un&&(Ht={lineIdx:R,axis:se==="y"?"horizontal":"vertical",strength:Math.min(1,Math.max(0,(K-un)/(1-un)))});const ee=Gs(K);if(ee>0){const me=se==="y"?O.y:O.x;T.points.filter(Fe=>{const ke=s.points[Fe];return!(!ke||!gn(ke)||ni(Fe).length>0)}).forEach(Fe=>{const ke=s.points[Fe];if(ke)if(se==="y"){const rt=ke.y*(1-ee)+me*ee;rt!==ke.y&&(s.points[Fe]={...ke,y:rt},k.add(Fe))}else{const rt=ke.x*(1-ee)+me*ee;rt!==ke.x&&(s.points[Fe]={...ke,x:rt},k.add(Fe))}})}}}}Er(R),tt(R),Zt(R),Jt(R)}else if(T.points.length>=2){const N=T.defining_points[0],O=T.defining_points[1],F=s.points[N],Y=s.points[O];if(F&&Y){const Q=qe({x:Y.x-F.x,y:Y.y-F.y}),W=Math.hypot(Y.x-F.x,Y.y-F.y)||1,te={x:E.x+h,y:E.y+v};let U=((te.x-F.x)*Q.x+(te.y-F.y)*Q.y)/W;const se=T.leftRay&&!T.leftRay.hidden,K=T.rightRay&&!T.rightRay.hidden;se||(U=Math.max(0,U)),K||(U=Math.min(1,U));const ee={x:F.x+Q.x*U*W,y:F.y+Q.y*U*W},me={x:ee.x-E.x,y:ee.y-E.y};if(me.x!==0||me.y!==0){const Fe=new Set;A.forEach(ke=>{ke!==R&&(M!==null&&Gt(M,ke)||s.lines[ke]?.points.forEach(rt=>Fe.add(rt)))}),Fe.delete(M),Fe.forEach(ke=>{const rt=s.points[ke];s.points[ke]={...rt,x:rt.x+me.x,y:rt.y+me.y},k.add(ke)})}let Ve=ee;S!==null&&(Ve=po(S??R,Ve)),Ve=xt(M,Ve),s.points[M]={...E,...Ve},k.add(M),tt(R),Zt(R),Jt(R),_e={x:Ve.x,y:Ve.y},B=!0}}if(Ke=!0,k.forEach(N=>{ve(N),Mt(N)}),P(),A.length>1){const N=new Set;A.forEach(O=>{O!==R&&O!==void 0&&O!==null&&N.add(O)}),N.forEach(O=>{tt(O),Zt(O),Jt(O)})}}else{let T={x:E.x+h,y:E.y+v};const C=$t(M);C.find(N=>M!==null&&Gt(M,N))===void 0?T=Dl(M,T):C.forEach(N=>{if(M!==null&&Gt(M,N)){const O=s.lines[N];O&&O.points.forEach(F=>{F!==M&&Gt(F,N)})}}),T=xt(M,T),s.points[M]={...E,...T},k.add(M),C.forEach(N=>{M!==null&&Gt(M,N)&&(tt(N),Zt(N),Jt(N))}),_e={x:y,y:b},Ke=!0,k.forEach(N=>{ve(N),Mt(N)}),P()}}else if(j!==null&&q.size===0){const E=s.polygons[j];if(E){const w=new Set;E.lines.forEach(S=>{s.lines[S]?.points.forEach(L=>w.add(L))}),w.forEach(S=>{const I=s.points[S];if(!I||!gn(I)||ni(S).length>0)return;const L={x:I.x+h,y:I.y+v},A=xt(S,L);s.points[S]={...I,...A},k.add(S)}),E.lines.forEach(S=>{tt(S),Zt(S),Jt(S)}),uo&&uo.polygonIdx===j&&uo.dependentLines.forEach((S,I)=>{kr(I,S),tt(I)})}}else if(_!==null){const E=s.lines[_];if(E){const w=E.points.filter(R=>{const T=s.points[R];return!(!T||!gn(T)||ni(R).length>0)}),S=new Map;let I=null;if(E.points.forEach(R=>{const T=s.points[R];if(!T||!gn(T)||ni(R).length>0)return;const C={x:T.x+h,y:T.y+v},D=Nl(T),O=D&&_!==null&&D.id===s.lines[_].id?C:Dl(R,C),F=xt(R,O);S.set(R,{original:T,pos:F})}),w.length>=2){const R=w[0],T=w[w.length-1],C=S.get(R)?.pos,D=S.get(T)?.pos;if(C&&D){const N=D.x-C.x,O=D.y-C.y,F=Math.hypot(N,O),Y=Math.max(1e-4,F*Jl);if(Math.abs(O)<=Y){let Q=0,W=0;if(w.forEach(te=>{const U=S.get(te)?.pos;U&&(Q+=U.y,W+=1)}),W>0){const te=Q/W,U=1-Math.min(Math.abs(O)/Y,1);U>=un&&(I={axis:"horizontal",strength:Math.min(1,Math.max(0,(U-un)/(1-un)))});const se=Gs(U);se>0&&w.forEach(K=>{const ee=S.get(K);ee&&(ee.pos={...ee.pos,y:ee.pos.y*(1-se)+te*se})})}}else if(Math.abs(N)<=Y){let Q=0,W=0;if(w.forEach(te=>{const U=S.get(te)?.pos;U&&(Q+=U.x,W+=1)}),W>0){const te=Q/W,U=1-Math.min(Math.abs(N)/Y,1);U>=un&&(I={axis:"vertical",strength:Math.min(1,Math.max(0,(U-un)/(1-un)))});const se=Gs(U);se>0&&w.forEach(K=>{const ee=S.get(K);ee&&(ee.pos={...ee.pos,x:ee.pos.x*(1-se)+te*se})})}}}}_!==null&&I&&(Ht={lineIdx:_,...I});const L=new Map,A=new Set(w);s.lines.forEach((R,T)=>{if(T===_)return;if(R.defining_points.some(D=>A.has(D))){const D=R.defining_points[0],N=R.defining_points[1],O=s.points[D],F=s.points[N];if(O&&F){const Y=qe({x:F.x-O.x,y:F.y-O.y}),Q=Math.hypot(F.x-O.x,F.y-O.y);if(Q>0){const W=R.points.map(te=>{const U=s.points[te];return U?((U.x-O.x)*Y.x+(U.y-O.y)*Y.y)/Q:0});L.set(T,W)}}}}),S.forEach((R,T)=>{s.points[T]={...R.original,...R.pos},k.add(T)}),L.forEach((R,T)=>{const C=s.lines[T],D=C.defining_points[0],N=C.defining_points[1],O=s.points[D],F=s.points[N];if(O&&F){const Y=qe({x:F.x-O.x,y:F.y-O.y}),Q=Math.hypot(F.x-O.x,F.y-O.y);Q>0&&(C.points.forEach((W,te)=>{if(C.defining_points.includes(W))return;const U=R[te],se={x:O.x+Y.x*U*Q,y:O.y+Y.y*U*Q},K=s.points[W];K&&(s.points[W]={...K,...se},k.add(W))}),tt(T),Zt(T),Jt(T))}}),tt(_),Zt(_),Jt(_)}}(typeof B>"u"||!B)&&(_e={x:y,y:b}),Ke=!0,k.forEach(E=>{ve(E),Mt(E)}),M!==null&&$t(M).forEach(w=>{if(M!==null&&Gt(M,w)){const I=s.lines[w];I&&I.points.length>=2&&I.points.forEach(L=>{if(L!==M&&!Gt(L,w)){const A=s.points[L];if(A&&gn(A)){const R=po(w,{x:A.x,y:A.y});(Math.abs(R.x-A.x)>1e-6||Math.abs(R.y-A.y)>1e-6)&&(s.points[L]={...A,...R},ve(L),Mt(L))}}})}}),P()}else if(Qi&&V==="move"&&No){const h=d.clientX-xs.x,v=d.clientY-xs.y;Oe={x:bs.x+h,y:bs.y+v},Ki=!0,P()}});const r=d=>{if(d.pointerType==="touch"){Ta(d.pointerId),In.size>=2&&!dt&&_l();try{ce.releasePointerCapture(d.pointerId)}catch{}}if(V==="multiselect"&&De&&ze){const b=Math.min(De.x,ze.x),h=Math.min(De.y,ze.y),v=Math.max(De.x,ze.x),k=Math.max(De.y,ze.y);(Math.abs(v-b)>5||Math.abs(k-h)>5)&&(Qc({x1:b,y1:h,x2:v,y2:k}),$()),De=null,ze=null,P()}ca(d.pointerId),di=null,ht=!1,ol=!1,$e=null,Pe=null,bn=null,Vt=null,uo=null,Qi=!1,No=null;const y=Ht;Ht=null,y&&(yd(y.lineIdx,y.axis),Ke=!0,P()),(Ke||Ki)&&(J(),Ke=!1,Ki=!1)};ce.addEventListener("pointerup",r),ce.addEventListener("pointercancel",r),ce.addEventListener("wheel",Ra,{passive:!1}),kn?.addEventListener("click",()=>ie("add")),kn?.addEventListener("dblclick",d=>{d.preventDefault(),_t("add")}),Nn(kn,"add"),En?.addEventListener("click",()=>ie("segment")),En?.addEventListener("dblclick",d=>{d.preventDefault(),_t("segment")}),Nn(En,"segment"),Io?.addEventListener("click",()=>ie("parallel")),Bo?.addEventListener("click",()=>ie("perpendicular")),Mo?.addEventListener("click",()=>ie("circleThree")),Po?.addEventListener("click",()=>ie("triangleUp")),_o?.addEventListener("click",()=>ie("square")),To?.addEventListener("click",()=>ie("polygon")),zo?.addEventListener("click",()=>ie("handwriting")),si?.addEventListener("click",()=>ie("label")),si?.addEventListener("dblclick",d=>{d.preventDefault(),_t("label")}),Nn(si,"label"),Co?.addEventListener("click",()=>ie("angle")),Ro?.addEventListener("click",()=>ie("bisector")),Ao?.addEventListener("click",()=>ie("midpoint")),Wi?.addEventListener("click",()=>ie("symmetric")),Wi?.addEventListener("dblclick",d=>{d.preventDefault(),et=et==="symmetric"?null:et,ie("symmetric")}),qi?.addEventListener("click",()=>ie("parallelLine")),qi?.addEventListener("dblclick",d=>{d.preventDefault(),_t("parallelLine")}),An?.addEventListener("click",()=>ie("tangent")),An?.addEventListener("dblclick",d=>{d.preventDefault(),_t("tangent")}),Dn?.addEventListener("click",()=>ie("perpBisector")),Dn?.addEventListener("dblclick",d=>{d.preventDefault(),_t("perpBisector")}),Do?.addEventListener("click",()=>{ie("ngon")});const a=document.getElementById("modeCircle");a?.addEventListener("click",()=>ie("circle")),a?.addEventListener("dblclick",d=>{d.preventDefault(),_t("circle")}),Nn(a,"circle"),en?.addEventListener("click",()=>{et=null,V!=="move"&&(Ie("move"),st(),$())}),Lo?.addEventListener("click",()=>ie("multiselect")),zi?.addEventListener("click",()=>Ir(-1)),Ni?.addEventListener("click",()=>Ir(1)),xl.forEach(d=>{d.addEventListener("click",()=>{const y=d.dataset.color;!y||!fe||(fe.value=y,Tl(y),Ti(),dn())})}),Ss?.addEventListener("click",()=>{fe?.click()}),ri.forEach(d=>{d.addEventListener("click",()=>{ri.forEach(b=>b.classList.remove("active")),d.classList.add("active");const y=Number(d.dataset.count)||1;if(xn?.classList.remove("active"),G!==null){const b=s.angles[G];s.angles[G]={...b,style:{...b.style,arcCount:y,right:!1}},P(),J()}})}),xn?.addEventListener("click",()=>{if(!xn)return;const d=xn.classList.toggle("active");if(d&&ri.forEach(y=>y.classList.remove("active")),G!==null){const y=s.angles[G],b=d?1:y.style.arcCount??1;s.angles[G]={...y,style:{...y.style,right:d,arcCount:b}},P(),J()}}),on?.addEventListener("click",()=>{if(!on)return;const d=on.classList.toggle("active");if(on.setAttribute("aria-pressed",d?"true":"false"),G!==null){const y=s.angles[G];s.angles[G]={...y,style:{...y.style,exterior:d}},P(),J()}}),Yt?.addEventListener("click",()=>wr(-1)),Xt?.addEventListener("click",()=>wr(1)),bl.forEach(d=>{d.addEventListener("click",()=>{const y=d.dataset.type;he&&y&&(he.value=y),Ti(),dn()})}),ui?.addEventListener("click",od),document.getElementById("viewEdgesOption")?.addEventListener("click",()=>is("edges")),document.getElementById("viewVerticesOption")?.addEventListener("click",()=>is("vertices")),document.getElementById("viewCircleLineOption")?.addEventListener("click",()=>is("edges")),document.getElementById("viewCirclePointsOption")?.addEventListener("click",()=>is("vertices")),vs?.addEventListener("click",sd),document.getElementById("rayRightOption")?.addEventListener("click",()=>Qs("right")),document.getElementById("rayLeftOption")?.addEventListener("click",()=>Qs("left")),document.getElementById("raySegmentOption")?.addEventListener("click",()=>Qs("segment")),ko?.addEventListener("click",()=>{mc(Ft==="dark"?"light":"dark")}),e?.addEventListener("click",()=>{if(t){t.style.display="flex",nc();const d=document.getElementById("precisionLength"),y=document.getElementById("precisionAngle");d&&(d.value=cn.toString()),y&&(y.value=wn.toString())}}),n?.addEventListener("click",()=>{t&&(Ji(),t.style.display="none")});const c=document.getElementById("exportConfigBtn"),u=document.getElementById("importConfigBtn"),f=document.getElementById("importConfigInput");c?.addEventListener("click",()=>{ma()}),u?.addEventListener("click",()=>{f?.click()}),f?.addEventListener("change",d=>{const y=d.target.files?.[0];if(!y)return;const b=new FileReader;b.onload=h=>{const v=h.target?.result;if(v){const k=xa(v);ka(k)}},b.readAsText(y),d.target.value=""});const p=document.querySelectorAll(".modal-tabs .tab-btn");p.forEach(d=>{d.addEventListener("click",()=>{const y=d.dataset.tab;if(!y)return;p.forEach(v=>v.classList.remove("active")),d.classList.add("active"),document.querySelectorAll(".tab-content").forEach(v=>{v.classList.remove("active")});const h=document.getElementById(`tab${y.charAt(0).toUpperCase()+y.slice(1)}`);h&&h.classList.add("active")})});const m=document.getElementById("precisionLength"),x=document.getElementById("precisionAngle");m&&(m.value=cn.toString(),m.addEventListener("change",()=>{const d=parseInt(m.value,10);!isNaN(d)&&d>=0&&d<=5&&(cn=d,localStorage.setItem("measurementPrecisionLength",d.toString()),wt&&P())})),x&&(x.value=wn.toString(),x.addEventListener("change",()=>{const d=parseInt(x.value,10);!isNaN(d)&&d>=0&&d<=5&&(wn=d,localStorage.setItem("measurementPrecisionAngle",d.toString()),wt&&P())})),t?.addEventListener("click",d=>{d.target===t&&(Ji(),t.style.display="none")}),t?.addEventListener("touchstart",d=>{const y=t.querySelector(".modal-content");y&&d.target instanceof Node&&y.contains(d.target)&&d.stopPropagation()},{passive:!0}),t?.addEventListener("touchmove",d=>{const y=t.querySelector(".modal-content"),b=t.querySelector(".modal-body");if(b&&d.target instanceof Node&&b.contains(d.target)){const h=b.scrollTop===0,v=d.touches[0].clientY>d.target.lastTouchY;h&&v&&d.preventDefault()}else y&&d.target instanceof Node&&y.contains(d.target)&&d.preventDefault()},{passive:!1}),ur?.addEventListener("click",async()=>{try{if(!("showDirectoryPicker"in window)){window.alert("Ta funkcja nie jest dostÄ™pna w Twojej przeglÄ…darce.");return}const d=await window.showDirectoryPicker({mode:"readwrite"});mt=d,await ls(d),_i()}catch(d){d.name!=="AbortError"&&console.error("Failed to select folder:",d)}}),Hi?.addEventListener("click",async()=>{mt=null,await ls(null),_i()}),(async()=>{const d=await Zc();if(d)try{const y=await d.queryPermission({mode:"readwrite"});(y==="granted"||y==="prompt")&&(mt=d)}catch(y){console.warn("Failed to verify folder permissions:",y)}_i()})(),_i(),ks?.addEventListener("click",()=>{if(yi()){bt.forEach(d=>{const y=s.points[d];y&&(s.points[d]={...y,style:{...y.style,hidden:!y.style.hidden}})}),vt.forEach(d=>{s.lines[d]&&(s.lines[d].hidden=!s.lines[d].hidden)}),ct.forEach(d=>{s.circles[d]&&(s.circles[d].hidden=!s.circles[d].hidden)}),kt.forEach(d=>{const y=s.angles[d];y&&(s.angles[d]={...y,hidden:!y.hidden})}),Tt.forEach(d=>{s.polygons[d]?.lines.forEach(b=>{s.lines[b]&&(s.lines[b].hidden=!s.lines[b].hidden)})}),At.forEach(d=>{const y=s.inkStrokes[d];y&&(s.inkStrokes[d]={...y,hidden:!y.hidden})}),P(),$(),J();return}if(re!==null){const d=s.inkStrokes[re];d&&(s.inkStrokes[re]={...d,hidden:!d.hidden})}else{if(z)return;if(j!==null)s.polygons[j]?.lines.forEach(y=>{s.lines[y]&&(s.lines[y].hidden=!s.lines[y].hidden)});else if(_!==null)s.lines[_].hidden=!s.lines[_].hidden;else if(H!==null){if(We&&(s.circles[H].hidden=!s.circles[H].hidden),Re){const d=s.circles[H],y=new Set;d.center!==null&&y.add(d.center),d.radius_point!==null&&y.add(d.radius_point),d.defining_parents.forEach(b=>{const h=s.points.findIndex(v=>v.id===b);h!==-1&&y.add(h)}),y.forEach(b=>{const h=s.points[b];h&&(s.points[b]={...h,style:{...h.style,hidden:!h.style.hidden}})})}}else if(G!==null){const d=s.angles[G];d&&(s.angles[G]={...d,hidden:!d.hidden})}else if(M!==null){const d=s.points[M];s.points[M]={...d,style:{...d.style,hidden:!d.style.hidden}}}}P(),$(),J()}),_n?.addEventListener("click",()=>{if(et=null,Ie("move"),fi&&jo(),Ce)Ce=!1,Ae=null,$();else{const d=Il();d&&(Ae=d,Ce=!0,$())}}),Ut?.addEventListener("click",()=>{Di?(Di=!1,Ut?.classList.remove("active"),Ut?.setAttribute("aria-pressed","false")):(Di=!0,Ut?.classList.add("active"),Ut?.setAttribute("aria-pressed","true"))}),ws?.addEventListener("click",()=>{if(!yi())return;const d=new Set(vt),y=new Set(bt);Tt.forEach(I=>{const L=s.polygons[I];L&&L.lines.forEach(A=>d.add(A))}),d.forEach(I=>{const L=s.lines[I];L&&L.points.forEach(A=>y.add(A))}),ct.forEach(I=>{const L=s.circles[I];L&&(y.add(L.center),L.radius_point!==void 0&&y.add(L.radius_point),L.points.forEach(A=>y.add(A)))}),kt.forEach(I=>{const L=s.angles[I];L&&y.add(L.vertex)});const b=new Map;y.forEach(I=>{const L=s.points[I];if(L){let A=L.midpoint?{...L.midpoint}:void 0,R=L.symmetric?{...L.symmetric}:void 0;const T={...L,id:Je("point",s),midpoint:A,symmetric:R};s.points.push(T);const C=s.points.length-1;b.set(I,C),Ee(s,"point",T.id,C)}});const h=new Map;d.forEach(I=>{const L=s.lines[I];if(L){const A=L.points.map(O=>b.get(O)??O),R=[b.get(L.defining_points[0])??L.defining_points[0],b.get(L.defining_points[1])??L.defining_points[1]];let T=L.parallel?{...L.parallel}:void 0,C=L.perpendicular?{...L.perpendicular}:void 0;if(T){const O=Le(T.throughPoint),F=Le(T.helperPoint),Y=it(T.referenceLine);O!==null&&b.has(O)&&(T.throughPoint=s.points[b.get(O)].id),F!==null&&b.has(F)&&(T.helperPoint=s.points[b.get(F)].id),Y!==null&&h.has(Y)&&(T.referenceLine=s.lines[h.get(Y)].id)}if(C){const O=Le(C.throughPoint),F=Le(C.helperPoint),Y=it(C.referenceLine);O!==null&&b.has(O)&&(C.throughPoint=s.points[b.get(O)].id),F!==null&&b.has(F)&&(C.helperPoint=s.points[b.get(F)].id),Y!==null&&h.has(Y)&&(C.referenceLine=s.lines[h.get(Y)].id)}const D={...L,id:Je("line",s),points:A,defining_points:R,parallel:T,perpendicular:C,segmentStyles:L.segmentStyles?.map(O=>({...O})),segmentKeys:L.segmentKeys?[...L.segmentKeys]:void 0};s.lines.push(D);const N=s.lines.length-1;h.set(I,N),Ee(s,"line",D.id,N)}}),b.forEach((I,L)=>{const A=s.points[I],R=s.points[L];if(!A||!R)return;const T=R.parent_refs?.map(N=>{if(N.kind==="line"){const O=it(N.id);if(O!==null&&h.has(O)){const F=h.get(O);return{kind:"line",id:s.lines[F].id}}}return N})||[];let C=A.midpoint;if(C){const[N,O]=C.parents,F=Le(N),Y=Le(O),Q=F!==null&&b.has(F)?s.points[b.get(F)].id:N,W=Y!==null&&b.has(Y)?s.points[b.get(Y)].id:O;let te=C.parentLineId;if(te){const U=it(te);U!==null&&h.has(U)&&(te=s.lines[h.get(U)].id)}C={parents:[Q,W],parentLineId:te}}let D=A.symmetric;if(D){const N=Le(D.source),O=N!==null&&b.has(N)?s.points[b.get(N)].id:D.source;let F=D.mirror;if(F.kind==="point"){const Y=Le(F.id);Y!==null&&b.has(Y)&&(F={kind:"point",id:s.points[b.get(Y)].id})}else if(F.kind==="line"){const Y=it(F.id);Y!==null&&h.has(Y)&&(F={kind:"line",id:s.lines[h.get(Y)].id})}D={source:O,mirror:F}}s.points[I]={...A,parent_refs:T,defining_parents:T.map(N=>N.id),midpoint:C,symmetric:D}});const v=new Map;ct.forEach(I=>{const L=s.circles[I];if(L){const A=b.get(L.center)??L.center,R=L.points.map(D=>b.get(D)??D),T={...L,id:Je("circle",s),center:A,points:R,arcStyles:L.arcStyles?.map(D=>({...D}))};L.circle_kind==="center-radius"&&(T.radius_point=L.radius_point!==void 0?b.get(L.radius_point)??L.radius_point:L.radius_point),s.circles.push(T);const C=s.circles.length-1;v.set(I,C),Ee(s,"circle",T.id,C)}});const k=new Map;kt.forEach(I=>{const L=s.angles[I];if(L){const A={...L,id:Je("angle",s),leg1:{...L.leg1,line:h.get(L.leg1.line)??L.leg1.line},leg2:{...L.leg2,line:h.get(L.leg2.line)??L.leg2.line},vertex:b.get(L.vertex)??L.vertex};s.angles.push(A);const R=s.angles.length-1;k.set(I,R),Ee(s,"angle",A.id,R)}});const B=new Map;Tt.forEach(I=>{const L=s.polygons[I];if(L){const A=L.lines.map(C=>h.get(C)??C),R={...L,id:Je("polygon",s),lines:A};s.polygons.push(R);const T=s.polygons.length-1;B.set(I,T),Ee(s,"polygon",R.id,T)}}),At.forEach(I=>{const L=s.inkStrokes[I];if(L){const A=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`ink-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,R={...L,id:A,points:L.points.map(T=>({...T}))};s.inkStrokes.push(R)}});const E=new Set;b.forEach((I,L)=>E.add(I));const w=new Set;h.forEach((I,L)=>w.add(I));const S=20;E.forEach(I=>{const L=s.points[I];L&&(s.points[I]={...L,x:L.x+S,y:L.y+S})}),w.forEach(I=>{tt(I)}),E.forEach(I=>{ve(I)}),bt.clear(),vt.clear(),ct.clear(),kt.clear(),Tt.clear(),At.clear(),M=null,_=null,H=null,G=null,j=null,re=null,q.clear(),Z.clear(),E.forEach(I=>bt.add(I)),w.forEach(I=>vt.add(I)),v.forEach((I,L)=>ct.add(I)),k.forEach((I,L)=>kt.add(I)),B.forEach((I,L)=>Tt.add(I)),Di=!0,Ut?.classList.add("active"),Ut?.setAttribute("aria-pressed","true"),$(),P(),J()}),Es?.addEventListener("click",()=>{let d=!1;if(yi()){At.forEach(E=>{E>=0&&E<s.inkStrokes.length&&(s.inkStrokes[E].hidden=!0,d=!0)});const y=Array.from(bt);y.length>0&&(Bi(y,!0),d=!0);const b=Array.from(vt);if(b.sort((E,w)=>w-E),b.forEach(E=>{const w=s.lines[E];w?.label&&be(w.label),s.lines.splice(E,1),d=!0}),b.length>0){const E=new Map;s.lines.forEach((w,S)=>E.set(S,S)),gi(E),mi(E)}const h=Array.from(ct);h.sort((E,w)=>w-E);const v=new Set;h.forEach(E=>{const w=s.circles[E];if(w){w.label&&be(w.label);const S=w.id;s.lines.some(A=>A.defining_points.includes(w.center))||v.add(w.center),[w.radius_point,...w.points].forEach(A=>{if(Uo(w,A))return;const R=s.points[A];if(!R)return;const T=R.parent_refs.some(D=>D.kind==="circle"&&D.id===S);!s.lines.some(D=>D.defining_points.includes(A))&&(!Lt(w)||T)&&v.add(A)}),s.points=s.points.map((A,R)=>{if(v.has(R))return A;const T=A.parent_refs||[],C=T.filter(D=>!(D.kind==="circle"&&D.id===S));if(C.length!==T.length){const D=Ci(C);return{...A,parent_refs:C,defining_parents:C.map(N=>N.id),construction_kind:D}}return A}),s.circles.splice(E,1),d=!0}}),v.size>0&&Bi(Array.from(v),!0);const k=Array.from(kt);k.sort((E,w)=>w-E),k.forEach(E=>{const w=s.angles[E];w?.label&&be(w.label),s.angles.splice(E,1),d=!0});const B=Array.from(Tt);B.sort((E,w)=>w-E),B.forEach(E=>{const w=s.polygons[E];w&&(w.lines.forEach(S=>{const I=s.lines[S];I?.label&&be(I.label)}),s.polygons.splice(E,1),d=!0)}),ec(),$(),d&&(jt(),P(),J());return}if(re!==null)re>=0&&re<s.inkStrokes.length&&(s.inkStrokes.splice(re,1),re=null,d=!0);else if(z){switch(z.kind){case"point":s.points[z.id]?.label&&(be(s.points[z.id].label),s.points[z.id].label=void 0,d=!0);break;case"line":s.lines[z.id]?.label&&(be(s.lines[z.id].label),s.lines[z.id].label=void 0,d=!0);break;case"angle":s.angles[z.id]?.label&&(be(s.angles[z.id].label),s.angles[z.id].label=void 0,d=!0);break;case"free":z.id>=0&&z.id<s.labels.length&&(s.labels.splice(z.id,1),d=!0);break}z=null,gt&&(gt.value="")}else if(j!==null){const y=s.polygons[j];if(y){const b=new Set(Ic(j));y.lines.forEach(E=>{const w=s.lines[E];w?.label&&be(w.label)});const h=new Map,v=new Set(y.lines),k=[];s.lines.forEach((E,w)=>{v.has(w)?h.set(w,-1):(h.set(w,k.length),k.push(E))}),s.lines=k,gi(h),mi(h);const B=Array.from(b).filter(E=>!Ec(E));B.length?Bi(B,!1):b.forEach(E=>rd(E))}j=null,_=null,M=null,H=null,Z.clear(),d=!0}else if(_!==null){const y=s.lines[_],b=y?.id;if(y?.label&&be(y.label),Re){const h=Array.from(new Set(y.points));if(Bi(h,!0),b){const v=Mr(b),k=ld(b),B=new Set([b,...v,...k]);s.points=s.points.map(E=>{const w=E.parent_refs||[],S=w.filter(I=>!(I.kind==="line"&&B.has(I.id)));if(S.length!==w.length){const I=Ci(S);return{...E,parent_refs:S,defining_parents:S.map(L=>L.id),construction_kind:I}}return E})}}else{const h=_,v=new Map;if(s.lines.forEach((k,B)=>{B===h?v.set(B,-1):v.set(B,B>h?B-1:B)}),s.lines.splice(h,1),gi(v),mi(v),b){const k=Mr(b),B=new Set([b,...k]);s.points=s.points.map(E=>{const w=E.parent_refs||[],S=w.filter(I=>!(I.kind==="line"&&B.has(I.id)));if(S.length!==w.length){const I=Ci(S);return{...E,parent_refs:S,defining_parents:S.map(L=>L.id),construction_kind:I}}return E})}}_=null,M=null,H=null,j=null,d=!0}else if(G!==null){const y=s.angles[G];y?.label&&be(y.label),s.angles.splice(G,1),G=null,_=null,M=null,H=null,j=null,d=!0}else if(H!==null){const y=s.circles[H];if(y)if(Re){const b=new Set;y.center!==null&&b.add(y.center),y.radius_point!==null&&b.add(y.radius_point),y.defining_parents.forEach(h=>{const v=s.points.findIndex(k=>k.id===h);v!==-1&&b.add(v)}),Bi(Array.from(b),!0)}else{y.label&&be(y.label);const b=y.id,h=s.indexById.circle[b];h!==void 0&&s.circles.splice(h,1),s.points=s.points.map(v=>{const k=v.parent_refs||[],B=k.filter(E=>!(E.kind==="circle"&&E.id===b));if(B.length!==k.length){const E=Ci(B);return{...v,parent_refs:B,defining_parents:B.map(w=>w.id),construction_kind:E}}return v})}H=null,_=null,M=null,j=null,d=!0}else M!==null&&(Bi([M],!0),M=null,H=null,j=null,d=!0);d&&Ce&&(Ce=!1,Ae=null),$(),d&&(jt(),P(),J())}),vo?.addEventListener("click",()=>{oe=!oe,ji(),P()}),ti?.addEventListener("click",()=>{if(wt){const d=je.filter(y=>y.pinned);d.forEach(y=>{const b=$l(y);b&&b!=="â€”"&&s.labels.push({text:b,pos:{x:y.pos.x,y:y.pos.y},color:y.color??X.defaultStroke,fontSize:y.fontSize??Te()})}),je=[],to(),wt=!1,ji(),P(),d.length>0&&J()}else wt=!0,Hl(),ji(),P()}),lr?.addEventListener("click",async()=>{try{const d=await Br(),y=window.ClipboardItem;if(!navigator.clipboard||typeof navigator.clipboard.write!="function"||!y)throw new Error("Clipboard API niedostÄ™pne");await navigator.clipboard.write([new y({"image/png":d})]),hn()}catch(d){console.error("Nie udaÅ‚o siÄ™ skopiowaÄ‡ obrazu",d),window.alert("Nie udaÅ‚o siÄ™ skopiowaÄ‡ obrazu do schowka. SprawdÅº uprawnienia przeglÄ…darki.")}}),rr?.addEventListener("click",async()=>{try{const d=await Br(),b=`geometry-${So()}.png`,h=URL.createObjectURL(d),v=document.createElement("a");v.href=h,v.download=b,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(h),hn()}catch(d){console.error("Nie udaÅ‚o siÄ™ zapisaÄ‡ obrazu",d),window.alert("Nie udaÅ‚o siÄ™ przygotowaÄ‡ pliku PNG.")}}),ar?.addEventListener("click",async()=>{try{const d=Ja(),y=JSON.stringify(d,null,2),b=new Blob([y],{type:"application/json"});if("showSaveFilePicker"in window)try{const S={suggestedName:`geometry-${So()}.json`,types:[{description:"JSON File",accept:{"application/json":[".json"]}}]};mt&&(await Kr(mt)?S.startIn=mt:(mt=null,await ls(null),_i()));const L=await(await window.showSaveFilePicker(S)).createWritable();await L.write(b),await L.close(),hn();return}catch(E){if(E.name==="AbortError")return;console.warn("Save via showSaveFilePicker failed, falling back:",E)}const v=`geometry-${So()}.json`,k=URL.createObjectURL(b),B=document.createElement("a");B.href=k,B.download=v,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(k),hn()}catch(d){console.error("Nie udaÅ‚o siÄ™ wyeksportowaÄ‡ JSON",d),window.alert("Nie udaÅ‚o siÄ™ przygotowaÄ‡ pliku JSON.")}}),dr?.addEventListener("click",()=>{fn&&(fn.value="",fn.click())}),fn?.addEventListener("change",async()=>{if(!fn)return;const d=fn.files&&fn.files[0];if(d)try{const y=await d.text(),b=JSON.parse(y);Qa(b),hn()}catch(y){console.error("Nie udaÅ‚o siÄ™ wczytaÄ‡ szkicu",y),window.alert("Nie udaÅ‚o siÄ™ wczytaÄ‡ pliku JSON. SprawdÅº poprawnoÅ›Ä‡ danych.")}finally{fn.value=""}}),cr?.addEventListener("click",()=>{s=Dr(),Qr(),_=null,M=null,H=null,G=null,j=null,re=null,z=null,q.clear(),Z.clear(),Cn=null,Oe={x:0,y:0},ne=1,jo(),hn(),Wo(),qo(),$(),P(),J()}),al?.addEventListener("click",ed),dl?.addEventListener("click",td),xo?.addEventListener("click",nd),ul?.addEventListener("click",id),fe?.addEventListener("input",()=>{fe&&(Tl(fe.value),Ti(),dn())}),le?.addEventListener("input",()=>{Ti(),ai()}),he?.addEventListener("change",Ti),Ot?.addEventListener("click",()=>{Ga()}),gt?.addEventListener("input",()=>{if(!gt||!z)return;const d=gt.value;let y=!1;switch(z.kind){case"point":s.points[z.id]?.label&&(s.points[z.id].label={...s.points[z.id].label,text:d},y=!0);break;case"line":s.lines[z.id]?.label&&(s.lines[z.id].label={...s.lines[z.id].label,text:d},y=!0);break;case"angle":s.angles[z.id]?.label&&(s.angles[z.id].label={...s.angles[z.id].label,text:d},y=!0);break;case"free":s.labels[z.id]&&(s.labels[z.id]={...s.labels[z.id],text:d},y=!0);break}y&&(P(),J())}),os.forEach(d=>{d.addEventListener("click",()=>{if(!gt)return;const y=d.dataset.letter??d.textContent??"";y&&ja(y)})}),Eo&&Eo.addEventListener("click",()=>{z!==null&&(ss=!ss,ss&&(Xi=!0),ds(!0))}),Oi?.addEventListener("click",()=>{z!==null&&(Xi=!Xi,ds(!0))}),Ls?.addEventListener("click",()=>{z!==null&&(wo=!wo,ds(!0))}),Fi?.addEventListener("click",()=>{Lr(-gs)}),$i?.addEventListener("click",()=>{Lr(gs)}),document.addEventListener("click",d=>{Yi&&!bo?.contains(d.target)&&hn(),Vi&&!Hn?.contains(d.target)&&Wo(),Ui&&!Gi?.contains(d.target)&&qo()}),st(),$(),ji(),Ko(),J(),ba(),Ji()}function Sa(){if(V!=="label")return;const e=_!==null||j!==null||M!==null||G!==null;if(!e)return;const t=fe?.value||"#000";let n=!1;if(G!==null&&!s.angles[G].label){const{text:i,seq:o}=Fl();s.angles[G].label={text:i,color:t,offset:io(G),fontSize:Te(),seq:o},n=!0}else if(j!==null){const i=ki(j).filter(o=>!s.points[o]?.label);i.forEach(o=>{const{text:l,seq:r}=pi();s.points[o].label={text:l,color:t,offset:St(o),fontSize:Te(),seq:r}}),i.length&&(n=!0)}else if(_!==null){if(Re){const i=s.lines[_];if(i){const o=i.points.filter(l=>!s.points[l]?.label);o.forEach(l=>{const{text:r,seq:a}=pi();s.points[l].label={text:r,color:t,offset:St(l),fontSize:Te(),seq:a}}),o.length&&(n=!0)}}if(We&&!s.lines[_].label){const{text:i,seq:o}=Is();s.lines[_].label={text:i,color:t,offset:vi(_),fontSize:Te(),seq:o},n=!0}}else if(M!==null&&!s.points[M].label){const{text:i,seq:o}=pi();s.points[M].label={text:i,color:t,offset:St(M),fontSize:Te(),seq:o},n=!0}n&&(P(),J()),(n||e)&&(et===null&&Ie("move"),st(),$())}typeof window<"u"&&window.addEventListener("DOMContentLoaded",wa);function Ue(e){const t=He();for(let n=s.points.length-1;n>=0;n--){const i=s.points[n];if(i.style.hidden&&!oe)continue;const o=i.x-e.x,l=i.y-e.y;if(Math.hypot(o,l)<=t)return n}return null}function $t(e){const t=[];for(let n=0;n<s.lines.length;n++)s.lines[n].points.includes(e)&&t.push(n);return t}function qe(e){const t=Math.hypot(e.x,e.y)||1;return{x:e.x/t,y:e.y/t}}function Li(e,t){const n=t.x-e.x,i=t.y-e.y,o=Math.hypot(n,i)||1,l=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:Math.SQRT1_2,y:Math.SQRT1_2},{x:Math.SQRT1_2,y:-Math.SQRT1_2},{x:-Math.SQRT1_2,y:Math.SQRT1_2},{x:-Math.SQRT1_2,y:-Math.SQRT1_2}],r={x:n/o,y:i/o};let a=l[0],c=-1/0;for(const u of l){const f=u.x*r.x+u.y*r.y;f>c&&(c=f,a=u)}return{x:e.x+a.x*o,y:e.y+a.y*o}}function cc(e){const t=$t(e)[0];if(t===void 0)return null;const n=s.lines[t];if(n.points.length<2)return null;const i=n.defining_points?.[0]??n.points[0],o=n.defining_points?.[1]??n.points[n.points.length-1],l=s.points[i],r=s.points[o];if(!l||!r)return null;const a=qe({x:r.x-l.x,y:r.y-l.y}),c=Math.hypot(r.x-l.x,r.y-l.y);if(c===0)return null;const u=n.points.map(f=>{const p=s.points[f];return p?((p.x-l.x)*a.x+(p.y-l.y)*a.y)/c:0});return{lineIdx:t,fractions:u}}function vr(e){const t=s.lines[e];if(!t||t.points.length<2)return[];const n=t.defining_points?.[0]??t.points[0],i=t.defining_points?.[1]??t.points[t.points.length-1],o=s.points[n],l=s.points[i];if(!o||!l)return[];const r=qe({x:l.x-o.x,y:l.y-o.y}),a=Math.hypot(l.x-o.x,l.y-o.y);return a===0?[]:t.points.map(c=>{const u=s.points[c];return u?((u.x-o.x)*r.x+(u.y-o.y)*r.y)/a:0})}function kr(e,t){const n=s.lines[e];if(!n||n.points.length<2)return;const i=n.defining_points?.[0]??n.points[0],o=n.defining_points?.[1]??n.points[n.points.length-1],l=s.points[i],r=s.points[o];if(!l||!r)return;const a=qe({x:r.x-l.x,y:r.y-l.y}),c=Math.hypot(r.x-l.x,r.y-l.y);if(c===0)return;const u=new Set;t.forEach((f,p)=>{if(p>=n.points.length)return;const m=n.points[p];if(n.defining_points.includes(m))return;const x={x:l.x+a.x*f*c,y:l.y+a.y*f*c};s.points[m]={...s.points[m],...x},u.add(m)}),Xl(e),u.forEach(f=>{ve(f),Mt(f)})}function Er(e){if(!$e||$e.lineIdx!==e)return;const t=s.lines[e];if(t.points.length<2)return;const n=t.defining_points?.[0]??t.points[0],i=t.defining_points?.[1]??t.points[t.points.length-1],o=s.points[n],l=s.points[i];if(!o||!l)return;const r=qe({x:l.x-o.x,y:l.y-o.y}),a=Math.hypot(l.x-o.x,l.y-o.y);if(a===0)return;let c=$e.fractions;if(c.length!==t.points.length){const f=s.points[n],p=s.points[i];if(!f||!p)return;const m=qe({x:p.x-f.x,y:p.y-f.y}),x=Math.hypot(p.x-f.x,p.y-f.y);if(x===0)return;c=t.points.map(d=>{const y=s.points[d];return y?((y.x-f.x)*m.x+(y.y-f.y)*m.y)/x:0})}const u=new Set;c.forEach((f,p)=>{const m=t.points[p];if(p===0||p===t.points.length-1||t.defining_points.includes(m))return;const x={x:o.x+r.x*f*a,y:o.y+r.y*f*a};s.points[m]={...s.points[m],...x},u.add(m)}),Xl(e),u.forEach(f=>{ve(f),Mt(f)})}function Ml(e){const t=[],n=He();for(let i=s.lines.length-1;i>=0;i--){const o=s.lines[i];if(!(o.hidden&&!oe)&&o.points.length>=2){for(let a=0;a<o.points.length-1;a++){const c=s.points[o.points[a]],u=s.points[o.points[a+1]],f=o.segmentStyles?.[a]??o.style;if(!(!c||!u)&&!(f.hidden&&!oe)&&cs(e,c,u)<=n){t.push({line:i,part:"segment",seg:a});break}}const l=s.points[o.points[0]],r=s.points[o.points[o.points.length-1]];if(l&&r){const a=r.x-l.x,c=r.y-l.y,u=Math.hypot(a,c)||1,f={x:a/u,y:c/u},p=(ce.width+ce.height)/(Qe*ne);if(o.leftRay&&!(o.leftRay.hidden&&!oe)){const m={x:l.x-f.x*p,y:l.y-f.y*p};cs(e,l,m)<=n&&t.push({line:i,part:"rayLeft"})}if(o.rightRay&&!(o.rightRay.hidden&&!oe)){const m={x:r.x+f.x*p,y:r.y+f.y*p};cs(e,r,m)<=n&&t.push({line:i,part:"rayRight"})}}}}return t}function qt(e){const t=Ml(e);return t.length?t[0]:null}function jn(e){let t=e;for(;t<0;)t+=Math.PI*2;for(;t>=Math.PI*2;)t-=Math.PI*2;return t}function $o(e,t){return`${e}:${t}`}function Os(e){const[t,n]=e.split(":").map(i=>Number(i));return Number.isFinite(t)&&Number.isFinite(n)?{circle:t,arcIdx:n}:null}function no(e,t){const n=s.circles[e];(!n.arcStyles||n.arcStyles.length!==t)&&(n.arcStyles=Array.from({length:t},()=>({...n.style})))}function Sn(e){const t=s.circles[e];if(!t)return[];const n=s.points[t.center];if(!n)return[];const i=lt(t);if(i<=.001)return[];const o=tl(t).map(r=>{const a=s.points[r];if(!a)return null;const c=Math.atan2(a.y-n.y,a.x-n.x);return{idx:r,ang:c}}).filter(r=>r!==null).sort((r,a)=>r.ang-a.ang);if(o.length<2)return[];no(e,o.length);const l=[];for(let r=0;r<o.length;r++){const a=o[r],c=o[(r+1)%o.length],u=a.ang,f=c.ang,p=!1,m=t.arcStyles?.[r]??t.style;l.push({circle:e,start:u,end:f,clockwise:p,center:n,radius:i,style:m,hidden:m.hidden||t.style.hidden})}return l}function ac(e,t,n,i){const o=jn(e),l=jn(t),r=jn(n);if(!i){const u=(r-l+Math.PI*2)%(Math.PI*2);return(o-l+Math.PI*2)%(Math.PI*2)<=u+1e-6}const a=(l-r+Math.PI*2)%(Math.PI*2);return(l-o+Math.PI*2)%(Math.PI*2)<=a+1e-6}function La(e,t=He(),n){for(let i=s.circles.length-1;i>=0;i--){if(s.circles[i].hidden&&!oe)continue;const o=Sn(i);for(let l=o.length-1;l>=0;l--){const r=o[l],a=r.center,c=Math.hypot(e.x-a.x,e.y-a.y);if(Math.abs(c-r.radius)>t)continue;const u=Math.atan2(e.y-a.y,e.x-a.x);if(ac(u,r.start,r.end,r.clockwise))return{circle:i,arcIdx:l}}}return null}function jl(e){const t=s.lines[e.leg1.line],n=s.lines[e.leg2.line];if(!t||!n)return null;const i=s.points[e.vertex],o=s.points[t.points[e.leg1.seg]],l=s.points[t.points[e.leg1.seg+1]],r=s.points[n.points[e.leg2.seg]],a=s.points[n.points[e.leg2.seg+1]];if(!i||!o||!l||!r||!a)return null;const c=e.vertex===t.points[e.leg1.seg]?l:o,u=e.vertex===n.points[e.leg2.seg]?a:r,f=jn(Math.atan2(c.y-i.y,c.x-i.x)),p=jn(Math.atan2(u.y-i.y,u.x-i.x));let m=(p-f+Math.PI*2)%(Math.PI*2),x=f,d=p;m>Math.PI&&(x=p,d=f,m=(d-x+Math.PI*2)%(Math.PI*2));const y=!1,b=Math.hypot(c.x-i.x,c.y-i.y),h=Math.hypot(u.x-i.x,u.y-i.y),v=Math.max(4,Math.min(b,h)-Rc),k=Math.max(500,v),B=Cc;let E=Math.min(Tc,k);return E=Ge(E,B,k),{v:i,p1:c,p2:u,start:x,end:d,span:m,clockwise:y,radius:E,minRadius:B,maxRadius:k}}function Un(e){const t=jl(e);if(!t)return null;const n=e.style.arcRadiusOffset??0,i=t.radius+n,o=Ge(i,t.minRadius,t.maxRadius),r=!!e.style.exterior?!t.clockwise:t.clockwise;return{...t,start:t.start,end:t.end,clockwise:r,radius:o,style:e.style}}function wr(e){if(G===null)return;const t=s.angles[G],n=jl(t);if(!n)return;const i=t.style.arcRadiusOffset??0,l=Ge(n.radius+i+e*_c,n.minRadius,n.maxRadius)-n.radius;if(Math.abs(l-i)<1e-6){dn();return}s.angles[G]={...t,style:{...t.style,arcRadiusOffset:l}},P(),J(),dn()}function Qo(e,t=He()){for(let n=s.angles.length-1;n>=0;n--){const i=Un(s.angles[n]);if(!i)continue;const{v:o,start:l,end:r,clockwise:a,radius:c}=i;if(Math.abs(Math.hypot(e.x-o.x,e.y-o.y)-c)>t)continue;const f=Math.atan2(e.y-o.y,e.x-o.x);if(ac(f,l,r,a))return n}return null}function Ia(e,t){return t.points.includes(e)}function cs(e,t,n){const i=Math.max(1,(n.x-t.x)**2+(n.y-t.y)**2),o=Math.max(0,Math.min(1,((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/i)),l={x:t.x+(n.x-t.x)*o,y:t.y+(n.y-t.y)*o};return Math.hypot(e.x-l.x,e.y-l.y)}function dc(e){const t=new Set;return s.circles.forEach((n,i)=>{n.points.includes(e)&&!Uo(n,e)&&t.add(i)}),Array.from(t)}function Sr(e){const t=new Set;return s.circles.forEach((n,i)=>{n.center===e&&t.add(i),n.radius_point===e&&t.add(i),n.points.includes(e)&&!Uo(n,e)&&t.add(i),Lt(n)&&n.defining_points.includes(e)&&t.add(i)}),Array.from(t)}function ni(e){const t=[];return s.circles.forEach((n,i)=>{n.center===e&&t.push(i)}),t}function Pl(e){if(!e.points.length)return null;let t=1/0,n=1/0,i=-1/0,o=-1/0;e.points.forEach(r=>{t=Math.min(t,r.x),n=Math.min(n,r.y),i=Math.max(i,r.x),o=Math.max(o,r.y)});const l=e.baseWidth*2;return{minX:t-l,minY:n-l,maxX:i+l,maxY:o+l}}function es(e){for(let t=s.inkStrokes.length-1;t>=0;t--){const n=s.inkStrokes[t];if(n.hidden&&!oe)continue;const i=Pl(n);if(!i||e.x<i.minX||e.x>i.maxX||e.y<i.minY||e.y>i.maxY)continue;const o=He();for(let l=0;l<n.points.length;l++){const r=n.points[l];if(l===0){if(Math.hypot(e.x-r.x,e.y-r.y)<=o)return t}else{const a=n.points[l-1];if(cs(e,a,r)<=o)return t}}}return null}function Ii(e){if(g)switch(e){case"dashed":g.setLineDash([6,4]);break;case"dotted":g.setLineDash([2,4]);break;default:g.setLineDash([])}}function Ba(e){const t=s.points[e];if(!t||!t.label)return null;t.label.offset||(t.label.offset=St(e));const n=t.label.offset??{x:8,y:-8},i=Wl(n);return{x:t.x+i.x,y:t.y+i.y}}function Ma(e){const t=s.lines[e];if(!t||!t.label)return null;const n=oo(e);if(!n)return null;t.label.offset||(t.label.offset=vi(e));const i=t.label.offset??{x:0,y:-10},o=Wl(i);return{x:n.center.x+o.x,y:n.center.y+o.y}}function Pa(e){const t=s.angles[e];if(!t||!t.label)return null;const n=Un(t);if(!n)return null;t.label.offset||(t.label.offset=io(e));const i=t.label.offset??{x:0,y:0},o=Wl(i);return{x:n.v.x+o.x,y:n.v.y+o.y}}function ts(e,t,n){const i=Fs(t.x,t.y),o=yc(n),l=6,r=4,a=o.width/2+l,c=o.height/2+r;return e.x>=i.x-a&&e.x<=i.x+a&&e.y>=i.y-c&&e.y<=i.y+c}function _a(e){const t=Fs(e.x,e.y);for(let n=s.angles.length-1;n>=0;n--){const i=Pa(n),o=s.angles[n].label;if(i&&o&&ts(t,i,o))return{kind:"angle",id:n}}for(let n=s.lines.length-1;n>=0;n--){const i=Ma(n),o=s.lines[n].label;if(i&&o&&ts(t,i,o))return{kind:"line",id:n}}for(let n=s.points.length-1;n>=0;n--){const i=Ba(n),o=s.points[n].label;if(i&&o&&ts(t,i,o))return{kind:"point",id:n}}for(let n=s.labels.length-1;n>=0;n--){const i=s.labels[n];if(!(i.hidden&&!oe)&&ts(t,i.pos,i))return{kind:"free",id:n}}return null}function Ps(e){const t=ce.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return Xo(n,i)}function Xo(e,t){return{x:(e-Oe.x)/ne,y:(t-Oe.y)/ne}}function Fs(e,t){return{x:e*ne+Oe.x,y:t*ne+Oe.y}}function Wl(e){return{x:e.x/ne,y:e.y/ne}}function vn(e){return{x:e.x*ne,y:e.y*ne}}function uc(e){if(!ce)return;const t=ce.getBoundingClientRect();In.set(e.pointerId,{x:e.clientX-t.left,y:e.clientY-t.top})}function Ta(e){In.delete(e),dt&&!dt.pointerIds.every(t=>In.has(t))&&(dt=null)}function _l(){const e=Array.from(In.entries());if(e.length<2)return!1;const[[t,n],[i,o]]=e,l=Math.hypot(n.x-o.x,n.y-o.y);return l>0?(dt={pointerIds:[t,i],initialDistance:l,initialZoom:ne},ht=!1,di=null,$e=null,No=null,Qi=!1,!0):!1}function Ca(){if(!dt)return!1;const[e,t]=dt.pointerIds,n=In.get(e),i=In.get(t);if(!n||!i)return!1;const o=Math.hypot(n.x-i.x,n.y-i.y);if(!(o>0))return!1;const l=o/dt.initialDistance,r={x:(n.x+i.x)/2,y:(n.y+i.y)/2},a=Xo(r.x,r.y),c=Ge(dt.initialZoom*l,As,Ds),u=Math.abs(c-ne)>1e-6,f={...Oe};ne=c,Oe={x:r.x-a.x*ne,y:r.y-a.y*ne};const p=Math.abs(Oe.x-f.x)>1e-6||Math.abs(Oe.y-f.y)>1e-6;return(u||p)&&(Ki=!0,P()),dt.initialDistance=o,dt.initialZoom=ne,u||p}function Ra(e){if(!ce)return;const t=ce.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,o=Xo(n,i),l=e.deltaMode===WheelEvent.DOM_DELTA_LINE?e.deltaY*16:e.deltaY,r=Math.exp(-l*.001),a=Ge(ne*r,As,Ds);if(Math.abs(a-ne)<1e-6){e.preventDefault();return}ne=a,Oe={x:n-o.x*ne,y:i-o.y*ne},Ki=!0,e.preventDefault(),P()}function as(e){if(z&&z.kind==="free"&&!(e&&e.kind==="free"&&e.id===z.id)){const n=s.labels[z.id];n&&(!n.text||!n.text.trim())&&(s.labels.splice(z.id,1),e&&e.kind==="free"&&e.id>z.id&&e.id--)}z=e,e&&(M=null,_=null,H=null,G=null,j=null,q.clear(),Z.clear()),$(),P()}function ao(){as(null)}function ie(e){if(z&&z.kind==="free"){const n=s.labels[z.id];n&&(!n.text||!n.text.trim())&&(s.labels.splice(z.id,1),z=null,P())}if(et===e){et=null,Ie("move");return}et=null;const t=e==="symmetric"?M:null;if(e==="midpoint")if(M!==null)rs(),$(),P();else{const n=Array.from(q).map(ro).find(l=>l&&l.part==="segment"&&l.seg!==void 0)??null,i=n?.line??_,o=n?.seg??0;if(i!==null){const l=s.lines[i];if(l&&l.points[o]!==void 0&&l.points[o+1]!==void 0){const r=s.points[l.points[o]],a=s.points[l.points[o+1]];if(r&&a){const c={x:(r.x+a.x)/2,y:(r.y+a.y)/2},u=ae(s,{...c,style:ue(),defining_parents:l?.id?[{kind:"line",id:l.id}]:[]});js(i,u,c),rs(),M=u,_=i,$(),P(),J(),Ie("move"),st();return}}}}if(e==="parallelLine"&&(Et=M,at=_,Et!==null&&at!==null)){const n=_s(Et,at);if(Et=null,at=null,n!==null){_=n,M=null,P(),J(),ye(),$();return}}(e==="triangleUp"||e==="square"||e==="polygon"||e==="ngon"||e==="angle"||e==="bisector"||e==="circleThree")&&(rs(),$(),P()),Ie(e),e==="symmetric"&&(Rn=t,Rn!==null&&P()),e==="label"&&Sa(),st(),$()}function _t(e){if(z&&z.kind==="free"){const t=s.labels[z.id];t&&(!t.text||!t.text.trim())&&(s.labels.splice(z.id,1),z=null,P())}et===e?(et=null,Ie("move")):(et=e,Ie(e)),st(),$()}function Nn(e,t){e&&e.addEventListener("touchend",n=>{const i=Date.now(),o=Jo.get(e);o&&i-o<xr?(n.preventDefault(),Jo.delete(e),_t(t)):(Jo.set(e,i),setTimeout(()=>{Jo.delete(e)},xr))},{passive:!1})}function ye(){et===null&&V!=="move"&&Ie("move"),Object.keys(we.multiButtons).forEach(e=>{if(Pt[e]!==0){Pt[e]=0;const t=document.getElementById(e);if(t){const i=we.multiButtons[e][0],o=ge.find(l=>l.id===i);if(o){const l=t.querySelector("svg");l&&(l.setAttribute("viewBox",o.viewBox),l.innerHTML=o.icon),t.setAttribute("title",o.label),t.setAttribute("aria-label",o.label)}}}})}function st(){const e=(t,n)=>{t&&(t.classList.toggle("active",V===n),t.classList.toggle("sticky",et===n))};if(e(kn,"add"),e(En,"segment"),e(Io,"parallel"),e(Bo,"perpendicular"),e(Po,"triangleUp"),e(_o,"square"),e(Mo,"circleThree"),e(si,"label"),e(Co,"angle"),e(To,"polygon"),e(Ro,"bisector"),e(Ao,"midpoint"),e(Wi,"symmetric"),e(qi,"parallelLine"),e(An,"tangent"),e(Dn,"perpBisector"),e(Do,"ngon"),e(Lo,"multiselect"),e(document.getElementById("modeCircle"),"circle"),e(zo,"handwriting"),en){en.classList.toggle("active",V==="move"),en.classList.toggle("sticky",!1);const t="Zaznacz";en.title=t,en.setAttribute("aria-label",t),en.innerHTML=`${$n.moveSelect}<span class="sr-only">${t}</span>`}Object.entries(we.multiButtons).forEach(([t,n])=>{const i=document.getElementById(t);if(!i)return;const o=Pt[t]||0,l=n[o],r=ge.find(a=>a.id===l);if(r){let a=!1;l==="copyStyleBtn"?a=Ce:a=V===r.mode,i.classList.toggle("active",a),i.classList.toggle("sticky",et===r.mode)}})}function $(){ui&&(Hn&&(Hn.style.display="none"),Al()==="edges"?ui.innerHTML=$n.viewEdges:ui.innerHTML=$n.viewVertices);const e=_!==null||M!==null||H!==null||j!==null||Z.size>0||G!==null||re!==null||z!==null||yi();if(ks&&(ks.style.display=e?"inline-flex":"none"),Es&&(Es.style.display=e?"inline-flex":"none"),_n){const n=V!=="multiselect"&&(M!==null||_!==null||H!==null||G!==null||re!==null);_n.style.display=n?"inline-flex":"none",Ce?(_n.classList.add("active"),_n.setAttribute("aria-pressed","true")):(_n.classList.remove("active"),_n.setAttribute("aria-pressed","false"))}const t=V==="multiselect"&&yi();if(Ut&&(Ut.style.display=t?"inline-flex":"none"),ws&&(ws.style.display=t?"inline-flex":"none"),ln){const n=e&&!yi()||V==="handwriting";ln.style.display=n?"inline-flex":"none",!e&&V!=="handwriting"&&jo(),dn()}if(Dt){const n=V==="handwriting";Dt.style.display=n?"inline-flex":"none",Dt.classList.toggle("active",nn),Dt.setAttribute("aria-pressed",nn?"true":"false")}}function Xe(e){return Math.max(.1,e/(Qe*ne))}function Ne(e){return e/ne}function Aa(e,t){const n=e.points;if(n.length){if(t.save(),t.strokeStyle=e.color,t.fillStyle=e.color,t.lineCap="round",t.lineJoin="round",n.length===1){const i=n[0],o=Xe(e.baseWidth*Math.max(i.pressure,.25))*.5;t.beginPath(),t.arc(i.x,i.y,o,0,Math.PI*2),t.fill(),t.restore();return}for(let i=1;i<n.length;i++){const o=n[i-1],l=n[i],r=Math.max(.2,(o.pressure+l.pressure)*.5);t.lineWidth=Xe(e.baseWidth*r),t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(l.x,l.y),t.stroke()}t.restore()}}function Da(e,t,n,i){if(n<=0)return;const o=t.x-e.x,l=t.y-e.y,r=Math.hypot(o,l);if(!Number.isFinite(r)||r<=Ne(2))return;const a={x:o/r,y:l/r},c={x:-a.y,y:a.x},u={x:(e.x+t.x)/2,y:(e.y+t.y)/2},f=Ne(Cr),p=Ne(Ar),m=Math.max(0,r/2-p),x=n===1?0:Ne(Rr),d=m*2/Math.max(1,n-1),y=n===1?0:Math.min(x,d);i.save(),i.setLineDash([]),i.lineCap="round";for(let b=0;b<n;b++){const h=y*(b-(n-1)/2),v=Ge(h,-m,m),k={x:u.x+a.x*v,y:u.y+a.y*v},B={x:k.x+c.x*(f/2),y:k.y+c.y*(f/2)},E={x:k.x-c.x*(f/2),y:k.y-c.y*(f/2)};i.beginPath(),i.moveTo(B.x,B.y),i.lineTo(E.x,E.y),i.stroke()}i.restore()}function fc(e,t,n,i,o,l,r){if(l<=0||t<=0)return;let a=o?(n-i+Math.PI*2)%(Math.PI*2):(i-n+Math.PI*2)%(Math.PI*2);a<1e-4&&(a=Math.PI*2);const c=o?-1:1,u=jn(o?n-a/2:n+a/2),f=Ne(Cr),p=Math.min(a/4,Ne(Ar)/Math.max(t,.001)),m=Math.max(0,a/2-p),x=l===1?0:Ne(Rr)/Math.max(t,.001),d=m*2/Math.max(1,l-1),y=l===1?0:Math.min(x,d);r.save(),r.setLineDash([]),r.lineCap="round";for(let b=0;b<l;b++){const h=y*(b-(l-1)/2),v=Ge(h,-m,m),k=jn(u+c*v),B={x:e.x+Math.cos(k)*t,y:e.y+Math.sin(k)*t},E={x:Math.cos(k),y:Math.sin(k)},w={x:B.x+E.x*(f/2),y:B.y+E.y*(f/2)},S={x:B.x-E.x*(f/2),y:B.y-E.y*(f/2)};r.beginPath(),r.moveTo(w.x,w.y),r.lineTo(S.x,S.y),r.stroke()}r.restore()}function za(e,t,n,i){fc(e,t,-Math.PI/2,-Math.PI/2+Math.PI*2,!1,n,i)}function He(e=1){return Fc*e/ne}function pc(e){const i=Math.max(1,Math.min(6,e));return i<=1?4:4+(i-1)*2/5}function Na(e){const t=s.lines[e];if(!t||t.points.length<2)return null;const n=s.points[t.points[0]],i=s.points[t.points[t.points.length-1]];return!n||!i?null:{x:(n.x+i.x)/2,y:(n.y+i.y)/2,a:n,b:i}}function vi(e){const t=Na(e);if(!t)return vn({x:0,y:-16});const n=t.b.x-t.a.x,i=t.b.y-t.a.y,o=Math.hypot(n,i)||1;let l={x:-i/o,y:n/o};const r=ps(e);if(r!==null){const c=Jr(r);if(c){const u={x:c.x-t.x,y:c.y-t.y};l.x*u.x+l.y*u.y>0&&(l={x:-l.x,y:-l.y})}}else Math.abs(n)<.001?l={x:-1,y:0}:l.y>0&&(l={x:-l.x,y:-l.y});const a=18;return vn({x:l.x*a,y:l.y*a})}function Oa(e){const t=[];return $t(e).forEach(i=>{const o=s.lines[i],l=o.points.indexOf(e);if(l===-1)return;const r=l>0?s.points[o.points[l-1]]:null,a=l<o.points.length-1?s.points[o.points[l+1]]:null,c=s.points[e];if(c){if(r){const u=r.x-c.x,f=r.y-c.y,p=Math.hypot(u,f)||1;t.push({x:u/p,y:f/p})}if(a){const u=a.x-c.x,f=a.y-c.y,p=Math.hypot(u,f)||1;t.push({x:u/p,y:f/p})}}}),t}function St(e){const t=s.points[e],n={x:12,y:-12};if(!t)return vn(n);const i=dc(e);if(i.length){const r=s.circles[i[0]],a=s.points[r.center];if(a){const c=qe({x:t.x-a.x,y:t.y-a.y}),u=18;return vn({x:c.x*u,y:c.y*u})}}const o=Oa(e),l=18;if(o.length>=2){const r=o.reduce((u,f)=>({x:u.x+f.x,y:u.y+f.y}),{x:0,y:0}),a=Math.hypot(r.x,r.y);let c=a>.001?{x:r.x/a,y:r.y/a}:{x:-o[0].y,y:o[0].x};return c={x:-c.x,y:-c.y},vn({x:c.x*l,y:c.y*l})}if(o.length===1){let r={x:-o[0].y,y:o[0].x};return r.y>0&&(r={x:-r.x,y:-r.y}),vn({x:r.x*l,y:r.y*l})}return vn(n)}function io(e){const t=Un(s.angles[e]);if(!t)return vn({x:0,y:-12});const n=t.start+t.span/2,i={x:Math.cos(n),y:Math.sin(n)},o=Math.max(t.radius*.65,12);return vn({x:i.x*o,y:i.y*o})}function yc(e){if(!g)return{width:0,height:0,lines:[],lineWidths:[],lineHeight:0};const t=Rt(e.fontSize);g.save(),g.font=`${t}px sans-serif`;let n=e.text;for(;n.endsWith(`
`);)n=n.slice(0,-1);const i=n.split(`
`),o=t*1.2;let l=0;const r=[];i.forEach(c=>{const u=Fa(g,c);r.push(u),u>l&&(l=u)});const a=i.length*o;return g.restore(),{width:l,height:a,lines:i,lineWidths:r,lineHeight:o}}function ns(e,t,n=!1,i){if(!g)return;g.save(),g.setTransform(Qe,0,0,Qe,0,0);const o=Fs(t.x,t.y),l={x:o.x+(i?.x??0),y:o.y+(i?.y??0)};g.translate(l.x,l.y);const r=Rt(e.fontSize);g.font=`${r}px sans-serif`,g.textAlign="center",g.textBaseline="middle";const{width:a,height:c,lines:u,lineWidths:f,lineHeight:p}=yc(e),m=-(c/2)+p/2;if(n){const y=a+12,b=c+8;g.fillStyle="rgba(251,191,36,0.18)",g.strokeStyle=X.highlight,g.lineWidth=1;const h=-y/2,v=-b/2,k=6;g.beginPath(),g.moveTo(h+k,v),g.lineTo(h+y-k,v),g.quadraticCurveTo(h+y,v,h+y,v+k),g.lineTo(h+y,v+b-k),g.quadraticCurveTo(h+y,v+b,h+y-k,v+b),g.lineTo(h+k,v+b),g.quadraticCurveTo(h,v+b,h,v+b-k),g.lineTo(h,v+k),g.quadraticCurveTo(h,v,h+k,v),g.fill(),g.stroke()}g.fillStyle=e.color??"#000",u.forEach((x,d)=>{const y=f[d],b=m+d*p;Ha(g,x,-y/2,b)}),g.restore()}function hc(e){let t="",n=0;for(;n<e.length;){const i=e[n];if((i==="_"||i==="^")&&n+1<e.length){if(t+=i,n++,e[n]==="{"){t+=i,n++;continue}const o=n,l=e[n],r=/\d/.test(l),a=/[a-z]/.test(l),c=/[A-Z]/.test(l),u=/[Î±-Ï‰Î‘-Î©]/.test(l);for(;n<e.length;){const p=e[n];if(!(r?/\d/.test(p):a?/[a-z]/.test(p):c?/[A-Z]/.test(p):u?/[Î±-Ï‰Î‘-Î©]/.test(p):!1))break;n++}const f=e.substring(o,n);f.length>0&&(t+="{"+f+"}")}else t+=i,n++}return t}function Fa(e,t){const n=hc(t),o=(parseFloat(e.font)||16)*.7;let l=0,r=0;for(;r<n.length;){const a=n[r];if((a==="_"||a==="^")&&r+1<n.length&&n[r+1]==="{"){r+=2;let c="",u=1;for(;r<n.length&&u>0;){if(n[r]==="{")u++;else if(n[r]==="}"&&(u--,u===0))break;c+=n[r],r++}e.save(),e.font=`${o}px ${e.font.split("px ")[1]||"sans-serif"}`,l+=e.measureText(c).width,e.restore(),r++}else l+=e.measureText(a).width,r++}return l}function Ha(e,t,n,i){e.textAlign="left";const o=hc(t),l=parseFloat(e.font)||16,r=l*.7,a=l*.3,c=-l*.4;let u=n,f=0;for(;f<o.length;){const p=o[f];if(p==="_"&&f+1<o.length&&o[f+1]==="{"){f+=2;let m="",x=1;for(;f<o.length&&x>0;){if(o[f]==="{")x++;else if(o[f]==="}"&&(x--,x===0))break;m+=o[f],f++}e.save(),e.font=`${r}px ${e.font.split("px ")[1]||"sans-serif"}`,e.fillText(m,u,i+a),u+=e.measureText(m).width,e.restore(),f++}else if(p==="^"&&f+1<o.length&&o[f+1]==="{"){f+=2;let m="",x=1;for(;f<o.length&&x>0;){if(o[f]==="{")x++;else if(o[f]==="}"&&(x--,x===0))break;m+=o[f],f++}e.save(),e.font=`${r}px ${e.font.split("px ")[1]||"sans-serif"}`,e.fillText(m,u,i+c),u+=e.measureText(m).width,e.restore(),f++}else e.fillText(p,u,i),u+=e.measureText(p).width,f++}}function ji(){if(vo&&(vo.classList.toggle("active",oe),vo.innerHTML=oe?$n.eyeOff:$n.eye),ti&&(ti.classList.toggle("active",wt),ti.setAttribute("aria-pressed",wt?"true":"false"),ti.title=wt?"Ukryj wymiary":"PokaÅ¼ wymiary",ti.setAttribute("aria-label",wt?"Ukryj wymiary":"PokaÅ¼ wymiary")),ko){const e=Ft==="dark";ko.classList.toggle("active",e),ko.setAttribute("aria-pressed",e?"true":"false")}}function On(e){return e.trim().toLowerCase()}function Tl(e){const t=On(e),n=tn.findIndex(i=>On(i)===t);n>=0&&tn.splice(n,1),tn.unshift(e),tn.length>20&&(tn=tn.slice(0,20)),Ko()}function $a(){const e=[];tn.forEach(n=>{e.some(i=>On(i)===On(n))||e.push(n)});const t=X.palette;if(t.length)for(t.forEach(n=>{e.length<5&&!e.some(i=>On(i)===On(n))&&e.push(n)});e.length<5;)e.push(t[e.length%t.length]);else for(;e.length<5;)e.push(X.defaultStroke);return e.slice(0,5)}function Ko(){const e=fe;if(!e)return;const t=e.value,n=$a();if(xl.forEach((i,o)=>{const l=n[o]??X.defaultStroke;i.dataset.color=l,i.style.background=l,i.classList.remove("active")}),Ss){const i=!n.some(o=>On(o)===On(t));Ss.classList.toggle("active",i)}}function ja(e){if(!gt)return;const t=gt,n=t.selectionStart??t.value.length,i=t.selectionEnd??t.value.length,o=t.value.slice(0,n)+e+t.value.slice(i);t.value=o;const l=n+e.length;t.focus(),typeof t.setSelectionRange=="function"&&t.setSelectionRange(l,l);const r=new Event("input",{bubbles:!0});t.dispatchEvent(r)}function ds(e){if(e||(Xi=!1,wo=!1),Oi){Oi.style.display=e?"inline-flex":"none";const n=e&&Xi;Oi.classList.toggle("active",n),Oi.setAttribute("aria-pressed",n?"true":"false")}gl&&(gl.style.display=e&&Xi?"flex":"none");let t=0;os.forEach(n=>{if(ss){if(n.classList.contains("label-symbol-btn")){n.disabled=!1,n.style.display="";return}if(t<Sl.length){const i=Sl[t],o=Yc[t]||i.toUpperCase(),l=wo?o:i;n.dataset.letter=l,n.textContent=l,n.disabled=!1,n.style.display="",t+=1}else n.dataset.letter="",n.textContent="",n.disabled=!0,n.style.display="none"}else{const i=n.dataset.letterLower??n.dataset.letter??n.textContent??"",o=n.dataset.letterUpper??i.toUpperCase(),l=wo?o:i;n.dataset.letter=l,n.textContent=l,l?(n.disabled=!1,n.style.display=""):(n.disabled=!0,n.style.display="none")}}),Ls&&(Ls.style.display="none"),Eo&&(Eo.style.display="none")}function Wa(){if(!z)return null;switch(z.kind){case"point":{const t=s.points[z.id]?.label;if(!t)return null;const n=Rt(t.fontSize);return t.fontSize!==n&&(s.points[z.id].label={...t,fontSize:n}),n}case"line":{const t=s.lines[z.id]?.label;if(!t)return null;const n=Rt(t.fontSize);return t.fontSize!==n&&(s.lines[z.id].label={...t,fontSize:n}),n}case"angle":{const t=s.angles[z.id]?.label;if(!t)return null;const n=Rt(t.fontSize);return t.fontSize!==n&&(s.angles[z.id].label={...t,fontSize:n}),n}case"free":{const e=s.labels[z.id];if(!e)return null;const t=Rt(e.fontSize);return e.fontSize!==t&&(s.labels[z.id]={...e,fontSize:t}),t}}}function Cl(){const e=Wa(),t=e!==null?`${e} px`:"â€”";Ll&&(Ll.textContent=t);const n=e!==null&&e<=hs,i=e!==null&&e>=Tr,o=e!==null&&e<ys,l=e!==null&&e>ys;Fi&&(Fi.disabled=e===null||n,Fi.classList.toggle("limit",e!==null&&n),Fi.classList.toggle("active",o)),$i&&($i.disabled=e===null||i,$i.classList.toggle("limit",e!==null&&i),$i.classList.toggle("active",l))}function Lr(e){const t=z;if(!t||e===0){Cl();return}let n=!1;const i=(o,l)=>{const r=Rt(o.fontSize),a=$r(r+e);a!==r&&(l({...o,fontSize:a}),n=!0)};switch(t.kind){case"point":{const o=s.points[t.id];o?.label&&i(o.label,l=>{s.points[t.id].label=l});break}case"line":{const o=s.lines[t.id];o?.label&&i(o.label,l=>{s.lines[t.id].label=l});break}case"angle":{const o=s.angles[t.id];o?.label&&i(o.label,l=>{s.angles[t.id].label=l});break}case"free":{const o=s.labels[t.id];o&&i(o,l=>{s.labels[t.id]=l});break}}Cl(),n&&(P(),J()),ai()}function ai(){if(!le)return;const e=Number(le.min)||.1,t=Number(le.max)||50,n=Number(le.value),i=Ge(Number.isFinite(n)?Math.round(n*10)/10:e,e,t);le.value!==String(i)&&(le.value=String(i));const o=le.disabled;ml&&(ml.textContent=o?"â€”":`${i} px`);const l=he?.disabled?X.pointSize:X.lineWidth;if(zi){const r=i<=e;zi.disabled=o||r,zi.classList.toggle("limit",r),zi.classList.toggle("active",!o&&i<l)}if(Ni){const r=i>=t;Ni.disabled=o||r,Ni.classList.toggle("limit",r),Ni.classList.toggle("active",!o&&i>l)}}function Ir(e){if(!le||e===0){ai();return}if(le.disabled){ai();return}const t=Number(le.min)||.1,n=Number(le.max)||50,i=Number(le.value)||t,l=Ge(Math.round((i+e*.1)*10)/10,t,n);if(l===i){ai();return}le.value=String(l),Ti(),ai()}function gc(e){if(e)return{available:!1,state:0,mixed:!1};if(_!==null||j!==null){const t=new Set;_!==null&&t.add(_),j!==null&&s.polygons[j]?.lines.forEach(r=>t.add(r));const n=[];if(t.forEach(l=>{const r=s.lines[l];if(!r)return;const a=Math.max(0,r.points.length-1);zt(l);const c=q.size===0;for(let u=0;u<a;u++){const f=Ln(l,"segment",u);if(!c&&!q.has(f))continue;const p=r.segmentStyles?.[u]??r.style;n.push(p.tick??0)}}),!n.length)return{available:!0,state:0,mixed:!1};const i=n[0],o=n.some(l=>l!==i);return{available:!0,state:o?0:i??0,mixed:o}}if(H!==null){const t=H,n=Sn(t);no(t,n.length);const i=s.circles[t]?.style,o=[];if(n.forEach((a,c)=>{const u=$o(t,c);if(Z.size>0&&!Z.has(u))return;const f=i?.tick??0;o.push(a.style.tick??f)}),!o.length)return{available:!0,state:0,mixed:!1};const l=o[0],r=o.some(a=>a!==l);return{available:!0,state:r?0:l??0,mixed:r}}return{available:!1,state:0,mixed:!1}}function qa(e){let t=!1;const n=(r,a,c)=>{const u=s.lines[r];if(!u)return;zt(r),u.segmentStyles||(u.segmentStyles=[]);const f=u.segmentStyles[a]??u.style;u.segmentStyles[a]={...f,tick:c},t=!0},i=(r,a)=>{const c=s.lines[r];if(!c)return;zt(r);const u=Math.max(0,c.points.length-1);c.segmentStyles||(c.segmentStyles=[]),c.style={...c.style,tick:a},t=!0;for(let f=0;f<u;f++)n(r,f,a);c.leftRay=c.leftRay?{...c.leftRay,tick:a}:c.leftRay,c.rightRay=c.rightRay?{...c.rightRay,tick:a}:c.rightRay},o=(r,a,c)=>{no(r,Sn(r).length);const u=s.circles[r];u.arcStyles||(u.arcStyles=[]);const f=u.arcStyles[a]??u.style;u.arcStyles[a]={...f,tick:c},t=!0},l=(r,a)=>{const c=s.circles[r];if(c){no(r,Sn(r).length),c.style={...c.style,tick:a},c.arcStyles||(c.arcStyles=[]),t=!0;for(let u=0;u<c.arcStyles.length;u++)o(r,u,a)}};if(_!==null||j!==null){const r=new Set;_!==null&&r.add(_),j!==null&&s.polygons[j]?.lines.forEach(c=>r.add(c)),r.forEach(a=>{const c=s.lines[a];if(!c)return;const u=Math.max(0,c.points.length-1);if(!(q.size>0))i(a,e),t=!0;else for(let p=0;p<u;p++){const m=Ln(a,"segment",p);q.has(m)&&n(a,p,e)}})}else if(H!==null){const r=H,a=Sn(r);Z.size>0?a.forEach((u,f)=>{const p=$o(r,f);Z.has(p)&&o(r,f,e)}):(l(r,e),t=!0)}t&&(P(),J(),dn())}function Ga(){const e=gc(!1);if(!e.available)return;const n=((e.mixed?0:e.state)+1)%4;qa(n)}function dn(){if(!fe||!le||!he)return;const e=(h,v)=>{h&&(h.style.display=v?"flex":"none")};Xt&&(Xt.disabled=!0,Xt.classList.remove("active"),Xt.classList.remove("limit")),Yt&&(Yt.disabled=!0,Yt.classList.remove("active"),Yt.classList.remove("limit"));const t=z!==null,n=j!==null?s.polygons[j]?.lines??[]:[],i=_!==null?_:n.length?n[0]:null,o=M!==null,l=_!==null||j!==null,r=Re&&(!We||q.size>0);if(yl&&(yl.style.display=t?"flex":"none"),hl&&(hl.style.display=t?"flex":"none"),ds(t),Cl(),t&&z){let h=fe.value,v="";switch(z.kind){case"point":h=s.points[z.id]?.label?.color??h,v=s.points[z.id]?.label?.text??"";break;case"line":h=s.lines[z.id]?.label?.color??h,v=s.lines[z.id]?.label?.text??"";break;case"angle":h=s.angles[z.id]?.label?.color??h,v=s.angles[z.id]?.label?.text??"";break;case"free":h=s.labels[z.id]?.color??h,v=s.labels[z.id]?.text??"";break}fe.value=h,gt&&(gt.value=v),le.disabled=!0,he.disabled=!0}else if(i!==null){const h=s.lines[i],v=h.segmentStyles?.[0]??h.style;if(r){const k=h.points[0],E=(k!==void 0?s.points[k]:null)??{style:{color:v.color,size:X.pointSize}};fe.value=E.style.color,le.value=String(E.style.size),he.value="solid",le.disabled=!1,he.disabled=!0}else fe.value=v.color,le.value=String(v.width),he.value=v.type,le.disabled=!1,he.disabled=!1}else if(H!==null){const h=s.circles[H],v=Sn(H),k=Z.size>0?(()=>{const B=Array.from(Z)[0],E=Os(B);return E&&E.circle===H&&v[E.arcIdx]?v[E.arcIdx].style:h.style})():h.style;fe.value=k.color,le.value=String(k.width),he.value=k.type,le.disabled=!1,he.disabled=!1}else if(G!==null){const h=s.angles[G],v=h.style;fe.value=v.color,le.value=String(v.width),he.value=v.type,le.disabled=!1,he.disabled=!1,ri.forEach(L=>{const A=Number(L.dataset.count)||1;L.classList.toggle("active",A===(v.arcCount??1))}),xn&&(xn.classList.toggle("active",!!v.right),v.right&&ri.forEach(L=>L.classList.remove("active"))),on&&(on.classList.toggle("active",!!v.exterior),on.setAttribute("aria-pressed",v.exterior?"true":"false"));const k=jl(h),B=Un(h),E=v.arcRadiusOffset??0,w=!!(k&&B);let S=!1,I=!1;k&&B&&(S=B.radius<=k.minRadius+Ql,I=B.radius>=k.maxRadius-Ql),Xt&&(Xt.disabled=!w||I,Xt.classList.toggle("active",E>0),Xt.classList.toggle("limit",w&&I)),Yt&&(Yt.disabled=!w||S,Yt.classList.toggle("active",E<0),Yt.classList.toggle("limit",w&&S))}else if(M!==null){const h=s.points[M];fe.value=h.style.color,le.value=String(h.style.size),he.value="solid",le.disabled=!1,he.disabled=!0}else if(re!==null){const h=s.inkStrokes[re];h&&(fe.value=h.color,le.value=String(h.baseWidth),he.value="solid",le.disabled=!1,he.disabled=!0)}else if(r&&_!==null){const v=s.lines[_]?.points[0],B=(v!==void 0?s.points[v]:null)??{style:{color:fe.value,size:X.pointSize}};fe.value=B.style.color,le.value=String(B.style.size),he.value="solid",le.disabled=!1,he.disabled=!0}else if(r&&j!==null){const h=ki(j),k=(h[0]!==void 0?s.points[h[0]]:null)??{style:{color:fe.value,size:X.pointSize}};fe.value=k.style.color,le.value=String(k.style.size),he.value="solid",le.disabled=!1,he.disabled=!0}ai();const a=!o&&!t&&re===null&&V!=="handwriting";pl?(pl.style.display=a?"inline-flex":"none",e(fl,!1)):e(fl,a),El&&(El.style.display=a?"flex":"none");const c=_!==null&&!t;vl&&(vl.style.display=c?"flex":"none");const u=gc(t),f=u.available&&!t;if(kl&&(kl.style.display=f?"flex":"none"),Ot){Ot.disabled=!f;const h=u.mixed||u.state===0?1:u.state,v=h===3?$n.tick3:h===2?$n.tick2:$n.tick1;Ot.innerHTML=v,Ot.classList.toggle("active",u.state>0&&!u.mixed),Ot.classList.toggle("mixed",u.mixed),Ot.setAttribute("aria-pressed",u.state>0&&!u.mixed?"true":"false"),Ot.dataset.tickState=u.mixed?"mixed":String(u.state);const k=u.mixed?"Znacznik zgodnoÅ›ci: rÃ³Å¼ne":u.state===0?"Znacznik zgodnoÅ›ci: brak":u.state===1?"Znacznik zgodnoÅ›ci: pojedynczy":u.state===2?"Znacznik zgodnoÅ›ci: podwÃ³jny":"Znacznik zgodnoÅ›ci: potrÃ³jny";Ot.title=k,Ot.setAttribute("aria-label",k)}e(Ur,G!==null&&!t),e(Yr,!t),e(qr,l&&!t);const p=document.getElementById("styleCircleRow");e(p,H!==null&&!t),e(Gr,!0),e(Vr,!t),on&&(on.style.display=G!==null&&!t?"":"none");const m=he?.value;bl.forEach(h=>{h.classList.toggle("active",h.dataset.type===m)});const x=document.getElementById("viewVerticesOption"),d=document.getElementById("viewEdgesOption");if(x&&d){const h=Al(),v=h==="vertices"||h==="both",k=h==="edges"||h==="both";x.classList.toggle("active",v),d.classList.toggle("active",k)}const y=document.getElementById("viewCirclePointsOption"),b=document.getElementById("viewCircleLineOption");if(y&&b){const h=Al(),v=h==="vertices"||h==="both",k=h==="edges"||h==="both";y.classList.toggle("active",v),b.classList.toggle("active",k)}if(_!==null&&sl&&rl&&ll){const h=s.lines[_],v=!!h.leftRay&&!h.leftRay.hidden,k=!!h.rightRay&&!h.rightRay.hidden,B=!v&&!k;sl.classList.toggle("active",B),rl.classList.toggle("active",v),ll.classList.toggle("active",k)}Ko()}function mc(e){Ft=e;const t=document.body,n=document.documentElement;t?.classList.remove("theme-dark","theme-light"),n?.classList.remove("theme-dark","theme-light"),ms(e);const i=X.palette;if(e==="light"?(t?.classList.add("theme-light"),n?.classList.add("theme-light")):(t?.classList.add("theme-dark"),n?.classList.add("theme-dark")),typeof window<"u")try{window.localStorage?.setItem(Fr,e)}catch{}Me.color=X.highlight,Me.width=X.highlightWidth,mo&&(mo.value=i[0]??X.defaultStroke),le&&(le.value=String(X.lineWidth)),tn=i.length?[i[0]]:[X.defaultStroke],ji(),Ko(),P()}function Ti(){if(!fe||!le||!he)return;const e=fe.value;Tl(e);const t=Number(le.value)||1,n=he.value;let i=!1;const o=c=>{const u=s.points[c];u&&(s.points[c]={...u,style:{...u.style,color:e,size:t}},i=!0)},l=c=>{if(!Re)return;const u=s.lines[c];if(!u)return;const f=new Set;u.points.forEach(p=>{f.has(p)||(f.add(p),o(p))})},r=c=>{if(!Re)return;const u=s.polygons[c];if(!u)return;const f=new Set;u.lines.forEach(p=>{s.lines[p]?.points.forEach(x=>{f.has(x)||(f.add(x),o(x))})})};if(z){switch(z.kind){case"point":s.points[z.id]?.label&&(s.points[z.id].label={...s.points[z.id].label,color:e},i=!0);break;case"line":s.lines[z.id]?.label&&(s.lines[z.id].label={...s.lines[z.id].label,color:e},i=!0);break;case"angle":s.angles[z.id]?.label&&(s.angles[z.id].label={...s.angles[z.id].label,color:e},i=!0);break;case"free":s.labels[z.id]&&(s.labels[z.id]={...s.labels[z.id],color:e},i=!0);break}i&&(P(),J());return}const a=c=>{if(!(We||q.size>0))return;zt(c);const f=s.lines[c],p=Math.max(0,f.points.length-1);(!f.segmentStyles||f.segmentStyles.length!==p)&&(f.segmentStyles=Array.from({length:p},()=>({...f.style})));const m=d=>{f.segmentStyles||(f.segmentStyles=[]),f.segmentStyles[d]={...f.segmentStyles[d]??f.style,color:e,width:t,type:n},i=!0},x=d=>{const b={...(d==="left"?f.leftRay:f.rightRay)??f.style,color:e,width:t,type:n};d==="left"?f.leftRay=b:f.rightRay=b,i=!0};if(q.size>0)q.forEach(d=>{const y=ro(d);!y||y.line!==c||(y.part==="segment"&&y.seg!==void 0?m(y.seg):y.part==="rayLeft"?x("left"):y.part==="rayRight"&&x("right"))});else{f.style={...f.style,color:e,width:t,type:n};for(let d=0;d<p;d++)m(d);f.leftRay&&(f.leftRay={...f.leftRay,color:e,width:t,type:n}),f.rightRay&&(f.rightRay={...f.rightRay,color:e,width:t,type:n})}};if(_!==null||j!==null){if(j!==null){const c=s.polygons[j];c?.lines.forEach(u=>{a(u),l(u)}),c&&r(j)}_!==null&&(a(_),l(_))}else if(H!==null){const c=s.circles[H],f=Sn(H).length;no(H,f);const p=m=>{c.arcStyles||(c.arcStyles=Array.from({length:f},()=>({...c.style}))),c.arcStyles[m]={...c.arcStyles[m]??c.style,color:e,width:t,type:n},i=!0};if(Z.size>0)Z.forEach(m=>{const x=Os(m);!x||x.circle!==H||x.arcIdx>=0&&x.arcIdx<f&&p(x.arcIdx)});else{c.style={...c.style,color:e,width:t,type:n},i=!0;for(let m=0;m<f;m++)p(m)}}else if(G!==null){const c=s.angles[G],u=ri.find(m=>m.classList.contains("active")),f=u?Number(u.dataset.count)||1:c.style.arcCount??1,p=xn?xn.classList.contains("active"):!1;s.angles[G]={...c,style:{...c.style,color:e,width:t,type:n,arcCount:f,right:p}},i=!0}else if(M!==null){const c=s.points[M];s.points[M]={...c,style:{...c.style,color:e,size:t}},i=!0}else if(re!==null){const c=s.inkStrokes[re];c&&(s.inkStrokes[re]={...c,color:e,baseWidth:t},i=!0)}else!i&&V==="handwriting"&&(Wr=t);i&&(P(),J())}function xc(e,t,n){const i=ut(),o=s.points[e],l=Je("circle",s);if(!o)return-1;const r=n.length?[...n]:[ae(s,{x:o.x+t,y:o.y,style:ue()})],a=[];r.forEach((p,m)=>{const x=s.points[p];if(!x)return;const d=Math.atan2(x.y-o.y,x.x-o.x),y=Number.isFinite(d)?d:m*(Math.PI/4),b={x:o.x+Math.cos(y)*t,y:o.y+Math.sin(y)*t};s.points[p]={...x,...b},m>0&&a.push(p)});const c=r[0];if(!Number.isFinite(t)||t<1e-6)return-1;const u={object_type:"circle",id:l,center:e,radius_point:c,points:a,style:i,circle_kind:"center-radius",construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}},f=s.circles.length;return s.circles.push(u),Ee(s,"circle",l,f),a.forEach(p=>Yo(p,[{kind:"circle",id:l}])),f}function Va(e){const t=Array.from(new Set(e));if(t.length!==3)return null;const[n,i,o]=t,l=s.points[n],r=s.points[i],a=s.points[o];if(!l||!r||!a)return null;const c=wc(l,r,a);if(!c)return null;const u=ae(s,{...c,style:ue()}),f=Math.hypot(c.x-l.x,c.y-l.y);if(!Number.isFinite(f)||f<1e-6)return Wn([u]),null;const p=ut(),m=Je("circle",s),x={object_type:"circle",id:m,center:u,radius_point:n,points:[],style:p,circle_kind:"three-point",defining_points:[n,i,o],construction_kind:"free",defining_parents:[],children:[],recompute:()=>{},on_parent_deleted:()=>{}},d=s.circles.length;return s.circles.push(x),Ee(s,"circle",m,d),d}function Ua(e){const t=s.circles[e];if(!t||!Lt(t))return;const[n,i,o]=t.defining_points,l=s.points[n],r=s.points[i],a=s.points[o];if(!l||!r||!a)return;const c=wc(l,r,a);if(!c)return;const u=Math.hypot(c.x-l.x,c.y-l.y);if(!Number.isFinite(u)||u<1e-6)return;const f=s.points[t.center];f&&(s.points[t.center]={...f,x:c.x,y:c.y},ve(t.center)),t.points.forEach(p=>{if(Uo(t,p))return;const m=s.points[p];if(!m)return;const x=Math.atan2(m.y-c.y,m.x-c.x);if(!Number.isFinite(x))return;const d={x:c.x+Math.cos(x)*u,y:c.y+Math.sin(x)*u};s.points[p]={...m,...d},ve(p)}),Zn(e)}function Mt(e){const t=new Set;s.circles.forEach((n,i)=>{Lt(n)&&n.defining_points.includes(e)&&(t.has(i)||(t.add(i),Ua(i)))}),ve(e)}function us(e){const t=s.points[e];if(!Vo(t))return;const[n,i]=t.midpoint.parents,o=Le(n),l=Le(i);if(o===null||l===null)return;const r=s.points[o],a=s.points[l];if(!r||!a)return;let c={x:(r.x+a.x)/2,y:(r.y+a.y)/2};const u=t.midpoint.parentLineId;if(u){const p=it(u);p!==null&&(c=po(p,c))}const f=xt(e,c);s.points[e]={...t,...f},ve(e)}function ql(e,t){if(!t||t.points.length<2)return null;const n=s.points[t.points[0]],i=s.points[t.points[t.points.length-1]];if(!n||!i)return null;const o=i.x-n.x,l=i.y-n.y,r=o*o+l*l;if(r<=1e-9)return null;const a=((e.x-n.x)*o+(e.y-n.y)*l)/r,c={x:n.x+o*a,y:n.y+l*a};return{x:2*c.x-e.x,y:2*c.y-e.y}}function Gl(e){const t=s.points[e];if(!so(t))return;const n=Le(t.symmetric.source);if(n===null)return;const i=s.points[n];if(!i)return;let o=null;if(t.symmetric.mirror.kind==="point"){const r=Le(t.symmetric.mirror.id);if(r===null)return;const a=s.points[r];if(!a)return;o={x:a.x*2-i.x,y:a.y*2-i.y}}else{const r=it(t.symmetric.mirror.id);if(r===null)return;const a=s.lines[r];if(!a)return;o=ql(i,a)}if(!o)return;const l=xt(e,o);s.points[e]={...t,...l},ve(e)}function Ya(e){const t=s.lines[e];if(!t)return;const n=t.id;s.points.forEach((i,o)=>{so(i)&&i.symmetric.mirror.kind==="line"&&i.symmetric.mirror.id===n&&Gl(o)})}function Xa(e){const t=s.points[e];if(!t)return;const n=t.id;s.lines.forEach((i,o)=>{Ei(i)&&(i.parallel.throughPoint===n||i.parallel.helperPoint===n)&&Ts(o)})}function Zt(e){const t=s.lines[e];if(!t)return;const n=t.id;s.lines.forEach((i,o)=>{o!==e&&Ei(i)&&i.parallel.referenceLine===n&&Ts(o)})}function Ka(e){const t=s.points[e];if(!t)return;const n=t.id;s.lines.forEach((i,o)=>{lo(i)&&(i.perpendicular.throughPoint===n||i.perpendicular.helperPoint===n)&&Cs(o)})}function Jt(e){const t=s.lines[e];if(!t)return;const n=t.id;s.lines.forEach((i,o)=>{o!==e&&lo(i)&&i.perpendicular.referenceLine===n&&Cs(o)})}function ve(e){const t=s.points[e];if(!t)return;const n=t.id;s.points.forEach((i,o)=>{if(Vo(i)&&(i.midpoint.parents[0]===n||i.midpoint.parents[1]===n)&&us(o),so(i)){const l=i.symmetric;(l.source===n||l.mirror.kind==="point"&&l.mirror.id===n)&&Gl(o)}}),Xa(e),Ka(e)}function Rl(e,t=He(),n=!0){const i=[];for(let o=s.circles.length-1;o>=0;o--){const l=s.circles[o];if(l.hidden&&!oe)continue;const r=s.points[l.center];if(!r)continue;const a=lt(l);if(a<=0)continue;const c=Math.hypot(r.x-e.x,r.y-e.y);(Math.abs(c-a)<=t||n&&c<=a)&&i.push({circle:o})}return i}function Js(e,t=He(),n=!0){const i=Rl(e,t,n);return i.length?i[0]:null}function Za(e,t,n){return e==="parallel"?_s(t,n):e==="perpendicular"?$s(t,n):null}function Hs(e){const t=[...e.defining_points,...e.points],n=new Set;let i=null;for(const o of t){if(o===void 0||n.has(o))continue;n.add(o);const l=s.points[o];if(!l)continue;if(!i){i=l;continue}const r=l.x-i.x,a=l.y-i.y,c=Math.hypot(r,a);if(c>1e-6)return{dir:{x:r/c,y:a/c},length:c}}return null}function _s(e,t){const n=s.points[e],i=s.lines[t];if(!n||!i||!i.id||!n.id)return null;const o=Hs(i);if(!o)return null;hi(t)??o.length;const l=.001,r={x:n.x+o.dir.x*l,y:n.y+o.dir.y*l},a=ae(s,{...r,style:{color:n.style.color,size:n.style.size,hidden:!0},construction_kind:"free"}),c=s.points[a];if(!c)return null;const f={...i.segmentStyles?.[0]??i.style,hidden:!1},p=Je("line",s),m={throughPoint:n.id,referenceLine:i.id,helperPoint:c.id},x={object_type:"line",id:p,points:[e,a],defining_points:[e,a],segmentStyles:[{...f}],segmentKeys:[Go(e,a)],leftRay:{...f,hidden:!1},rightRay:{...f,hidden:!1},style:f,hidden:!1,construction_kind:"parallel",defining_parents:[n.id,i.id],children:[],parallel:m,recompute:()=>{},on_parent_deleted:()=>{}};s.lines.push(x);const d=s.lines.length-1;return Ee(s,"line",p,d),s.lines[d]={...x,recompute:()=>Ts(d)},s.points[a]={...c,parallel_helper_for:p},Yo(a,[{kind:"line",id:p}]),Ts(d),zt(d),tt(d),ve(a),d}function $s(e,t){const n=s.points[e],i=s.lines[t];if(!n||!i||!i.id||!n.id)return null;const o=Hs(i);if(!o)return null;const l=hi(t)??o.length,r={x:-o.dir.y,y:o.dir.x},a=i.points[0],c=i.points[i.points.length-1],u=a!==void 0?s.points[a]:null,f=c!==void 0?s.points[c]:null,p=.001;let m=!1;if(u){const C={x:n.x-u.x,y:n.y-u.y},D=C.x*r.x+C.y*r.y;m=Math.abs(D)<=p}let x="normal",d=null,y=!1,b=!1;if(m)d={x:n.x+r.x*1,y:n.y+r.y*1},x="normal",y=!0,b=!0;else{if(u&&f){const C=wi(n,u,f);Math.hypot(C.x-n.x,C.y-n.y)>=p&&(x="projection",d=C)}if(!d&&(d=ql(n,i),!d||Math.hypot(d.x-n.x,d.y-n.y)<p)){const D=l>.001?l:120;d={x:n.x+r.x*D,y:n.y+r.y*D},x="normal"}}const h=ae(s,{...d,style:{color:n.style.color,size:n.style.size,hidden:y},construction_kind:"free"});x==="projection"&&js(t,h,d);let v=s.points[h];if(!v)return null;const k={x:v.x-n.x,y:v.y-n.y};let B=Math.hypot(k.x,k.y);(!Number.isFinite(B)||B<.001)&&(B=Math.max(l,120));const E=k.x*r.x+k.y*r.y>=0?1:-1,S={...i.segmentStyles?.[0]??i.style,hidden:!1},I=Je("line",s),L={throughPoint:n.id,referenceLine:i.id,helperPoint:v.id,helperDistance:B,helperOrientation:E};x==="projection"&&(L.helperMode="projection");const A={object_type:"line",id:I,points:[e,h],defining_points:[e,h],segmentStyles:[{...S}],segmentKeys:[Go(e,h)],leftRay:b?{...S,hidden:!1}:i.leftRay?{...i.leftRay}:{...S,hidden:!0},rightRay:b?{...S,hidden:!1}:i.rightRay?{...i.rightRay}:{...S,hidden:!0},style:S,hidden:!1,construction_kind:"perpendicular",defining_parents:[n.id,i.id],children:[],perpendicular:L,recompute:()=>{},on_parent_deleted:()=>{}};s.lines.push(A);const R=s.lines.length-1;Ee(s,"line",I,R),s.lines[R]={...A,recompute:()=>Cs(R)},v=s.points[h],s.points[h]={...v,perpendicular_helper_for:I};const T=[{kind:"line",id:I}];return x==="projection"&&i.id&&T.push({kind:"line",id:i.id}),Yo(h,T),Cs(R),zt(R),tt(R),ve(h),R}function Ts(e){if(Ys.has(e))return;const t=s.lines[e];if(!Ei(t))return;const n=Le(t.parallel.throughPoint),i=Le(t.parallel.helperPoint),o=it(t.parallel.referenceLine);if(n===null||i===null||o===null)return;const l=s.points[n],r=s.points[i],a=s.lines[o];if(!l||!r||!a)return;const c=Hs(a);if(c){Ys.add(e);try{const u=c.dir,f=new Map;if(t.points.forEach(x=>{const d=s.points[x];if(!d)return;const y={x:d.x-l.x,y:d.y-l.y},b=y.x*u.x+y.y*u.y;f.set(x,b)}),!f.has(i)){const x={x:r.x-l.x,y:r.y-l.y};f.set(i,x.x*u.x+x.y*u.y)}const p=f.get(i)??0;if(Math.abs(p)<1e-6){const x=hi(o)??c.length,d=Math.max(x,120);f.set(i,d)}const m=new Set;f.forEach((x,d)=>{if(d===n)return;const y={x:l.x+u.x*x,y:l.y+u.y*x},b=s.points[d];if(!b)return;const h=xt(d,y);(Math.abs(b.x-h.x)>1e-6||Math.abs(b.y-h.y)>1e-6)&&(s.points[d]={...b,...h},m.add(d))}),t.points.includes(n)||t.points.unshift(n),t.points.includes(i)||t.points.push(i),t.defining_points=[n,i],zt(e),Rs(e),m.forEach(x=>ve(x)),tt(e),Zt(e),Jt(e)}finally{Ys.delete(e)}}}function Cs(e){if(Xs.has(e))return;const t=s.lines[e];if(!lo(t))return;const n=Le(t.perpendicular.throughPoint),i=Le(t.perpendicular.helperPoint),o=it(t.perpendicular.referenceLine);if(n===null||i===null||o===null)return;const l=s.points[n];let r=s.points[i];const a=s.lines[o];if(!l||!r||!a)return;const c=Hs(a);if(c){Xs.add(e);try{const u={x:-c.dir.y,y:c.dir.x},f=t.perpendicular.helperMode??"normal";if(f==="projection"&&a.points.length>=2){const k=a.points[0],B=a.points[a.points.length-1],E=k!==void 0?s.points[k]:null,w=B!==void 0?s.points[B]:null;if(E&&w){const S=wi(l,E,w),I=xt(i,S);(Math.abs(r.x-I.x)>1e-6||Math.abs(r.y-I.y)>1e-6)&&(s.points[i]={...r,...I},r=s.points[i]),r=s.points[i]}}const p={x:r.x-l.x,y:r.y-l.y},m=p.x*u.x+p.y*u.y;let x=t.perpendicular.helperOrientation??(m>=0?1:-1);M===i&&ht&&(x=m>=0?1:-1),f==="projection"&&(x=m>=0?1:-1),t.perpendicular.helperOrientation=x;const d=x===1?u:{x:-u.x,y:-u.y},y=new Map;t.points.forEach(k=>{const B=s.points[k];if(!B)return;const E={x:B.x-l.x,y:B.y-l.y},w=E.x*d.x+E.y*d.y;y.set(k,w)});const b=p.x*d.x+p.y*d.y;let h=t.perpendicular.helperDistance;if(f==="projection")h=Math.abs(b),t.perpendicular.helperDistance=h;else if(M===i&&ht){let k=Math.abs(b);if(!Number.isFinite(k)||k<.001){const B=Math.abs(b);if(Number.isFinite(B)&&B>.001)k=B;else{const E=hi(o)??c.length;k=E>.001?E:120}}h=k,t.perpendicular.helperDistance=h}else if(h===void 0||h<.001){let k=Math.abs(b);if(!Number.isFinite(k)||k<.001){const B=hi(o)??c.length;k=B>.001?B:120}h=k,t.perpendicular.helperDistance=h}if(h=t.perpendicular.helperDistance??h??0,!Number.isFinite(h)||h<.001){const k=hi(o)??c.length;h=k>.001?k:120}t.perpendicular.helperDistance=h,y.set(i,h);const v=new Set;y.forEach((k,B)=>{if(B===n)return;const E={x:l.x+d.x*k,y:l.y+d.y*k},w=s.points[B];if(!w)return;const S=xt(B,E);(Math.abs(w.x-S.x)>1e-6||Math.abs(w.y-S.y)>1e-6)&&(s.points[B]={...w,...S},v.add(B))}),t.points.includes(n)||t.points.unshift(n),t.points.includes(i)||t.points.push(i),t.defining_points=[n,i],zt(e),Rs(e),v.forEach(k=>ve(k)),tt(e),Zt(e),Jt(e)}finally{Xs.delete(e)}}}function J(){jt();const e={model:nt(s),panOffset:{...Oe},zoom:ne,labelState:{upperIdx:Bn,lowerIdx:xi,greekIdx:bi,freeUpper:[...qn],freeLower:[...Gn],freeGreek:[...Vn]}};zn=zn.slice(0,Wt+1),zn.push(e),Wt=zn.length-1,vc()}function nt(e){if(typeof structuredClone=="function")try{return structuredClone(e)}catch{}return JSON.parse(JSON.stringify(e))}function Ja(){jt();const e=s.points.map(l=>{const{incident_objects:r,recompute:a,on_parent_deleted:c,...u}=l;return{...nt(u),incident_objects:Array.from(r)}}),t=s.lines.map(l=>{const{recompute:r,on_parent_deleted:a,...c}=l;return nt(c)}),n=s.circles.map(l=>{const{recompute:r,on_parent_deleted:a,...c}=l;return nt(c)}),i=s.angles.map(l=>{const{recompute:r,on_parent_deleted:a,...c}=l;return nt(c)}),o=s.polygons.map(l=>{const{recompute:r,on_parent_deleted:a,...c}=l;return nt(c)});return{version:Zr,model:{points:e,lines:t,circles:n,angles:i,polygons:o,inkStrokes:nt(s.inkStrokes),labels:nt(s.labels),idCounters:nt(s.idCounters)},panOffset:{...Oe},zoom:ne,labelState:{upper:Bn,lower:xi,greek:bi,freeUpper:[...qn],freeLower:[...Gn],freeGreek:[...Vn]},recentColors:[...tn],showHidden:oe,measurementReferenceSegment:Ai,measurementReferenceValue:ei}}function Qa(e){if(!e||typeof e!="object")throw new Error("Brak danych w pliku JSON");const t=e;if(t.version!==Zr)throw new Error("NieobsÅ‚ugiwana wersja pliku JSON");if(!t.model)throw new Error("Brak sekcji modelu w pliku JSON");Qr();const n=t.model,i=d=>{const y=nt(d),b=Array.isArray(y.incident_objects)?y.incident_objects:[];y.label&&(y.label={...y.label,fontSize:Rt(y.label.fontSize)});const{incident_objects:h,...v}=y;return{...v,incident_objects:new Set(b.map(k=>String(k))),recompute:()=>{},on_parent_deleted:()=>{}}},o=d=>{const y=nt(d);return y.label&&(y.label={...y.label,fontSize:Rt(y.label.fontSize)}),{...y,recompute:()=>{},on_parent_deleted:()=>{}}},l=d=>{const y=nt(d);return y.label&&(y.label={...y.label,fontSize:Rt(y.label.fontSize)}),{...y,recompute:()=>{},on_parent_deleted:()=>{}}},r=d=>{const y=nt(d);return y.label&&(y.label={...y.label,fontSize:Rt(y.label.fontSize)}),{...y,recompute:()=>{},on_parent_deleted:()=>{}}},a=d=>({...nt(d),recompute:()=>{},on_parent_deleted:()=>{}}),c={points:Array.isArray(n.points)?n.points.map(i):[],lines:Array.isArray(n.lines)?n.lines.map(o):[],circles:Array.isArray(n.circles)?n.circles.map(l):[],angles:Array.isArray(n.angles)?n.angles.map(r):[],polygons:Array.isArray(n.polygons)?n.polygons.map(a):[],inkStrokes:Array.isArray(n.inkStrokes)?nt(n.inkStrokes):[],labels:Array.isArray(n.labels)?nt(n.labels).map(d=>({...d,fontSize:Rt(d.fontSize)})):[],idCounters:{point:0,line:0,circle:0,angle:0,polygon:0},indexById:{point:{},line:{},circle:{},angle:{},polygon:{}}},u=n.idCounters??{},f={point:Number(u.point)||0,line:Number(u.line)||0,circle:Number(u.circle)||0,angle:Number(u.angle)||0,polygon:Number(u.polygon)||0},p=(d,y)=>{if(!y)return;const b=zr[d];if(!y.startsWith(b))return;const h=Number(y.slice(b.length));Number.isFinite(h)&&h>f[d]&&(f[d]=h)};c.points.forEach(d=>p("point",d.id)),c.lines.forEach(d=>p("line",d.id)),c.circles.forEach(d=>p("circle",d.id)),c.angles.forEach(d=>p("angle",d.id)),c.polygons.forEach(d=>p("polygon",d.id)),c.idCounters=f,s=c,Oe=t.panOffset?{x:Number(t.panOffset.x)||0,y:Number(t.panOffset.y)||0}:{x:0,y:0},ne=Ge(Number(t.zoom)||1,As,Ds);const m=d=>Array.isArray(d)?d.map(y=>typeof y=="number"?y:Number(y)).filter(y=>Number.isFinite(y)):[],x=t.labelState??{upper:0,lower:0,greek:0,freeUpper:[],freeLower:[],freeGreek:[]};if(Bn=Number(x.upper)||0,xi=Number(x.lower)||0,bi=Number(x.greek)||0,qn=m(x.freeUpper),Gn=m(x.freeLower),Vn=m(x.freeGreek),jt(),M=null,_=null,H=null,G=null,j=null,z=null,q.clear(),Z.clear(),Cn=null,ii=!1,oi=null,Jn=null,ot=null,Nt=[],Qn=[],pt=null,It=[],Ye=null,Bt=null,Rn=null,Et=null,at=null,Kt=null,Tn=null,ci=null,mn=[],Ht=null,Pe=null,bn=null,ht=!1,di=null,$e=null,jr=null,Qi=!1,xs={x:0,y:0},bs={x:0,y:0},_e={x:0,y:0},No=null,et=null,oe=!!t.showHidden,fi=!1,Vi=!1,Ui=!1,Yi=!1,Ke=!1,Ki=!1,ft=null,Ai=t.measurementReferenceSegment??null,ei=typeof t.measurementReferenceValue=="number"?t.measurementReferenceValue:null,Ai&&ei&&ei>0){const{lineIdx:d,segIdx:y}=Ai;d>=0&&d<s.lines.length?Fn=zs(d,y)/ei:(Fn=null,Ai=null,ei=null)}else Fn=null;je=[],il=0,wt=!1,Oo=null,to(),Zl(),jo(),hn(),Wo(),qo(),Ie("move"),Array.isArray(t.recentColors)&&t.recentColors.length>0&&(tn=t.recentColors.map(d=>String(d)).slice(0,20),Ko()),$(),ji(),P(),zn=[],Wt=-1,J(),li&&requestAnimationFrame(()=>Kl())}function ed(){Wt<=0||(Wt-=1,bc())}function td(){Wt>=zn.length-1||(Wt+=1,bc())}function bc(){const e=zn[Wt];e&&(s=nt(e.model),Oe={...e.panOffset},ne=Ge(e.zoom??1,As,Ds),e.labelState&&(Bn=e.labelState.upperIdx,xi=e.labelState.lowerIdx,bi=e.labelState.greekIdx,qn=[...e.labelState.freeUpper],Gn=[...e.labelState.freeLower],Vn=[...e.labelState.freeGreek]),jt(),_=null,M=null,j=null,H=null,G=null,Z.clear(),$(),vc(),P())}function vc(){al?.classList.toggle("disabled",Wt<=0),dl?.classList.toggle("disabled",Wt>=zn.length-1)}async function Br(){if(!ce)throw new Error("PÅ‚Ã³tno jest niedostÄ™pne");return await new Promise((e,t)=>{ce.toBlob(n=>{n?e(n):t(new Error("Brak danych obrazu"))},"image/png")})}function nd(){if(Yi=!Yi,Yi){if(xo&&Mi){const e=xo.getBoundingClientRect();Mi.style.position="fixed",Mi.style.top=`${e.bottom+6}px`,Mi.style.left=`${e.left}px`,Mi.style.right="auto"}bo?.classList.add("open")}else hn()}function hn(){Yi=!1,bo?.classList.remove("open")}function id(){ln&&(fi=!fi,fi?(Ce&&(Ce=!1,Ae=null,$()),kc()):jo())}function jo(){fi=!1,ln?.classList.remove("open")}function kc(){if(ln){if(pn){pn.style.position="fixed";const e=ul?.getBoundingClientRect();pn.style.top=`${e?e.bottom+6:52}px`,pn.style.left=`${e?e.left:8}px`,pn.style.right="auto",pn.style.width="auto",pn.style.minWidth="240px",pn.style.maxWidth="360px"}ln.classList.add("open"),fi=!0,dn()}}function Al(){return We&&Re?"both":Re&&!We?"vertices":"edges"}function is(e){e==="edges"?(We=!We,!We&&!Re&&(Re=!0)):(Re=!Re,!We&&!Re&&(We=!0)),$(),dn(),P(),Wo()}function od(){if(Vi=!Vi,Vi){if(ui&&Hn){const e=Hn.querySelector(".dropdown-menu");if(e){const t=ui.getBoundingClientRect();e.style.position="fixed",e.style.top=`${t.bottom+6}px`,e.style.left=`${t.left}px`,e.style.right="auto"}}Hn?.classList.add("open")}else Wo()}function Wo(){Vi=!1,Hn?.classList.remove("open")}function Qs(e){if(_===null)return;const t=s.lines[_],n=l=>{l==="left"&&!t.leftRay&&(t.leftRay={...t.style,hidden:!0}),l==="right"&&!t.rightRay&&(t.rightRay={...t.style,hidden:!0})};n("left"),n("right");const i=!!t.leftRay&&!t.leftRay.hidden,o=!!t.rightRay&&!t.rightRay.hidden;if(e==="segment")!i&&!o?(t.leftRay.hidden=!1,t.rightRay.hidden=!1):(t.leftRay.hidden=!0,t.rightRay.hidden=!0);else if(e==="right"){const l=!o;t.rightRay.hidden=!l,t.leftRay||(t.leftRay={...t.style,hidden:!0}),!(!!t.leftRay&&!t.leftRay.hidden)&&!l&&(t.leftRay.hidden=!0,t.rightRay.hidden=!0)}else if(e==="left"){const l=!i;t.leftRay.hidden=!l,t.rightRay||(t.rightRay={...t.style,hidden:!0}),!(!!t.rightRay&&!t.rightRay.hidden)&&!l&&(t.leftRay.hidden=!0,t.rightRay.hidden=!0)}dn(),$(),P(),J(),qo()}function sd(){if(Ui=!Ui,Ui){if(vs&&Gi){const e=Gi.querySelector(".dropdown-menu");if(e){const t=vs.getBoundingClientRect();e.style.position="fixed",e.style.top=`${t.bottom+6}px`,e.style.left=`${t.left}px`,e.style.right="auto"}}Gi?.classList.add("open")}else qo()}function qo(){Ui=!1,Gi?.classList.remove("open")}function Bi(e,t=!1){if(!e.length)return;const n=new Set(e),i=[];if(t){const o=new Map,l=[];s.lines.forEach((r,a)=>{if(r.defining_points.some(c=>n.has(c))){if(r.label&&be(r.label),o.set(a,-1),Ei(r)){const c=Le(r.parallel.helperPoint);c!==null&&i.push(c)}}else{const c=r.points.filter(u=>!n.has(u));o.set(a,l.length),l.push({...r,points:c})}}),s.lines=l,gi(o),mi(o),s.circles=s.circles.filter(r=>{const a=n.has(r.center)||n.has(r.radius_point)||Lt(r)&&r.defining_points.some(c=>n.has(c));return a&&r.label&&be(r.label),!a}),s.angles=s.angles.filter(r=>n.has(r.vertex)?(r.label&&be(r.label),!1):!0)}else{const o=new Map,l=[];s.lines.forEach((r,a)=>{const c=r.points.filter(m=>!n.has(m));if(c.length<2){r.label&&be(r.label),o.set(a,-1);return}const u=Math.max(0,c.length-1),f=r.segmentStyles&&r.segmentStyles.length?Array.from({length:u},(m,x)=>r.segmentStyles[Math.min(x,r.segmentStyles.length-1)]):void 0,p={...r,points:c,segmentStyles:f};o.set(a,l.length),l.push(p)}),s.lines=l,gi(o),mi(o),s.circles=s.circles.map(r=>{if(n.has(r.center)||n.has(r.radius_point)||Lt(r)&&r.defining_points.some(c=>n.has(c)))return r.label&&be(r.label),null;const a=r.points.filter(c=>!n.has(c));return{...r,points:a}}).filter(r=>r!==null),s.angles=s.angles.filter(r=>n.has(r.vertex)?(r.label&&be(r.label),!1):!0)}i.length&&i.filter(o=>!n.has(o)).forEach(o=>{n.add(o),e.push(o)}),e.forEach(o=>{const l=s.points[o];l?.label&&be(l.label)}),Wn(e)}function Mr(e){if(!e)return[];const t=[],n=[],i=[];if(s.lines.forEach((r,a)=>{if(!Ei(r)||r.parallel.referenceLine!==e)return;r.label&&be(r.label),t.push(a),i.push(r.id);const c=Le(r.parallel.helperPoint);c!==null&&n.push(c)}),!t.length)return[];const o=new Map,l=[];if(s.lines.forEach((r,a)=>{t.includes(a)?o.set(a,-1):(o.set(a,l.length),l.push(r))}),s.lines=l,gi(o),mi(o),n.length){const r=Array.from(new Set(n));Wn(r,!1)}else jt();return Vl(),i}function ld(e){if(!e)return[];const t=[],n=[],i=[];if(s.lines.forEach((r,a)=>{if(!lo(r)||r.perpendicular.referenceLine!==e)return;r.label&&be(r.label),t.push(a),i.push(r.id);const c=Le(r.perpendicular.helperPoint);c!==null&&n.push(c)}),!t.length)return[];const o=new Map,l=[];if(s.lines.forEach((r,a)=>{t.includes(a)?o.set(a,-1):(o.set(a,l.length),l.push(r))}),s.lines=l,gi(o),mi(o),n.length){const r=Array.from(new Set(n));Wn(r,!1)}else jt();return Vl(),i}function Wn(e,t=!0){[...e].sort((i,o)=>o-i).forEach(i=>{const o=s.points[i];o?.label&&be(o.label),s.points.splice(i,1),s.lines.forEach(l=>{const r=l.defining_points.map(a=>a>i?a-1:a);l.defining_points=[r[0],r[1]],l.points=l.points.map(a=>a>i?a-1:a)}),s.circles=s.circles.map(l=>{if(l.center===i||Lt(l)&&l.defining_points.includes(i)||l.radius_point===i)return null;const r=l.center>i?l.center-1:l.center,a=l.radius_point>i?l.radius_point-1:l.radius_point,c=l.points.map(u=>u>i?u-1:u).filter(u=>u!==i);if(Lt(l)){const u=l.defining_points.map(f=>f>i?f-1:f);return{...l,center:r,radius_point:a,points:c,defining_points:u}}return{...l,center:r,radius_point:a,points:c}}).filter(l=>l!==null)}),s.lines.forEach((i,o)=>zt(o)),jt(),t&&Vl()}function Vl(){const e=new Set;s.points.forEach((t,n)=>{if(Vo(t)&&t.midpoint.parents.some(o=>Le(o)===null)&&e.add(n),so(t)){const i=Le(t.symmetric.source)===null,o=t.symmetric.mirror.kind==="point"?Le(t.symmetric.mirror.id)===null:it(t.symmetric.mirror.id)===null;(i||o)&&e.add(n)}t.parallel_helper_for&&it(t.parallel_helper_for)===null&&e.add(n),t.perpendicular_helper_for&&it(t.perpendicular_helper_for)===null&&e.add(n)}),e.size&&Wn(Array.from(e),!1)}function Ec(e){const t=s.points[e];return t?!!(s.lines.some(r=>r.points.includes(e))||s.circles.some(r=>r.center===e||r.radius_point===e?!0:r.points.includes(e))||s.angles.some(r=>r.vertex===e)||s.polygons.some(r=>r.lines.some(a=>{const c=s.lines[a];return!!c&&c.points.includes(e)}))||t.children.length>0||t.parent_refs.length>0||t.parallel_helper_for||t.perpendicular_helper_for):!1}function rd(e){const t=s.points[e];t?.label&&(Ec(e)||(be(t.label),s.points[e]={...t,label:void 0}))}function hi(e){const t=s.lines[e];if(!t||t.points.length<2)return null;const n=s.points[t.points[0]],i=s.points[t.points[t.points.length-1]];return!n||!i?null:Math.hypot(i.x-n.x,i.y-n.y)}function wc(e,t,n){const i=2*(e.x*(t.y-n.y)+t.x*(n.y-e.y)+n.x*(e.y-t.y));if(Math.abs(i)<1e-6)return null;const o=((e.x*e.x+e.y*e.y)*(t.y-n.y)+(t.x*t.x+t.y*t.y)*(n.y-e.y)+(n.x*n.x+n.y*n.y)*(e.y-t.y))/i,l=((e.x*e.x+e.y*e.y)*(n.x-t.x)+(t.x*t.x+t.y*t.y)*(e.x-n.x)+(n.x*n.x+n.y*n.y)*(t.x-e.x))/i;return{x:o,y:l}}function Ln(e,t,n){return t==="segment"?`${e}:s:${n??0}`:`${e}:${t}`}function el(e){return Ln(e.line,e.part,e.part==="segment"?e.seg:void 0)}function fs(e){Array.from(q).forEach(t=>{const n=ro(t);n&&n.line===e&&q.delete(t)})}function ro(e){if(e.includes(":s:")){const[o,,l]=e.split(":"),r=Number(o),a=Number(l);return Number.isNaN(r)||Number.isNaN(a)?null:{line:r,part:"segment",seg:a}}const[t,n]=e.split(":"),i=Number(t);return Number.isNaN(i)?null:n==="rayLeft"||n==="rayRight"?{line:i,part:n}:null}function cd(e){const t=s.lines[e.line];if(!t)return null;if(e.part==="segment"){const m=s.points[t.points[e.seg]],x=s.points[t.points[e.seg+1]];return!m||!x?null:{a:m,b:x}}const n=t.points[0],i=t.points[t.points.length-1],o=e.part==="rayLeft"?n:i,l=e.part==="rayLeft"?t.points[1]??i:t.points[t.points.length-2]??n,r=s.points[o],a=s.points[l];if(!r||!a)return null;const c=(ce?ce.width+ce.height:2e3)/Qe,u={x:r.x-a.x,y:r.y-a.y},f=Math.hypot(u.x,u.y)||1,p={x:u.x/f,y:u.y/f};return{a:r,b:{x:r.x+p.x*c,y:r.y+p.y*c}}}function ad(e,t){const n=Math.max(0,e.points.length-1),i=e.segmentStyles?.length?e.segmentStyles:void 0;e.segmentKeys;const o=[],l=[];for(let r=0;r<n;r++){let a=r;r>=t&&(a=Math.max(0,r-1));const c=i?.[Math.min(a,(i?.length??1)-1)]??e.style;o.push({...c});const u=Go(e.points[r],e.points[r+1]);l.push(u)}e.segmentStyles=o,e.segmentKeys=l}function dd(e,t,n,i){const o=s.lines[t.line];if(!o)return;const l=s.points[e];if(l){if(t.part==="segment"){const r=o.points[t.seg],a=o.points[t.seg+1],c=s.points[r],u=s.points[a];if(!c||!u)return;const f=i??ud(n,c,u);s.points[e]={...l,x:f.x,y:f.y},o.points.splice(t.seg+1,0,e);const p=o.segmentStyles?.[t.seg]??o.style;o.segmentStyles||(o.segmentStyles=[]),o.segmentStyles.splice(t.seg,1,{...p},{...p})}else if(t.part==="rayLeft"||t.part==="rayRight"){if(o.points.length<1)return;const r=t.part==="rayLeft"?o.points[0]:o.points[o.points.length-1],a=t.part==="rayLeft"?o.points[1]??r:o.points[o.points.length-2]??r,c=s.points[r],u=s.points[a];if(!c||!u)return;const f=i??wi(n,c,u);if(s.points[e]={...l,x:f.x,y:f.y},t.part==="rayLeft"){const p=Math.min(1,o.points.length);o.points.splice(p,0,e),Rs(t.line),fs(t.line),q.add(Ln(t.line,"segment",0))}else{const p=Math.max(o.points.length-1,1);o.points.splice(p,0,e),Rs(t.line),fs(t.line);const m=Math.max(0,o.points.length-2);q.add(Ln(t.line,"segment",m))}}o.id&&Yo(e,[{kind:"line",id:o.id}]),zt(t.line),fs(t.line),Ws(e)}}function ud(e,t,n){const i=(n.x-t.x)**2+(n.y-t.y)**2;if(i===0)return{x:t.x,y:t.y};const o=Math.max(0,Math.min(1,((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/i));return{x:t.x+(n.x-t.x)*o,y:t.y+(n.y-t.y)*o}}function wi(e,t,n){const i=(n.x-t.x)**2+(n.y-t.y)**2;if(i===0)return{x:t.x,y:t.y};const o=((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/i;return{x:t.x+(n.x-t.x)*o,y:t.y+(n.y-t.y)*o}}function xt(e,t){const n=dc(e);if(!n.length)return t;const i=s.circles[n[0]],o=s.points[i.center],l=s.points[e];if(!o||!l)return t;const r=lt(i);if(r<=0)return t;let a={x:t.x-o.x,y:t.y-o.y},c=Math.hypot(a.x,a.y);c<1e-6&&(a={x:l.x-o.x,y:l.y-o.y},c=Math.hypot(a.x,a.y)||1);const u={x:a.x/c,y:a.y/c};return{x:o.x+u.x*r,y:o.y+u.y*r}}function Dl(e,t){const n=s.points[e];if(!n)return t;const i=Nl(n);if(!i||i.points.length<2)return t;const o=s.points[i.points[0]],l=s.points[i.points[i.points.length-1]];return!o||!l?t:wi(t,o,l)}function po(e,t){if(e==null)return t;const n=s.lines[e];if(!n||n.points.length<2)return t;const i=n.defining_points?.[0]??n.points[0],o=n.defining_points?.[1]??n.points[n.points.length-1],l=s.points[i],r=s.points[o];return!l||!r?t:wi(t,l,r)}function Sc(e,t,n,i,o=!0){const l=t.x-e.x,r=t.y-e.y,a=e.x-n.x,c=e.y-n.y,u=l*l+r*r,f=2*(a*l+c*r),p=a*a+c*c-i*i,m=f*f-4*u*p;if(m<0)return[];const x=Math.sqrt(m),d=(-f-x)/(2*u),y=(-f+x)/(2*u),b=[];return[d,y].forEach(h=>{Number.isFinite(h)&&(o&&(h<0||h>1)||b.push({x:e.x+l*h,y:e.y+r*h}))}),b}function fd(e,t){const n=s.points[e],i=s.points[t];if(!n||!i)return;const o={...ut(),hidden:!0},l=Ze(s,e,t,o),r=(n.x+i.x)/2,a=(n.y+i.y)/2,c=ae(s,{x:r,y:a,style:ue(),construction_kind:"midpoint",midpoint:{parents:[n.id,i.id],parentLineId:s.lines[l]?.id||null}}),u=$s(c,l);u!==null&&(_=u,M=null)}function pd(e,t){const n=s.lines[e];if(!n||t>=n.points.length-1)return;const i=n.points[t],o=n.points[t+1],l=s.points[i],r=s.points[o];if(!l||!r)return;const a=(l.x+r.x)/2,c=(l.y+r.y)/2,u=ae(s,{x:a,y:c,style:ue(),construction_kind:"midpoint",midpoint:{parents:[l.id,r.id],parentLineId:n.id}});js(e,u,{x:a,y:c});const f=$s(u,e);f!==null&&(_=f,M=null)}function Pr(e,t){const n=s.points[e],i=s.circles[t];if(!n||!i)return;const o=s.points[i.center];if(!o)return;const l=lt(i);if(l<=1e-6)return;const r=Math.hypot(n.x-o.x,n.y-o.y);if(r<l-.01){M=null,H=null,_=null;return}if(Math.abs(r-l)<.01){const c=ae(s,{x:o.x,y:o.y,style:{color:n.style.color,size:n.style.size,hidden:!0},construction_kind:"free"}),u={...ut(),hidden:!0},f=Ze(s,c,e,u),p=$s(e,f);p!==null&&(_=p,M=null,H=null)}else{const c=(n.x+o.x)/2,u=(n.y+o.y)/2,f=ae(s,{x:c,y:u,style:{color:n.style.color,size:n.style.size,hidden:!0},construction_kind:"free"}),p=Math.hypot(n.x-c,n.y-u),m=xc(f,p,[e]),x=s.circles[m];x&&(x.style={...x.style,hidden:!0},x.hidden=!0);const d=Ul({x:c,y:u},p,{x:o.x,y:o.y},l);if(d.length>0){const y=[];for(const h of d){const v=ae(s,{...h,style:ue(),construction_kind:"free"});zl(t,v,h),zl(m,v,h),y.push(v)}const b=ut();for(let h=0;h<y.length;h++){const v=y[h],k=Ze(s,e,v,b),B=s.lines[k];if(B){const E=s.points[B.points[0]],w=s.points[B.points[B.points.length-1]];E&&w&&(Math.hypot(E.x-n.x,E.y-n.y)<.001?(B.leftRay={...b,hidden:!0},B.rightRay={...b,hidden:!1}):(B.leftRay={...b,hidden:!1},B.rightRay={...b,hidden:!0}))}}if(y.length>0){const h=s.lines.findIndex(v=>v.points.includes(e)&&v.points.includes(y[0]));h>=0&&(_=h,M=null,H=null)}}}}function Ul(e,t,n,i){const o=Math.hypot(n.x-e.x,n.y-e.y);if(o===0||o>t+i||o<Math.abs(t-i))return[];const l=(t*t-i*i+o*o)/(2*o),r=Math.sqrt(Math.max(t*t-l*l,0)),a=e.x+l*(n.x-e.x)/o,c=e.y+l*(n.y-e.y)/o,u=-(n.y-e.y)*(r/o),f=-(n.x-e.x)*(r/o);return[{x:a+u,y:c-f},{x:a-u,y:c+f}]}function js(e,t,n){const i=s.lines[e];if(!i||i.points.includes(t))return;const o=s.points[i.points[0]],l=s.points[i.points[i.points.length-1]];if(!o||!l)return;const r=qe({x:l.x-o.x,y:l.y-o.y}),a=Math.hypot(l.x-o.x,l.y-o.y)||1,c=m=>((m.x-o.x)*r.x+(m.y-o.y)*r.y)/a,u=c(n);let p=i.points.map(m=>c(s.points[m])).findIndex(m=>m>u+1e-6);p===-1&&(p=i.points.length),i.points.splice(p,0,t),ad(i,p),fs(e)}function zl(e,t,n){const i=s.circles[e],o=s.points[i.center];if(!i||!o)return;const l=lt(i);if(l<=0)return;const r=Math.atan2(n.y-o.y,n.x-o.x),a={x:o.x+Math.cos(r)*l,y:o.y+Math.sin(r)*l};s.points[t]={...s.points[t],...a},i.points.includes(t)||i.points.push(t),Yo(t,[{kind:"circle",id:i.id}]),H===e&&Z.clear(),Ws(t)}function Yl(e,t,n,i){const o=t.x-e.x,l=t.y-e.y,r=i.x-n.x,a=i.y-n.y,c=o*a-l*r;if(Math.abs(c)<1e-6)return null;const u=((n.x-e.x)*a-(n.y-e.y)*r)/c;return{x:e.x+o*u,y:e.y+l*u}}function Xl(e){const t=s.lines[e];if(!t||t.points.length<2)return;const n=s.points[t.points[0]],i=s.points[t.points[t.points.length-1]];!n||!i||t.points.forEach(o=>{const l=$t(o).filter(r=>r!==e);l.length&&l.forEach(r=>{const a=s.lines[r];if(!a||a.points.length<2)return;const c=s.points[a.points[0]],u=s.points[a.points[a.points.length-1]];if(!c||!u)return;const f=Yl(n,i,c,u);f&&(s.points[o]={...s.points[o],...f})})})}function Lc(e){const t=s.lines[e];if(!t||t.hidden&&!oe||!((!t.leftRay||t.leftRay.hidden)&&(!t.rightRay||t.rightRay.hidden)))return null;const i=oo(e);if(!i)return null;const o=i.endPointCoord,l=26,r={x:o.x-i.center.x,y:o.y-i.center.y},a=Math.hypot(r.x,r.y)||1,c={x:r.x/a,y:r.y/a},u={x:-c.y,y:c.x},f=8;return{x:o.x+c.x*l+u.x*f,y:o.y+c.y*l+u.y*f}}function oo(e){const t=s.lines[e];if(!t||t.points.length<2)return null;const n=s.points[t.points[0]],i=s.points[t.points[t.points.length-1]];if(!n||!i)return null;const o={x:i.x-n.x,y:i.y-n.y},l=Math.hypot(o.x,o.y)||1,r={x:o.x/l,y:o.y/l},a=n,c=[];if(t.points.forEach(h=>{if(!c.some(v=>v.idx===h)){const v=s.points[h];v&&c.push({idx:h,proj:(v.x-a.x)*r.x+(v.y-a.y)*r.y})}}),!c.length)return null;const u=c.sort((h,v)=>h.proj-v.proj),f=u[0],p=u[u.length-1],m=(f.proj+p.proj)/2,x={x:a.x+r.x*m,y:a.y+r.y*m},d=s.points[f.idx],y=s.points[p.idx],b=Math.abs(p.proj-m);return{center:x,centerProj:m,dir:r,startPoint:d,endPoint:y,order:u,half:b,endPointIdx:p.idx,endPointCoord:y??{x:a.x+r.x*p.proj,y:a.y+r.y*p.proj}}}function yd(e,t){const n=s.lines[e];if(!n)return;const i=n.points.map(a=>s.points[a]).filter(a=>!!a);if(!i.length)return;const o=n.points.filter(a=>{const c=s.points[a];return!(!c||!gn(c)||ni(a).length>0)});if(!o.length)return;const l=t==="horizontal"?i.reduce((a,c)=>a+c.y,0)/i.length:i.reduce((a,c)=>a+c.x,0)/i.length,r=new Set;o.forEach(a=>{const c=s.points[a];c&&(t==="horizontal"?c.y!==l&&(s.points[a]={...c,y:l},r.add(a)):c.x!==l&&(s.points[a]={...c,x:l},r.add(a)))}),r.size&&(tt(e),Zt(e),Jt(e),r.forEach(a=>{ve(a),Mt(a)}))}function ps(e){for(let t=0;t<s.polygons.length;t++)if(s.polygons[t].lines.includes(e))return t;return null}function hd(e,t){return t?t.lines.some(n=>{const i=s.lines[n];return!!i&&i.points.includes(e)}):!1}function Ic(e){const t=s.polygons[e],n=new Set;return t.lines.forEach(i=>s.lines[i]?.points.forEach(o=>n.add(o))),Array.from(n)}function ki(e){const t=s.polygons[e]?.lines??[],n=[];t.forEach(c=>{const u=s.lines[c];if(!u)return;const f=u.points[0],p=u.points[u.points.length-1];n.push(f,p)});const o=Array.from(new Set(n)).map(c=>({idx:c,p:s.points[c]})).filter(c=>!!c.p);if(!o.length)return[];const l={x:o.reduce((c,u)=>c+u.p.x,0)/o.length,y:o.reduce((c,u)=>c+u.p.y,0)/o.length};o.sort((c,u)=>Math.atan2(c.p.y-l.y,c.p.x-l.x)-Math.atan2(u.p.y-l.y,u.p.x-l.x));const r=o.reduce((c,u,f)=>{const p=o[c].p,m=u.p;return m.y>p.y+1e-6||Math.abs(m.y-p.y)<1e-6&&m.x<p.x?f:c},0),a=[];for(let c=0;c<o.length;c++){const u=(r-c+o.length)%o.length;a.push(o[u].idx)}return a}function gd(e){if(e.lines.length<2)return e;const t=[];for(const c of e.lines){const u=s.lines[c];if(!u||u.defining_points.length<2)continue;const f=u.defining_points[0],p=u.defining_points[1];if(t.length===0)t.push(f,p);else{const m=t[t.length-1];if(f===m)t.push(p);else if(p===m)t.push(f);else{const x=t[0];p===x?t.unshift(f):f===x&&t.unshift(p)}}}const n=[];for(let c=0;c<t.length;c++)(c===0||t[c]!==t[c-1])&&n.push(t[c]);if(n.length<3||n[n.length-1]==n[0])return e;const i=(c,u)=>e.lines.some(f=>{const p=s.lines[f];if(!p||p.defining_points.length<2)return!1;const m=p.defining_points[0],x=p.defining_points[1];return m===c&&x===u||m===u&&x===c}),o=(()=>{for(const c of e.lines){const u=s.lines[c];if(u)return{...u.style}}return ut()})(),l=[];for(let c=0;c<n.length-1;c++){const u=n[c],f=n[c+1];if(!i(u,f)){const p=Ze(s,u,f,{...o});l.push(p)}}const r=n[0],a=n[n.length-1];if(!i(a,r)){const c=Ze(s,a,r,{...o});l.push(c)}return l.length===0?e:{...e,lines:[...e.lines,...l]}}function gi(e){s.angles=s.angles.filter(t=>{const n=e.get(t.leg1.line),i=e.get(t.leg2.line);return n===void 0||n<0||i===void 0||i<0?(t.label&&be(t.label),!1):(t.leg1.line=n,t.leg2.line=i,!0)})}function mi(e){const t=s.polygons.map(n=>{const i=n.lines.map(o=>e.get(o)).filter(o=>o!==void 0&&o>=0);return{object_type:"polygon",id:n.id,lines:i,construction_kind:n.construction_kind,defining_parents:[...n.defining_parents],children:[...n.children],recompute:n.recompute,on_parent_deleted:n.on_parent_deleted}}).filter(n=>n.lines.length>1);s.polygons=t.map(n=>gd(n)).filter(n=>n.lines.length>=3),jt()}function it(e){const t=s.indexById.line[e];return Number.isInteger(t)?t:null}function Le(e){const t=s.points.findIndex(n=>n.id===e);return t>=0?t:null}function md(e){const t=["point","line","circle","angle","polygon"];for(const n of t){const i=s.indexById[n][e];if(Number.isInteger(i))return{kind:n,idx:i}}return null}function xe(e){const t=md(e);return t?`${Nc[t.kind]??""}${t.idx+1}`:"?"}function Nl(e){const t=e.parent_refs.find(i=>i.kind==="line");if(!t)return null;const n=it(t.id);return n===null?null:s.lines[n]??null}function zt(e){const t=s.lines[e];if(!t)return;const n=Math.max(0,t.points.length-1),i=t.segmentStyles??[],o=t.segmentKeys??[],l=[],r=[];for(let a=0;a<n;a++){const c=Go(t.points[a],t.points[a+1]),u=o.indexOf(c),f=(u>=0?i[u]:i[Math.min(a,i.length-1)])??t.style;l.push({...f}),r.push(c)}t.segmentStyles=l,t.segmentKeys=r}function Rs(e){const t=s.lines[e];if(!t)return;const n=t.defining_points?.[0]??t.points[0],i=t.defining_points?.[1]??t.points[t.points.length-1],o=s.points[n],l=s.points[i];if(!o||!l)return;const r=qe({x:l.x-o.x,y:l.y-o.y}),a=Array.from(new Set(t.points));a.sort((c,u)=>{const f=s.points[c],p=s.points[u];if(!f||!p)return 0;const m=(f.x-o.x)*r.x+(f.y-o.y)*r.y,x=(p.x-o.x)*r.x+(p.y-o.y)*r.y;return m-x}),t.points=a,zt(e)}function Bc(){!Se||!ft||(Se.style.left=`${ft.x}px`,Se.style.top=`${ft.y}px`)}function Kl(){if(!Se||Se.style.display==="none")return;const e=Se.getBoundingClientRect(),t=e.width||Se.offsetWidth||320,n=e.height||Se.offsetHeight||240,i=Math.max(Qt.x,window.innerWidth-t-Qt.x),o=Math.max(ho,window.innerHeight-n-Qt.y);ft?ft={x:Ge(ft.x,Qt.x,i),y:Ge(ft.y,ho,o)}:ft={x:Ge(window.innerWidth-t-Qt.x,Qt.x,i),y:Ge(80,ho,o)},Bc()}function Zl(e){if(yt&&!(e!==void 0&&yt.pointerId!==e)){try{Mn?.releasePointerCapture(yt.pointerId)}catch{}Se?.classList.remove("debug-panel--dragging"),yt=null}}function Ol(){if(!Se||!cl)return;if(!li){Se.style.display="none",Se.setAttribute("aria-hidden","true"),Zl();return}Se.style.display="flex",Se.setAttribute("aria-hidden","false");const e=[],t=(c,u=", ")=>c.length?c.map(xe).join(u):"",n=c=>{const u=` <span style="color:#9ca3af;">(${c.x.toFixed(1)}, ${c.y.toFixed(1)})</span>`,f=(c.parent_refs??[]).map(d=>xe(d.id)),p=f.length?c.construction_kind==="intersection"&&f.length===2?` <span style="color:#9ca3af;">${f[0]} âˆ© ${f[1]}</span>`:c.construction_kind==="on_object"?"":` <span style="color:#9ca3af;">${f.join(", ")}</span>`:"",m=!c.construction_kind||c.construction_kind==="free"||c.construction_kind==="intersection"?"":c.construction_kind==="on_object"&&f.length>0?` <span style="color:#9ca3af;">âˆˆ ${f[0]}</span>`:` <span style="color:#9ca3af;">${c.construction_kind}</span>`,x=c.style.hidden?' <span style="color:#ef4444;">hidden</span>':"";return`${xe(c.id)}${p}${m}${u}${x}`},i=s.points.map(c=>n(c));i.length&&e.push(`<div style="margin-bottom:12px;"><div style="font-weight:600;margin-bottom:4px;">Punkty (${i.length})</div><div>${i.map(c=>`<div style="margin-bottom:3px;line-height:1.4;">${c}</div>`).join("")}</div></div>`);const o=s.lines.map(c=>{const u=Ei(c),f=lo(c),p=t(c.children);u?c.parallel.throughPoint:f&&c.perpendicular.throughPoint;const m=u?c.parallel.referenceLine:f?c.perpendicular.referenceLine:null,x=u?"âˆ¥":f?"âŠ¥":"",d=c.points.map(v=>{const k=s.points[v];if(!k)return null;const B=xe(k.id);return c.defining_points.includes(v)?`<b>${B}</b>`:B}).filter(v=>!!v),y=d.length>0?`[${d.join(", ")}]`:"",b=p?` <span style="color:#9ca3af;">â†˜ ${p}</span>`:"",h=x&&m?` ${x} ${xe(m)}`:"";return`<div style="margin-bottom:3px;line-height:1.4;">${xe(c.id)} ${y}${h}${b}</div>`});o.length&&e.push(`<div style="margin-bottom:12px;"><div style="font-weight:600;margin-bottom:4px;">Linie (${o.length})</div>${o.join("")}</div>`);const l=s.circles.map(c=>{const u=s.points[c.center],f=u?xe(u.id):`p${c.center}`,p=t(c.defining_parents),m=t(c.children),x=p||m?` <span style="color:#9ca3af;">${[p&&`âŠ‚ ${p}`,m&&`â†˜ ${m}`].filter(Boolean).join(" â€¢ ")}</span>`:"",d=Lt(c)?`[${c.defining_points.map(y=>xe(s.points[y]?.id??`p${y}`)).join(", ")}] {${f}}`:(()=>{const y=xe(s.points[c.radius_point]?.id??`p${c.radius_point}`),b=lt(c).toFixed(1);return`[${f}, ${y}] <span style="color:#9ca3af;">r=${b}</span>`})();return`<div style="margin-bottom:3px;line-height:1.4;">${xe(c.id)} ${d}${x}</div>`});l.length&&e.push(`<div style="margin-bottom:12px;"><div style="font-weight:600;margin-bottom:4px;">OkrÄ™gi (${l.length})</div>${l.join("")}</div>`);const r=s.polygons.map(c=>{const u=c.lines.map(x=>xe(s.lines[x]?.id??`l${x}`)).join(", "),f=t(c.defining_parents),p=t(c.children),m=f||p?` <span style="color:#9ca3af;">${[f&&`âŠ‚ ${f}`,p&&`â†˜ ${p}`].filter(Boolean).join(" â€¢ ")}</span>`:"";return`<div style="margin-bottom:3px;line-height:1.4;">${xe(c.id)} [${u}${m}]</div>`});r.length&&e.push(`<div style="margin-bottom:12px;"><div style="font-weight:600;margin-bottom:4px;">WielokÄ…ty (${r.length})</div>${r.join("")}</div>`);const a=s.angles.map(c=>{const u=s.lines[c.leg1.line],f=s.lines[c.leg2.line],p=t(c.defining_parents),m=t(c.children),x=p||m?` <span style="color:#9ca3af;">${[p&&`âŠ‚ ${p}`,m&&`â†˜ ${m}`].filter(Boolean).join(" â€¢ ")}</span>`:"";if(u&&f){const h=c.vertex,v=u.points[c.leg1.seg],k=u.points[c.leg1.seg+1],B=f.points[c.leg2.seg],E=f.points[c.leg2.seg+1],w=h===v?k:v,S=h===B?E:B,I=xe(s.points[w]?.id??`p${w}`),L=xe(s.points[h]?.id??`p${h}`),A=xe(s.points[S]?.id??`p${S}`);return`<div style="margin-bottom:3px;line-height:1.4;">${xe(c.id)} [${I}, ${L}, ${A}]${x}</div>`}const d=xe(s.points[c.vertex]?.id??`p${c.vertex}`),y=u?xe(u.id):`l${c.leg1.line}`,b=f?xe(f.id):`l${c.leg2.line}`;return`<div style="margin-bottom:3px;line-height:1.4;">${xe(c.id)} [${d}, ${y}, ${b}]${x}</div>`});a.length&&e.push(`<div style="margin-bottom:12px;"><div style="font-weight:600;margin-bottom:4px;">KÄ…ty (${a.length})</div>${a.join("")}</div>`),cl.innerHTML=e.length?e.join(""):'<div style="color:#9ca3af;">Brak obiektÃ³w do wyÅ›wietlenia.</div>',requestAnimationFrame(()=>Kl())}function xd(){if(!li||!g)return;g.save(),g.setTransform(Qe,0,0,Qe,0,0),g.font="12px sans-serif",g.textBaseline="middle",g.textAlign="center";const e=[],t=4,n=16,i=(o,l)=>{const r=Fs(o.x,o.y),c=g.measureText(l).width+t*2;e.push({x:r.x,y:r.y,w:c,h:n,text:l})};s.points.forEach(o=>{if(o.style.hidden&&!oe)return;const l=pc(o.style.size)/ne+Ne(10);i({x:o.x,y:o.y-l},xe(o.id))}),s.lines.forEach((o,l)=>{if(o.hidden&&!oe)return;const r=oo(l);r&&i({x:r.center.x,y:r.center.y-Ne(10)},xe(o.id))}),s.circles.forEach(o=>{if(o.hidden&&!oe)return;const l=s.points[o.center];if(!l)return;const r=lt(o);i({x:l.x,y:l.y-r-Ne(10)},xe(o.id))}),s.angles.forEach(o=>{const l=s.points[o.vertex];l&&i({x:l.x+Ne(12),y:l.y+Ne(12)},xe(o.id))}),s.polygons.forEach((o,l)=>{const r=Jr(l);r&&i(r,xe(o.id))});for(let o=0;o<5;o++)for(let l=0;l<e.length;l++)for(let r=l+1;r<e.length;r++){const a=e[l],c=e[r],u=a.x-c.x,f=a.y-c.y,p=(a.w+c.w)/2+2,m=(a.h+c.h)/2+2;if(Math.abs(u)<p&&Math.abs(f)<m){const x=p-Math.abs(u),d=m-Math.abs(f);if(x<d){const y=u>0?1:-1;a.x+=y*x*.5,c.x-=y*x*.5}else{const y=f>0?1:-1;a.y+=y*d*.5,c.y-=y*d*.5}}}e.forEach(o=>{g.save(),g.translate(o.x,o.y),g.fillStyle="rgba(17,24,39,0.8)",g.strokeStyle="rgba(255,255,255,0.9)",g.lineWidth=1,g.beginPath(),g.roundRect(-o.w/2,-o.h/2,o.w,o.h,4),g.fill(),g.stroke(),g.fillStyle="#e5e7eb",g.fillText(o.text,0,0),g.restore()}),g.restore()}function Ws(e){const t=s.points[e];if(!t||t.parent_refs.length!==2)return;const[n,i]=t.parent_refs,o=()=>ve(e),l=(r,a)=>{const c=r.style.hidden??!1;return a===c?r.style:{...r.style,hidden:a}};if(n.kind==="line"&&i.kind==="line"){const r=it(n.id),a=it(i.id);if(r===null||a===null)return;const c=s.lines[r],u=s.lines[a];if(!c||!u||c.points.length<2||u.points.length<2)return;const f=s.points[c.points[0]],p=s.points[c.points[c.points.length-1]],m=s.points[u.points[0]],x=s.points[u.points[u.points.length-1]];if(!f||!p||!m||!x)return;const d=Yl(f,p,m,x);d&&(s.points[e]={...t,x:d.x,y:d.y,style:l(t,!1)}),o();return}if(n.kind==="line"&&i.kind==="circle"||n.kind==="circle"&&i.kind==="line"){const r=n.kind==="line"?n:i,a=n.kind==="circle"?n:i,c=it(r.id),u=s.indexById.circle[a.id];if(c===null||u===void 0)return;const f=s.lines[c],p=s.circles[u];if(!f||!p||f.points.length<2)return;const m=s.points[f.points[0]],x=s.points[f.points[f.points.length-1]],d=s.points[p.center],y=lt(p);if(!m||!x||!d||y<=0)return;const b=Sc(m,x,d,y,!1);if(!b.length){const v=wi({x:t.x,y:t.y},m,x);s.points[e]={...t,...v,style:l(t,!0)},o();return}b.sort((v,k)=>Math.hypot(v.x-t.x,v.y-t.y)-Math.hypot(k.x-t.x,k.y-t.y));const h=b[0];s.points[e]={...t,x:h.x,y:h.y,style:l(t,!1)},o();return}if(n.kind==="circle"&&i.kind==="circle"){const r=s.indexById.circle[n.id],a=s.indexById.circle[i.id];if(r===void 0||a===void 0)return;const c=s.circles[r],u=s.circles[a];if(!c||!u)return;const f=s.points[c.center],p=s.points[u.center],m=lt(c),x=lt(u);if(!f||!p||m<=0||x<=0)return;const d=Ul(f,m,p,x),y=k=>{if(k.parent_refs.length!==2)return!1;const B=k.parent_refs.filter(w=>w.kind==="circle");if(B.length!==2)return!1;const E=B.map(w=>w.id);return E.includes(n.id)&&E.includes(i.id)},b=s.points.map((k,B)=>B!==e&&k&&k.construction_kind==="intersection"&&y(k)?B:null).filter(k=>k!==null),h=[e,...b].filter((k,B,E)=>E.indexOf(k)===B);if(!d.length){h.forEach(k=>{const B=s.points[k];B&&(s.points[k]={...B,style:l(B,!0)})}),o();return}if(d.length===1){const k=d[0];h.forEach(B=>{const E=s.points[B];E&&(s.points[B]={...E,x:k.x,y:k.y,style:l(E,!1)})}),o();return}if(h.length>=2){const k=h[0],B=h[1],E=s.points[k],w=s.points[B];if(E&&w){const S=(D,N)=>Math.hypot(D.x-N.x,D.y-N.y),I=S(E,d[0]),L=S(E,d[1]),A=S(w,d[0]),R=S(w,d[1]);(I+R<=L+A?[{idx:k,target:E,pos:d[0]},{idx:B,target:w,pos:d[1]}]:[{idx:k,target:E,pos:d[1]},{idx:B,target:w,pos:d[0]}]).forEach(({idx:D,target:N,pos:O})=>{s.points[D]={...N,x:O.x,y:O.y,style:l(N,!1)}}),h.length>2&&h.slice(2).forEach(D=>{const N=s.points[D];N&&(s.points[D]={...N,style:l(N,!0)})}),o();return}}d.sort((k,B)=>Math.hypot(k.x-t.x,k.y-t.y)-Math.hypot(B.x-t.x,B.y-t.y));const v=d[0];s.points[e]={...t,x:v.x,y:v.y,style:l(t,!1)},o();return}o()}function tt(e){const t=s.lines[e];if(!t)return;const n=t.id;s.points.forEach((i,o)=>{const l=s.points[o];l&&l.parent_refs.some(r=>r.kind==="line"&&r.id===n)&&l.construction_kind==="intersection"&&Ws(o)}),Ya(e)}function Zn(e){const t=s.circles[e];if(!t)return;const n=t.id;s.points.forEach((i,o)=>{if(i&&i.parent_refs.some(l=>l.kind==="circle"&&l.id===n))if(i.construction_kind==="intersection")Ws(o);else{const l=xt(o,Dl(o,{x:i.x,y:i.y}));s.points[o]={...i,...l},ve(o)}})}function bd(e){for(let t=s.lines.length-1;t>=0;t--){const n=Lc(t);if(!n)continue;const i=Ne(Or/2);if(Math.abs(e.x-n.x)<=i&&Math.abs(e.y-n.y)<=i)return t}return null}ha();ga();
